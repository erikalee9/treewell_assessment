---
title: "snowcam_treewell_data"
output: html_document
date: "2024-12-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse) # Package with dplyr, tibble, readr, and others to help clean coding
library(knitr) #Makes nice tables
library(kableExtra) #Makes even nicer tables
library(lubridate) #Makes working with dates easier
library(tidyr)
library(readxl)#Makes multiple simultaneous models easier
library(plotly)
library(rstatix)
library(ggpubr)
library(ggpmisc)

setwd("/Volumes/wcnr-network/Research/Kampf/Private/field_data")
```

```{r}
#clear prior environment
rm(list = ls())
```

Loading in Data

```{r}
snowcam_105E_transb_tw_data_edited <- read_csv("nsf/treewell_data/snowcam_treewell_data/105E_transb_tree_well_diams_edited.csv")

#this has original data with different tree diameters per date
snowcam_105E_transb_tw_data_full <- read_csv("nsf/treewell_data/snowcam_treewell_data/105E_transb_tree_well_diams.csv")

snowcam_LP_highmort_persb_tw_data_edited <- read_csv("nsf/treewell_data/snowcam_treewell_data/LP_highmort_persb_tree_well_diams_V2.csv")

#don't have this dataset done yet, so not ready to be loaded
snowcam_LP_lowmort_persb_tw_data_edited <- read_csv("nsf/treewell_data/snowcam_treewell_data/LP_lowmort_persb_tree_well_diams_V2.csv")
```

Data Wrangling

```{r}
#this is the version that has only one diameter per tree id
snowcam_transb_tw_edited <- snowcam_105E_transb_tw_data %>%
  mutate(date = mdy(date)) %>%
  mutate(well_diam_cm = as.numeric(well_diam_cm), tree_diam_cm = as.numeric(tree_diam_cm)) %>%  # Convert to numeric
  mutate(well_diam_cm = replace_na(well_diam_cm, 0)) %>%
  mutate(tree_diam_size = case_when(
    tree_diam_cm >= 20 ~ "large",
    tree_diam_cm >= 10 & tree_diam_cm < 20 ~ "medium",
    tree_diam_cm < 10 ~ "small",
    TRUE ~ NA_character_  # Handles cases where tree_diam_cm is NA
  ))
```

```{r}
#this is the version that is applying variable tree diameters per tree
snowcam_transb_tw_full <- snowcam_105E_transb_tw_data_full %>%
  mutate(date = mdy(date)) %>%
  mutate(well_diam_cm = as.numeric(well_diam_cm), tree_diam_cm = as.numeric(tree_diam_cm)) %>%  # Convert to numeric
  mutate(well_diam_cm = replace_na(well_diam_cm, 0)) %>%
  #making a column for tree diameter size - large = >20, medium = 10-20, small = <10
  mutate(tree_diam_size = case_when(
    tree_diam_cm >= 20 ~ "large",
    tree_diam_cm >= 10 & tree_diam_cm < 20 ~ "medium",
    tree_diam_cm < 10 ~ "small",
    TRUE ~ NA_character_  # Handles cases where tree_diam_cm is NA
  ))
```

### Data Exploration

Full Dataset with tree diams per date

```{r}
#making a dataframe that only has data for when there is snow at all trees
transb_snowon_treewell_data <- snowcam_transb_tw_full %>%
  filter(date <= as.Date("2024-04-23"))

#creating dataframes by tree_id
transb_snowon_treeid1_data <- snowcam_transb_tw_full %>%
  filter(tree_id == "tree_1") %>%
  filter(date <= as.Date("2024-04-23"))

transb_snowon_treeid2_data <- snowcam_transb_tw_full %>%
  filter(tree_id == "tree_2") %>%
  filter(date <= as.Date("2024-04-23"))

transb_snowon_treeid3_data <- snowcam_transb_tw_full %>%
  filter(tree_id == "tree_3") %>%
  filter(date <= as.Date("2024-04-23"))

transb_snowon_treeid4_data <- snowcam_transb_tw_full %>%
  filter(tree_id == "tree_4") %>%
  filter(date <= as.Date("2024-04-23"))
```

```{r}
lm_model <- lm(well_diam_cm ~ tree_diam_cm, data = transb_snowon_treewell_data)

r_squared <- summary(lm_model)$r.squared
```

```{r}
lm_model_treeid1 <- lm(well_diam_cm ~ tree_diam_cm, data = transb_snowon_treeid1_data)

r_squared_treeid1 <- summary(lm_model_treeid1)$r.squared
```

```{r}
lm_model_treeid2 <- lm(well_diam_cm ~ tree_diam_cm, data = transb_snowon_treeid2_data)

r_squared_treeid2 <- summary(lm_model_treeid2)$r.squared
```

```{r}
lm_model_treeid3 <- lm(well_diam_cm ~ tree_diam_cm, data = transb_snowon_treeid3_data)

r_squared_treeid3 <- summary(lm_model_treeid3)$r.squared
```

```{r}
lm_model_treeid4 <- lm(well_diam_cm ~ tree_diam_cm, data = transb_snowon_treeid4_data)

r_squared_treeid4 <- summary(lm_model_treeid4)$r.squared
```

```{r}
#scatterplot by tree diameter and well diameter

trans_tree_well_full_scatterplot <- ggplot(transb_snowon_treewell_data, aes(x = tree_diam_cm, y = well_diam_cm)) +
  geom_point(aes(color = tree_id), size = 3, alpha = 0.7) +  # Color by tree_id
  geom_smooth(method = "lm", color = "grey", se = TRUE) +  # Best-fit line with shaded CI
  annotate("text", x = 25, y = 10, label = paste("R² = ", round(r_squared, 2)), size = 5, color = "black") +# Add R² value
  #facet_wrap(~tree_diam_size) +
  labs(
    title = "Trans Burned Tree Diameter vs Well Diameter",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_minimal() +
  scale_color_viridis_d()  # Optionally, use a color palette for the tree_id

# Display the plot
trans_tree_well_full_scatterplot

```

Scatter plot by individual tree id - to see if R\^2 is better that way

```{r}
#treeid_1
trans_tree_well_treeid1_scatterplot <- ggplot(transb_snowon_treeid1_data) +
  geom_point(aes(x = tree_diam_cm, y = well_diam_cm, color = tree_id), color = "purple4", size = 3, alpha = 0.7) +  # Color by tree_id
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +  # Best-fit line with shaded CI
  annotate("text", x = 25, y = 30, label = paste("R² = ", round(r_squared_treeid1, 2)), size = 5, color = "black") +# Add R² value
  #facet_wrap(~tree_diam_size) +
  labs(
    title = "Tree id 1",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() +
  scale_x_continuous(
    limits = c(19, 27))

# Display the plot
trans_tree_well_treeid1_scatterplot
```

```{r}
#treeid_2
trans_tree_well_treeid2_scatterplot <- ggplot(transb_snowon_treeid2_data, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id), color = "gold", size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +  # Best-fit line with shaded CI
  annotate("text", x = 12, y = 15, label = paste("R² = ", round(r_squared_treeid2, 2)), size = 5, color = "black") +# Add R² value
  #facet_wrap(~tree_diam_size) +
  labs(
    title = "Tree id 1",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() +
  scale_x_continuous(
    limits = c(10, 15))

# Display the plot
trans_tree_well_treeid2_scatterplot
```

```{r}
trans_tree_well_treeid3_scatterplot <- ggplot(transb_snowon_treeid3_data, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id), color = "blue2", size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +  # Best-fit line with shaded CI
  annotate("text", x = 10, y = 8, label = paste("R² = ", round(r_squared_treeid3, 2)), size = 5, color = "black") +# Add R² value
  #facet_wrap(~tree_diam_size) +
  labs(
    title = "Tree id 3",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() +
  scale_x_continuous(limits = c(7, 11))

# Display the plot
trans_tree_well_treeid3_scatterplot
```

```{r}
trans_tree_well_treeid4_scatterplot <- ggplot(transb_snowon_treeid4_data, aes(x = tree_diam_cm, y = well_diam_cm)) +
  geom_point(aes(color = tree_id), color = "green4", size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +  # Best-fit line with shaded CI
  annotate("text", x = 20, y = 20, label = paste("R² = ", round(r_squared_treeid4, 2)), size = 5, color = "black") +  # Add R² value
  labs(
    title = "Tree id 4",  # Corrected the title to match the tree id
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() + 
  scale_x_continuous(limits = c(14, 22)) +
  scale_y_continuous() # Correctly added '+' before this line

# Display the plot
trans_tree_well_treeid4_scatterplot
```

```{r}
#patching all the tree_id plots together
transb_comb_bytreeid_scatterplot <- ggarrange(trans_tree_well_treeid1_scatterplot, trans_tree_well_treeid2_scatterplot, trans_tree_well_treeid3_scatterplot, trans_tree_well_treeid4_scatterplot, nrow = 2, ncol = 2)

transb_comb_bytreeid_scatterplot
```

Set tree diams by tree id - this doesn't make sense to do, because all the tree diams are the same per tree_id, which doesn't give me a scatterplot

```{r}
transb_snowon_treewell_edited_data <- snowcam_transb_tw_edited %>%
  filter(date <= as.Date("2024-04-23")
```

```{r}
trans_tree_well_edited_lineplot <- ggplot(transb_snowon_treewell_edited_data) +
  geom_line(aes(x = date, y = well_diam_cm, color = tree_id), linewidth = 0.8, alpha = 0.7) +  # Color by tree_id
  labs(
    title = "Trans Burned Treewell Developement",
    x = "Date",
    y = "Well Diameter (cm)"
  ) +
  theme_minimal() +
  scale_color_viridis_d()  # Optionally, use a color palette for the tree_id

# Display the plot
trans_tree_well_edited_lineplot

```

## V2 Data - processed by me

Download Data

```{r}
transb_snowcam_treewell_data = read_csv("nsf/treewell_data/snowcam_data/105E_transb_tree_well_diams_V2.csv")

persb_highmort_snowcam_treewell_data = read_csv("nsf/treewell_data/snowcam_data/LP_highmort_persb_tree_well_diams_V2.csv")

persb_lowmort_snowcam_treewell_data = read_csv("nsf/treewell_data/snowcam_data/LP_lowmort_persb_tree_well_diams_V2.csv")
```

```{r}
#snowcamera snow depth data
transb_snowcam_depth_data = read_csv("nsf/camera_snowdepths/2024_105E_transb_snowdepths.csv")

persb_highmort_snowcam_depth_data = read_csv("nsf/camera_snowdepths/2024_persb_lp_highmort_east_snowdepths.csv")

persb_lowmort_snowcam_depth_data = read_csv("nsf/camera_snowdepths/2024_persb_lp_lowmort_snowdepths.csv")
```

### Data Wrangling

```{r}
#edited snowcam data to match the timeline of the well data
transb_snowcam_depth_edited <- transb_snowcam_depth_data %>%
  filter(date >= "2024-04-01" & date <= "2024-05-09") %>%
  rename(burn_status = "mortality") %>%
  select(date, burn_status, zone, "maximum_depth(cm)", treewell_developed, conditions) %>%
  mutate(zone = "TSZ") %>%
  rename(max_depth_cm = "maximum_depth(cm)")

persb_highmort_snowcam_depth_edited <- persb_highmort_snowcam_depth_data %>%
  filter(date >= "2024-04-15" & date <= "2024-05-18") %>%
  select(date, mortality, burn_status, zone, max_depth_cm, treewell_developement, conditions) %>%
  mutate(zone = "PSZ") 

persb_lowmort_snowcam_depth_edited <- persb_lowmort_snowcam_depth_data %>%
  filter(date >= "2024-04-15" & date <= "2024-05-31") %>%
  select(date, mortality, burn_status, zone, max_depth_cm, conditions) %>%
  mutate(zone = "PSZ") 
```

```{r}
#snowcam treewell data edited
transb_snowcam_treewell_data_edited <- transb_snowcam_treewell_data %>%
  mutate(date = as.Date(date, format = "%m/%d/%y")) %>%
  mutate(mortality = "mixed") %>%
  select(date, zone, burn_status, mortality, tree_id, tree_diam_cm, well_diam_cm)

persb_highmort_snowcam_treewell_data_edited <- persb_highmort_snowcam_treewell_data %>%
  mutate(date = as.Date(date, format = "%m/%d/%y")) %>%
  select(date, zone, burn_status, mortality, tree_id, tree_diam_cm, well_diam_cm)

persb_lowmort_snowcam_treewell_data_edited <- persb_lowmort_snowcam_treewell_data %>%
  mutate(date = as.Date(date, format = "%m/%d/%y")) %>%
  select(date, zone, burn_status, mortality, everything()) %>%
  select(date, zone, burn_status, mortality, tree_id, tree_diam_cm, well_diam_cm)
```

```{r}
#combined treewell dataframe 
full_snowcam_treewell_data <- rbind(persb_highmort_snowcam_treewell_data_edited, persb_lowmort_snowcam_treewell_data_edited, transb_snowcam_treewell_data_edited)
```

### Data Exploration

```{r}
transb_wx_15min_r <- read_csv('nsf/trans_burned/trans_burned_wx_15min_r.csv') %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                               datetime = with_tz(datetime, tz = 'MST'))

transub_wx_15min_r <- read_csv('nsf/trans_unburned/trans_unburned_wx_15min_r.csv') %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                               datetime = with_tz(datetime, tz = 'MST'))

persb_wx_hourly_r <- read_csv('nsf/pers_burned/pers_burned_wx_hourly_r.csv') %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                               datetime = with_tz(datetime, tz = 'MST'))

#persub_wx_15min_r <- read_csv('nsf/pers_unburned/pers_unburned_wx_15min_r.csv') %>%
  #mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                       #        datetime = with_tz(datetime, tz = 'MST'))

#use hourly unburned and burned for PSZ
persub_wx_hourly_r <- read_csv('nsf/pers_unburned/pers_unburned_wx_hourly_r.csv') %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                               datetime = with_tz(datetime, tz = 'MST'))
  
p_b_solar_times <- read_csv("nsf/treetemp_data/p_b_solar_times.csv") %>%
  mutate(
    sunrise = as.POSIXct(sunrise, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"), # Assuming data is in UTC
    sunset = as.POSIXct(sunset, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"),
    sunrise = with_tz(sunrise, "MST"),  # Convert to MST timezone
    sunset = with_tz(sunset, "MST")     # Convert to MST timezone
  )
```

```{r}
#filtered weather data to the datetime range that we need and added phase and NR_Avg_calcs
filtered_transb_wx_15min <- transb_wx_15min_r %>%
  mutate(day = as.Date.POSIXct(datetime, tz = "MST"),
    month = as.numeric(format(datetime, "%m")),
    datetime = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime >= as.POSIXct("2024-02-02 00:00:00", tz = "MST") & 
         datetime < as.POSIXct("2024-07-01 00:00:00", tz = "MST")) %>%
  inner_join(p_b_solar_times, by = "day") %>%
  #creating a phase column that parses by daily sunrise/sunset times
  mutate(
    phase = case_when(
      datetime >= sunrise & datetime < sunset ~ "day",
      datetime < sunrise ~ "night",
      datetime >= sunset ~ "night",
      TRUE ~ NA_character_)) %>%
  mutate(zone = "TSZ", burn_status = "burned") %>%
  filter(!is.nan(SWin_Avg)) %>%
  #adding in my own calculated NR_Avg column
  mutate(SnowDepth_cm = (SnowDepth_m*100)) %>%
  mutate(NR_Avg_new = (SWin_Avg - SWout_Avg) + (LWin_Avg - LWout_Avg)) %>%
  select(datetime, day, month, phase, zone, burn_status, NR_Avg_new, SnowDepth_cm, everything())
```

```{r}
filtered_transub_wx_15min <- transub_wx_15min_r %>%
  mutate(day = as.Date.POSIXct(datetime, tz = "MST"),
    month = as.numeric(format(datetime, "%m")),
    datetime = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime >= as.POSIXct("2024-02-02 00:00:00", tz = "MST") & 
         datetime < as.POSIXct("2024-07-01 00:00:00", tz = "MST")) %>%
  inner_join(p_b_solar_times, by = "day") %>%
  #creating a phase column that parses by daily sunrise/sunset times
  mutate(
    phase = case_when(
      datetime >= sunrise & datetime < sunset ~ "day",
      datetime < sunrise ~ "night",
      datetime >= sunset ~ "night",
      TRUE ~ NA_character_)) %>%
  mutate(zone = "TSZ", burn_status = "unburned") %>%
  #adding in my own calculated NR_Avg column
  #adding in my own calculated NR_Avg column
  mutate(SnowDepth_cm = (SnowDepth_m*100)) %>%
  mutate(NR_Avg_new = (SWin_Avg - SWout_Avg) + (LWin_Avg - LWout_Avg)) %>%
  select(datetime, day, month, phase, zone, burn_status, NR_Avg_new, everything())
```

```{r}
filtered_persub_wx_hourly <- persub_wx_hourly_r %>%
  mutate(day = as.Date.POSIXct(datetime, tz = "MST"),
    month = as.numeric(format(datetime, "%m")),
    datetime = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime >= as.POSIXct("2024-02-02 00:00:00", tz = "MST") & 
         datetime < as.POSIXct("2024-07-01 00:00:00", tz = "MST")) %>%
  inner_join(p_b_solar_times, by = "day") %>%
  #creating a phase column that parses by daily sunrise/sunset times
  mutate(
    phase = case_when(
      datetime >= sunrise & datetime < sunset ~ "day",
      datetime < sunrise ~ "night",
      datetime >= sunset ~ "night",
      TRUE ~ NA_character_)) %>%
  mutate(zone = "PSZ", burn_status = "unburned") %>%
  #adding in my own calculated NR_Avg column
  mutate(SnowDepth_cm = (SnowDepth_m*100)) %>%
  #adding in my own calculated NR_Avg column
  mutate(NR_Avg_new = (SWin_Avg - SWout_Avg) + (LWin_Avg - LWout_Avg)) %>%
  select(datetime, day, month, phase, zone, burn_status, NR_Avg_new, everything())
```

```{r}
filtered_persb_wx_hourly <- persb_wx_hourly_r %>%
  mutate(day = as.Date.POSIXct(datetime, tz = "MST"),
    month = as.numeric(format(datetime, "%m")),
    datetime = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime >= as.POSIXct("2024-02-02 00:00:00", tz = "MST") & 
         datetime < as.POSIXct("2024-07-01 00:00:00", tz = "MST")) %>%
  inner_join(p_b_solar_times, by = "day") %>%
  #creating a phase column that parses by daily sunrise/sunset times
  mutate(
    phase = case_when(
      datetime >= sunrise & datetime < sunset ~ "day",
      datetime < sunrise ~ "night",
      datetime >= sunset ~ "night",
      TRUE ~ NA_character_)) %>%
  mutate(zone = "PSZ", burn_status = "burned") %>%
  #adding in my own calculated NR_Avg column
  mutate(SnowDepth_cm = (SnowDepth_m*100)) %>%
 #adding in my own calculated NR_Avg column
  mutate(NR_Avg_new = (SWin_Avg - SWout_Avg) + (LWin_Avg - LWout_Avg)) %>%
  select(datetime, day, month, phase, zone, burn_status, NR_Avg_new, everything())
```

```{r}
mean_dt_persb_wx <- filtered_persb_wx_hourly %>%
  filter(phase == "day") %>%
  group_by(day, month, phase, zone, burn_status) %>%
  summarize(SnowDepth_m = mean(SnowDepth_m), AirTC_Avg = mean(AirTC_Avg), SWin_Avg = mean(SWin_Avg), SWout_Avg = mean(SWout_Avg), LWin_Avg = mean(LWin_Avg), LWout_Avg = mean(LWout_Avg), NR_Avg_wperm2 = mean(NR_Avg_new)) %>%
  #creating a MJ/day mean value column for NR
  mutate(NR_Avg_MJperd = (NR_Avg_wperm2 * 86400)/1000000) %>%
  filter(day >= "2024-04-15" & day <= "2024-05-31")
```

```{r}
mean_dt_transb_wx <- filtered_transb_wx_15min %>%
  filter(phase == "day") %>%
  group_by(day, month, phase, zone, burn_status) %>%
  summarize(SnowDepth_m = mean(SnowDepth_m), AirTC_Avg = mean(AirTC_Avg), SWin_Avg = mean(SWin_Avg), SWout_Avg = mean(SWout_Avg), LWin_Avg = mean(LWin_Avg), LWout_Avg = mean(LWout_Avg), NR_Avg_wperm2 = mean(NR_Avg_new)) %>%
  #creating a MJ/day mean value column for NR
  mutate(NR_Avg_MJperd = (NR_Avg_wperm2 * 86400)/1000000) %>%
  filter(day >= "2024-04-01" & day <= "2024-05-09")
```

#### Line Plots

```{r}
#setting constants for tree_id colors and burn status linetypes
treeid_colors <- c(
  "tree_1" = "#1B7837",
  "tree_2" = "#D95F02",
  "tree_3" = "#2166AC",
  "tree_4" = "grey23"
)

burnstatus_linetype <- c("GB" = "solid", "DB" = "dashed")
```

```{r}
#data frame filtering out any well values of zero
transb_snowcam_treewell_data_nozeros <- transb_snowcam_treewell_data_edited %>%
  filter(well_diam_cm != 0) %>%
  mutate(burn_status = case_when(
    tree_id == "tree_4" ~ "DB",
    TRUE ~ burn_status))
```

```{r}
#plot by date vs treewell
##transitional
transb_tree_well_lineplot <- ggplot() + 
  # Net radiation data
  geom_col(data = mean_dt_transb_wx, 
           aes(x = day, y = NR_Avg_MJperd * 10, fill = "net radiation"), # Adjust scaling for clarity
           position = "stack", alpha = 0.6) +
   # Bar plot for snow depth with custom legend
  geom_bar(data = transb_snowcam_depth_edited, 
           aes(x = date, y = max_depth_cm, fill = "daily max snow depth (cm)"),
           stat = "identity", color = NA, alpha = 0.3) + 
  # Combine data and map tree_id to color
  geom_line(data = transb_snowcam_treewell_data_nozeros, 
            aes(x = date, y = well_diam_cm, color = tree_id, linetype = burn_status), 
            linewidth = 0.6) +
  labs(
    title = "b) TSZ",
    x = "Date",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() +
  scale_color_manual(
    name = "tree id",
    values = c("tree_1" = "#1B7837", "tree_2" = "#D95F02", "tree_3" = "#2166AC", "tree_4" = "grey23")
  ) +
  scale_linetype_manual(
    name = "burn status", 
    values = c("DB" = "dashed", "GB" = "solid"),
    labels = c("DB" = "DB", "GB" = "GB")
  ) +
  scale_fill_manual(
    name = "Radiation & Snow Depth", 
    values = c("net radiation" = "orange", "daily max snow depth (cm)" = "grey32")
  ) +
  scale_y_continuous(
    name = "Well Diameter & Snow Depth (cm)", 
    sec.axis = sec_axis(~ . / 10, name = "Net Radiation (MJ/day)")
  )

# Display the plot
transb_tree_well_lineplot
```

```{r}
persb_highmort_snowcam_treewell_data_nozeros <- persb_highmort_snowcam_treewell_data_edited %>%
  filter(well_diam_cm != 0)
```

```{r}
##persb high mort
## dont use this plot!
persb_highmort_tree_well_lineplot <- ggplot(persb_highmort_snowcam_treewell_data_nozeros) +
  geom_line(aes(x = date, y = well_diam_cm, color = tree_id, linetype = burn_status), linewidth = 0.6) +
   # Bar plot for snow depth with custom legend
  geom_bar(data = persb_highmort_snowcam_depth_edited, 
           aes(x = date, y = max_depth_cm, fill = "daily max snow depth (cm)"),
           stat = "identity", color = NA, alpha = 0.3) +
  labs(
    title = "Plot 2: Pers Burned High Mort",
    x = "Date",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) +
  scale_linetype_manual(values = burnstatus_linetype) + 
  scale_fill_manual(name = "columns", values = c("daily max snow depth (cm)" = "grey32"))

# Display the plot
persb_highmort_tree_well_lineplot
```

```{r}
persb_lowmort_snowcam_treewell_data_nozeros <- persb_lowmort_snowcam_treewell_data_edited %>%
  filter(well_diam_cm != 0)
```

```{r}
persb_highmort_db_tree <- persb_highmort_snowcam_treewell_data_nozeros %>%
  filter(burn_status == "DB")
```

```{r}
persb_lowmort_snowcam_treewell_V2 <- rbind(persb_lowmort_snowcam_treewell_data_nozeros, persb_highmort_db_tree)
```

```{r}
##persb low mort
#this plot has the lowmort GB data and high mort DB data combined... 
persb_lowmort_tree_well_lineplot <- ggplot() + 
  # Net radiation data
  geom_col(data = mean_dt_persb_wx, 
           aes(x = day, y = NR_Avg_MJperd * 10, fill = "net radiation"), # Adjust scaling for clarity
           position = "stack", alpha = 0.6) +
   # Bar plot for snow depth with custom legend
  geom_bar(data = persb_lowmort_snowcam_depth_edited, 
           aes(x = date, y = max_depth_cm, fill = "daily max snow depth (cm)"),
           stat = "identity", color = NA, alpha = 0.3) + 
  geom_line(data = persb_lowmort_snowcam_treewell_V2, 
            aes(x = date, y = well_diam_cm, color = tree_id, linetype = burn_status), 
            linewidth = 0.6) +
  labs(
    title = "a) PSZ",
    x = "Date",
    y = "Well Diameter & Snow Depth (cm)",
    fill = "Legend"
  ) +
  theme_bw() +
  scale_color_manual(
    name = "Tree ID",
    values = c("tree_1" = "#1B7837", "tree_2" = "#D95F02", "tree_3" = "#2166AC", "tree_4" = "grey23")
  ) +
  scale_linetype_manual(
    name = "Burn Status", 
    values = c("DB" = "dashed", "GB" = "solid"),
    labels = c("DB" = "DB", "GB" = "GB")
  ) +
  scale_fill_manual(
    name = "Radiation & Snow Depth", 
    values = c("net radiation" = "orange", "daily max snow depth (cm)" = "grey32")
  ) +
  scale_y_continuous(
    name = "Well Diameter & Snow Depth (cm)", 
    sec.axis = sec_axis(~ . / 10, name = "Net Radiation (MJ/day)")
  )

# Display the plot
persb_lowmort_tree_well_lineplot
```

```{r}
#combined dataframes
combined_treewell_lineplots <- ggarrange(persb_lowmort_tree_well_lineplot, transb_tree_well_lineplot, nrow = 2, ncol = 1, common.legend = TRUE, legend = "right")

combined_treewell_lineplots
```

\*\* this data shows a pattern during the ablation periods of these three different sites, but those time periods are different at each site

-   Once the snow is mostly all melted, the well data is more sporadic, not as easy to see a signal between the date and well diameter

-   Correlation between snow depth and well depth and date for sure. As snow depth decreases, tree well depth increases.

\*\* Consider plotting net Radiation with these as well?

-   might make the most sense to ONLY show the peak ablation periods, and a bit of time before hand, since once the snow is mostly gone the signal gets weird.

#### Scatterplots

##### Tree vs Well Diameters

```{r}
#making dataframes that just have one tree ID per zone, so that we can do an R^2 assessment
transb_snowcam_treewell_data_id1 <- transb_snowcam_treewell_data_nozeros %>%
  filter(tree_id== "tree_1")

transb_snowcam_treewell_data_id2 <- transb_snowcam_treewell_data_nozeros %>%
  filter(tree_id== "tree_2")

transb_snowcam_treewell_data_id3 <- transb_snowcam_treewell_data_nozeros %>%
  filter(tree_id== "tree_3")

transb_snowcam_treewell_data_id4 <- transb_snowcam_treewell_data_nozeros %>%
  filter(tree_id== "tree_4")
```

```{r}
#treeid_1
trans_tree_well_id1_scatterplot_V2 <- ggplot(transb_snowcam_treewell_data_id1, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +  # Best-fit line with shaded CI
  #annotate("text", x = 12, y = 15, label = paste("R² = ", round(r_squared_treeid2, 2)), size = 5, color = "black") +# Add R² value
  #facet_wrap(~tree_diam_size) +
  labs(
    title = "Tree id 1",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw()
  #scale_x_continuous(
    #limits = c(10, 15))

# Display the plot
trans_tree_well_id1_scatterplot_V2
```

```{r}
#treeid_2
trans_tree_well_id2_scatterplot_V2 <- ggplot(transb_snowcam_treewell_data_id2, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +  # Best-fit line with shaded CI
  #annotate("text", x = 12, y = 15, label = paste("R² = ", round(r_squared_treeid2, 2)), size = 5, color = "black") +# Add R² value
  #facet_wrap(~tree_diam_size) +
  labs(
    title = "Tree id 2",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw()
  #scale_x_continuous(
    #limits = c(10, 15))

# Display the plot
trans_tree_well_id2_scatterplot_V2
```

```{r}
trans_tree_well_id3_scatterplot_V2 <- ggplot(transb_snowcam_treewell_data_id3, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +  # Best-fit line with shaded CI
  #annotate("text", x = 12, y = 15, label = paste("R² = ", round(r_squared_treeid2, 2)), size = 5, color = "black") +# Add R² value
  #facet_wrap(~tree_diam_size) +
  labs(
    title = "Tree id 3",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw()
  #scale_x_continuous(
    #limits = c(10, 15))

# Display the plot
trans_tree_well_id3_scatterplot_V2
```

```{r}
trans_tree_well_id4_scatterplot_V2 <- ggplot(transb_snowcam_treewell_data_id4, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +
  labs(
    title = "Tree id 4",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw()

# Display the plot
trans_tree_well_id4_scatterplot_V2
```

```{r}
#all points - trans burned 
trans_tree_well_alltrees_scatterplot <- ggplot(transb_snowcam_treewell_data_nozeros, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id, shape = burn_status), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +
  labs(
    title = "Plot 1: Trans Burned",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() + 
  scale_color_manual(values = treeid_colors) + 
  scale_shape_manual(values = c("DB" = 15, "GB" = 16))  # Star = 8, Dot = 16

trans_tree_well_alltrees_scatterplot
```

```{r}
#all points - pers burned high mort
persb_highmort_tree_well_alltrees_scatterplot <- ggplot(persb_highmort_snowcam_treewell_data_nozeros, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id, shape = burn_status), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +
  labs(
    title = "Plot 2: Pers Burned High Mort",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() + 
  scale_color_manual(values = treeid_colors) + 
  scale_shape_manual(values = c("DB" = 15, "GB" = 16))  # Star = 8, Dot = 16

persb_highmort_tree_well_alltrees_scatterplot
```

```{r}
#all points - pers burned low mort
persb_lowmort_tree_well_alltrees_scatterplot <- ggplot(persb_lowmort_snowcam_treewell_data_nozeros, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id, shape = burn_status), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +
  #facet_wrap(~date) +
  labs(
    title = "Plot 3: Pers Burned Low Mort",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() + 
  scale_color_manual(values = treeid_colors) + 
  scale_shape_manual(values = c("DB" = 15, "GB" = 16))  # Star = 8, Dot = 16

persb_lowmort_tree_well_alltrees_scatterplot
```

```{r}
comb_allzones_scatterplots <- ggarrange(trans_tree_well_alltrees_scatterplot, persb_highmort_tree_well_alltrees_scatterplot, persb_lowmort_tree_well_alltrees_scatterplot, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right")

comb_allzones_scatterplots
```

Attempting to just do a short timeframe and see if there is a linear correlation then

```{r}
transb_april_1to5_data <- transb_snowcam_treewell_data_nozeros %>%
  filter(date >= "2024-04-01" & date <= "2024-04-05")
  
trans_tree_well_1to5_scatterplot <- ggplot(transb_april_1to5_data, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +
  labs(
    title = "Trans Burned: April 1-5th, 2024",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw()

# Display the plot
trans_tree_well_1to5_scatterplot
```

```{r}
transb_april_6to10_data <- transb_snowcam_treewell_data_nozeros %>%
  filter(date >= "2024-04-06" & date <= "2024-04-10")
  
trans_tree_well_6to10_scatterplot <- ggplot(transb_april_6to10_data, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +
  labs(
    title = "Trans Burned: April 6-10th, 2024",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw()

# Display the plot
trans_tree_well_6to10_scatterplot
```

```{r}
transb_april_11to15_data <- transb_snowcam_treewell_data_nozeros %>%
  filter(date >= "2024-04-11" & date <= "2024-04-15")

# Fit linear model
lm_model_transb_4_11to15 <- lm(well_diam_cm ~ tree_diam_cm, data = transb_april_11to15_data)

# Extract R-squared value
r_squared_transb_4_11to15 <- summary(lm_model)$r.squared
  
trans_tree_well_11to15_scatterplot <- ggplot(transb_april_11to15_data, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +
  labs(
    title = "Trans Burned: April 11-15th, 2024",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() + 
  # Annotate with R-squared value
  annotate("text", x = max(transb_april_11to15_data$tree_diam_cm) * 0.7, 
           y = max(transb_april_11to15_data$well_diam_cm) * 0.9, 
           label = paste("R² = ", round(r_squared, 2)), 
           size = 5, 
           color = "black")

# Display the plot
trans_tree_well_11to15_scatterplot
```

##### Peak Ablation Period Scatter Plots, facet wrapped by day

```{r}
#ablation period ONLY scatterplot

transb_peakablation_data <- transb_snowcam_treewell_data_nozeros %>%
  filter(date >= "2024-04-06" & date <= "2024-04-25")

trans_tree_well_peakablation_scatterplot_bydate <- ggplot(transb_peakablation_well_snowdepth_data, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id, shape = burn_status), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +
  facet_wrap(~date, ncol = 5) +
  labs(
    title = "b) TSZ",
    x = "Tree Diameter (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors,
    name = "Tree ID",               # Set the legend title for color
    labels = c("DB" = "DB", "GB" = "GB") # Set custom labels for color
  ) +
  scale_shape_manual(values = c("DB" = 15, "GB" = 16),
    name = "Burn Status",          # Set the legend title for shape
    labels = c("DB" = "DB", "GB" = "GB")  # Set custom labels for shape
  ) + 
  guides(color = "none", shape = guide_legend(title = "Burn Status"))

trans_tree_well_peakablation_scatterplot_bydate
```

```{r}
ggsave(
  filename = "trans_tree_well_peakablation_scatterplot_bydate.png",  # File name
  plot = trans_tree_well_peakablation_scatterplot_bydate,           # The arranged plot object
  #width = ,                                          # Adjust width as needed
  #height = 18,                                         # Adjust height as needed
  dpi = 600                                            # High resolution
)
```

```{r}
#persb combined peak ablation ONLY scatterplot - tree_4 from high mort, all the rest from low mort
## use this plot!
persb_tree_well_peakablation_scatterplot_bydate <- ggplot(persb_peakablation_well_snowdepth_data, aes(x = tree_diam_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id, shape = burn_status), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = tree_diam_cm, y = well_diam_cm),  color = "grey", se = TRUE) +
  facet_wrap(~date) +
  labs(
    title = "a) PSZ ",
    x = NULL,
    y = "Well Diameter (cm)"
  ) +
  theme_bw() +
 scale_color_manual(values = treeid_colors,
    name = "Tree ID",               # Set the legend title for color
    labels = c("DB" = "DB", "GB" = "GB") # Set custom labels for color
  ) +
  scale_shape_manual(values = c("DB" = 15, "GB" = 16),
    name = "Burn Status",          # Set the legend title for shape
    labels = c("DB" = "DB", "GB" = "GB")  # Set custom labels for shape
  ) + 
  guides(color = "none", shape = guide_legend(title = "Burn Status"))

persb_tree_well_peakablation_scatterplot_bydate
```

```{r}
ggsave(
  filename = "persb_tree_well_peakablation_scatterplot_bydate.png",  # File name
  plot = persb_tree_well_peakablation_scatterplot_bydate,           # The arranged plot object
  #width = ,                                          # Adjust width as needed
  #height = 18,                                         # Adjust height as needed
  dpi = 600                                            # High resolution
)
```

```{r}
#combining the by-date datasets for tree vs well scatterplots
## USING THIS COMBINED PLOT, OR INDIVIDUAL ONES ABOVE AND COMBINING ON PAGE!
comb_tree_well_scatterplot <- ggarrange(persb_tree_well_peakablation_scatterplot_bydate, trans_tree_well_peakablation_scatterplot_bydate, nrow = 2, common.legend = TRUE, legend = "right")

comb_tree_well_scatterplot
```

```{r}
# calculating mean R^2 values for the above daily plots
trans_r2_values <- transb_peakablation_well_snowdepth_data %>%
  group_by(date) %>%
  summarise(
    r_squared = summary(lm(well_diam_cm ~ tree_diam_cm))$r.squared
  )

trans_mean_r2 <- mean(trans_r2_values$r_squared, na.rm = TRUE)

pers_r2_values <- persb_peakablation_well_snowdepth_data %>%
  group_by(date) %>%
  summarise(
    r_squared = summary(lm(well_diam_cm ~ tree_diam_cm))$r.squared
  )

pers_mean_r2 <- mean(pers_r2_values$r_squared, na.rm = TRUE)
```

\*\* splitting it by day shows that there is a correlation between diameter and well size, but that can only really be seen consistently on a day to day basis between different trees.

##### Snow Depth vs Well Development

```{r}
transb_peakablation_snowdepth_data <- transb_snowcam_depth_data %>%
  filter(date >= "2024-04-06" & date <= "2024-04-25") %>%
  select(date, zone, `maximum_depth(cm)`, conditions) %>%
  rename(max_depth_cm = 'maximum_depth(cm)', condition = conditions) %>%
  mutate(zone = "TSZ")

#joining ablation well & snowdepth data
transb_peakablation_well_snowdepth_data <- transb_peakablation_data %>%
  left_join(transb_peakablation_snowdepth_data)
```

```{r}
transb_r2_values <- transb_peakablation_well_snowdepth_data %>%
  group_by(tree_id) %>%
  summarise(r2 = summary(lm(well_diam_cm ~ max_depth_cm))$r.squared)
```

```{r}
transb_well_snowdepth_peakablation_scatterplot <- ggplot(transb_peakablation_well_snowdepth_data, aes(x = max_depth_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id, shape = burn_status), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~tree_id, nrow = 1) +
  labs(
    title = "b) TSZ",
    x = "Max Daily Snow Depth (cm)",
    y = "Well Diameter (cm)") +
  theme_bw() +
  scale_color_manual(values = treeid_colors,
    name = "Tree ID",               # Set the legend title for color
    labels = c("DB" = "DB", "GB" = "GB") # Set custom labels for color
  ) +
  scale_shape_manual(values = c("DB" = 15, "GB" = 16),
    name = "Burn Status",          # Set the legend title for shape
    labels = c("DB" = "DB", "GB" = "GB")  # Set custom labels for shape
  ) +
  # Annotated R^2 value
  geom_text(data = transb_r2_values, 
            aes(x = Inf, y = Inf, label = paste0("R² = ", round(r2, 2))), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4) +
  scale_y_continuous(limits = c(20, 200)) +
  scale_x_continuous(limits = c(0, 100)) +
  # Remove tree_id from the legend
  guides(color = "none", shape = guide_legend(title = "Burn Status"))

transb_well_snowdepth_peakablation_scatterplot
```

Pers Burned High Mort - don't use these plots

```{r}
persb_highmort_peakablation_snowdepth_data <- persb_highmort_snowcam_depth_data %>%
  filter(date >= "2024-05-06" & date <= "2024-05-25") %>%
  select(date, zone, max_depth_cm, conditions) %>%
  rename(condition = conditions) %>%
  mutate(zone = "PSZ")

#joining ablation well & snowdepth data
persb_highmort_peakablation_well_snowdepth_data <- persb_highmort_peakablation_data %>%
  left_join(persb_highmort_peakablation_snowdepth_data) %>%
  filter(tree_id !="tree_2")
```

```{r}
#NOT USING
persb_highmort_r2_values <- persb_highmort_peakablation_well_snowdepth_data %>%
  group_by(tree_id) %>%
  summarise(r2 = summary(lm(well_diam_cm ~ max_depth_cm))$r.squared)
```

```{r}
#NOT USING
persb_highmort_well_snowdepth_peakablation_scatterplot <- ggplot(persb_highmort_peakablation_well_snowdepth_data, aes(x = max_depth_cm, y = well_diam_cm)) +
 geom_point(aes(color = tree_id, shape = burn_status), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", aes(x = max_depth_cm, y = well_diam_cm),  color = "grey", se = TRUE) +
  facet_wrap(~tree_id, nrow = 1) +
  labs(
    title = "b)",
    x = NULL,
    y = "Well Diameter (cm)"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) +
  scale_shape_manual(values = c("DB" = 15, "GB" = 16)) +
  #Annotate R² values
  geom_text(data = persb_highmort_r2_values, 
            aes(x = Inf, y = Inf, label = paste0("R² = ", round(r2, 2))), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_highmort_well_snowdepth_peakablation_scatterplot
```

Pers Burned Low Mort - don't use these plots

```{r}
persb_lowmort_peakablation_snowdepth_data <- persb_lowmort_snowcam_depth_data %>%
  filter(date >= "2024-05-06" & date <= "2024-05-25") %>%
  select(date, zone, max_depth_cm, conditions) %>%
  rename(condition = conditions) %>%
  mutate(zone = "PSZ")

#joining ablation well & snowdepth data
persb_lowmort_peakablation_well_snowdepth_data <- persb_lowmort_peakablation_data %>%
  left_join(persb_highmort_peakablation_snowdepth_data)
  #filter(tree_id !="tree_2")
```

```{r}
#NOT USING
persb_lowmort_r2_values <- persb_lowmort_peakablation_well_snowdepth_data %>%
  group_by(tree_id) %>%
  summarise(r2 = summary(lm(well_diam_cm ~ max_depth_cm))$r.squared)
```

```{r}
#NOT USING
persb_lowmort_well_snowdepth_peakablation_scatterplot <- ggplot(persb_lowmort_peakablation_well_snowdepth_data, aes(x = max_depth_cm, y = well_diam_cm)) +
  geom_point(aes(color = tree_id, shape = burn_status), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~tree_id, nrow = 1) +
  labs(
    title = "c)",
    x = "Daily Max Snow Depth (cm)",
    y = "Well Diameter (cm)"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) +
  scale_shape_manual(values = c("DB" = 15, "GB" = 16)) +
  #Annotate R² values
  geom_text(data = persb_lowmort_r2_values, 
            aes(x = Inf, y = Inf, label = paste0("R² = ", round(r2, 2))), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_lowmort_well_snowdepth_peakablation_scatterplot
```

Combining two PSZ datasets so I have 4 tree_id's including 1 DB data

-   persb_lowmort treeid 1-3, persb_highmort treeid 4

```{r}
persb_peakablation_well_snowdepth_data_V1 <-
  persb_highmort_peakablation_well_snowdepth_data %>%
  filter(tree_id == "tree_4")

persb_peakablation_well_snowdepth_data <- rbind(persb_peakablation_well_snowdepth_data_V1, persb_lowmort_peakablation_well_snowdepth_data) %>%
  filter(date >= "2024-05-06" & date <= "2024-05-25")
```

```{r}
persb_r2_values <- persb_peakablation_well_snowdepth_data %>%
  group_by(tree_id) %>%
  summarise(r2 = summary(lm(well_diam_cm ~ max_depth_cm))$r.squared)
```

```{r}
persb_well_snowdepth_peakablation_scatterplot <- ggplot(persb_peakablation_well_snowdepth_data, aes(x = max_depth_cm, y = well_diam_cm)) +
  geom_point(aes(color = tree_id, shape = burn_status), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~tree_id, nrow = 1) +
  labs(
    title = "a) PSZ",
    x = NULL,
    y = "Well Diameter (cm)"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors,
    name = "Tree ID",               # Set the legend title for color
    labels = c("DB" = "DB", "GB" = "GB") # Set custom labels for color
  ) +
  scale_shape_manual(values = c("DB" = 15, "GB" = 16),
    name = "Burn Status",          # Set the legend title for shape
    labels = c("DB" = "DB", "GB" = "GB")  # Set custom labels for shape
  ) +
  # Annotated R^2 value
  geom_text(data = persb_r2_values, 
            aes(x = Inf, y = Inf, label = paste0("R² = ", round(r2, 2))), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4) +
  scale_y_continuous(limits = c(20, 200)) +
  scale_x_continuous(limits = c(0, 100)) +
  # Remove tree_id from the legend
  guides(color = "none", shape = guide_legend(title = "Burn Status"))

persb_well_snowdepth_peakablation_scatterplot

```

Combined Plots

```{r}
comb_ablation_well_snowdepth_scatterplot <- ggarrange(persb_well_snowdepth_peakablation_scatterplot, transb_well_snowdepth_peakablation_scatterplot, nrow = 2, ncol = 1, common.legend = TRUE, legend = "bottom", align = "v")

comb_ablation_well_snowdepth_scatterplot
```

```{r}
ggsave(
  filename = "comb_ablation_well_snowdepth_scatterplot.png",  # File name
  plot = comb_ablation_well_snowdepth_scatterplot,           # The arranged plot object
  #width = ,                                          # Adjust width as needed
  #height = 18,                                         # Adjust height as needed
  dpi = 600                                            # High resolution
)
```

\*\* use the above plot!

## New Tree Well Analysis

Full season analysis, as of 2025-02-12

```{r}
transb_treewell_diams_fullseason <- read_csv("nsf/treewell_data/snowcam_treewell_data/transb_treewell_diams_fullseason.csv") %>%
  filter(date <= "2024-05-08")

transb_treewell_diams_fullseason_V2 <- read_csv("nsf/treewell_data/snowcam_treewell_data/transb_treewell_diams_fullseason_V2.csv") %>%
  filter(date <= "2024-05-08")
```

```{r}
persb_high_treewell_diams_fullseason <- read_csv("nsf/treewell_data/snowcam_treewell_data/persb_highmort_treewell_diams_fullseason.csv") %>%
  filter(date >= "2024-02-02" & date <= "2024-05-23")

persb_high_treewell_diams_fullseason_V2 <- read_csv("nsf/treewell_data/snowcam_treewell_data/persb_highmort_treewell_diams_fullseason_V2.csv")  
```

```{r}
persb_low_treewell_diams_fullseason <- read_csv("nsf/treewell_data/snowcam_treewell_data/persb_lowmort_treewell_diams_fullseason.csv") %>%
  filter(date >= "2024-02-02" & date <= "2024-05-30")

persb_low_treewell_diams_fullseason_V2 <- read_csv("nsf/treewell_data/snowcam_treewell_data/persb_lowmort_treewell_diams_fullseason_V2.csv") %>%
   filter(date >= "2024-02-02" & date <= "2024-05-23")
```

```{r}
#pivoting the well and tree diam columns to be long format
long_transb_treewell_diams_fullseason <- transb_treewell_diams_fullseason %>%
  pivot_longer(cols = starts_with("tree_diam_") | starts_with("well_diam_"), 
               names_to = c(".value", "tree_id"), 
               names_pattern = "(.*)_(\\d+)_cm") %>%
  mutate(tree_id = as.integer(tree_id)) %>%
  #adding burn status to long dataframe per tree
  mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",
    tree_id == 4 ~ "DB",
    TRUE ~ NA_character_  # Handles any unexpected values
  ))
```

```{r}
long_transb_treewell_diams_fullseason_V2 <- transb_treewell_diams_fullseason_V2 %>%
  pivot_longer(cols = starts_with("tree_diam_") | starts_with("well_diam_"), 
               names_to = c(".value", "tree_id"), 
               names_pattern = "(.*)_(\\d+)_cm") %>%
  mutate(tree_id = as.integer(tree_id)) %>%
  #adding burn status to long dataframe per tree
  mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",
    tree_id == 4 ~ "DB",
    TRUE ~ NA_character_  # Handles any unexpected values
  ))
```

```{r}
long_persb_high_treewell_diams_fullseason_V2 <- persb_high_treewell_diams_fullseason_V2 %>%
  pivot_longer(cols = starts_with("tree_diam_") | starts_with("well_diam_"), 
               names_to = c(".value", "tree_id"), 
               names_pattern = "(.*)_(\\d+)_cm") %>%
  mutate(tree_id = as.integer(tree_id)) %>%
  mutate(date = as.Date(date)) %>%
  # Adding burn status to long dataframe per tree
  mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",
    tree_id == 4 ~ "DB",
    TRUE ~ NA_character_  # Handles any unexpected values
  )) %>%
  select(date, time_mst, zone, burn_status, maximum_depth_cm, 
         conditions, treewell_developed, reset, tree_id, tree_diam, well_diam)
```

```{r}
long_persb_low_treewell_diams_fullseason <- persb_low_treewell_diams_fullseason %>%
  pivot_longer(cols = starts_with("tree_diam_") | starts_with("well_diam_"), 
               names_to = c(".value", "tree_id"), 
               names_pattern = "(.*)_(\\d+)_cm") %>%
  mutate(tree_id = as.integer(tree_id)) %>%
  mutate(burn_status = "GB") %>%
  select(date, time_mst, zone, burn_status, maximum_depth_cm, conditions, treewell_developed, reset, tree_id, tree_diam, well_diam)
```

```{r}
long_persb_low_treewell_diams_fullseason_V2 <- persb_low_treewell_diams_fullseason_V2 %>%
  pivot_longer(cols = starts_with("tree_diam_") | starts_with("well_diam_"), 
               names_to = c(".value", "tree_id"), 
               names_pattern = "(.*)_(\\d+)_cm") %>%
  mutate(tree_id = as.integer(tree_id)) %>%
  mutate(burn_status = "GB") %>%
  select(date, time_mst, zone, burn_status, maximum_depth_cm, conditions, treewell_developed, reset, tree_id, tree_diam, well_diam)
```

```{r}
#combining persb_high and persb_low to get ONLY the DB of pers_high and GB of pers_low
DB_long_persb_high_treewell_diam_fullseason <- long_persb_high_treewell_diams_fullseason_V2 %>%
  filter(burn_status == "DB")

GB_long_persb_low_treewell_diams_fullseason <- 
  long_persb_low_treewell_diams_fullseason
```

```{r}
#combined dataframe with GB from low mort and DB from high mort
comb_persb_treewell_diam_fullseason <- rbind( long_persb_low_treewell_diams_fullseason_V2, DB_long_persb_high_treewell_diam_fullseason) %>%
  mutate(well_diamV2 = well_diam - tree_diam)
```

```{r}
#dataframe for when treewell's reset
transb_treewell_reset_dataframe <- long_transb_treewell_diams_fullseason %>%
  filter(reset == "Yes", tree_id == "1")

transb_treewell_reset_dataframe_V2 <- long_transb_treewell_diams_fullseason_V2 %>%
  filter(reset == "Yes", tree_id == "1")

persb_treewell_reset_dataframe <- long_persb_high_treewell_diams_fullseason %>%
  filter(reset == "Yes", tree_id == "1")

persb_treewell_reset_dataframe_V2 <- long_persb_high_treewell_diams_fullseason_V2 %>%
  filter(reset == "Yes", tree_id == "1")
```

```{r}
filtered_daily_transb_wx_15min_r <- filtered_transb_wx_15min %>%
  filter(day >= "2024-02-02" & day <= "2024-05-23") %>%
  filter(phase == "day") %>%
  group_by(date) %>%
  summarize(
    AirTC_Avg = mean(AirTC_Avg, na.rm = TRUE), 
    WS_ms_Avg = mean(WS_ms_Avg, na.rm = TRUE), 
    SWin_Avg = mean(SWin_Avg, na.rm = TRUE), 
    SWout_Avg = mean(SWout_Avg, na.rm = TRUE), 
    LWin_Avg = mean(LWin_Avg, na.rm = TRUE), 
    LWout_Avg = mean(LWout_Avg, na.rm = TRUE), 
    SWnet_Avg = mean(SWnet_Avg, na.rm = TRUE), 
    LWnet_Avg = mean(LWnet_Avg, na.rm = TRUE), 
    NR_Avg = mean(NR_Avg, na.rm = TRUE), 
    SnowDepth_cm = mean(SnowDepth_cm, na.rm = TRUE))
```

```{r}
filtered_daily_persb_wx_hourly_r <- filtered_persb_wx_hourly %>%
  filter(day >= "2024-02-02" & day <= "2024-05-23") %>%
  filter(phase == "day") %>%
  group_by(date) %>%
  summarize(
    AirTC_Avg = mean(AirTC_Avg, na.rm = TRUE), 
    WS_ms_Avg = mean(WS_ms_Avg, na.rm = TRUE), 
    SWin_Avg = mean(SWin_Avg, na.rm = TRUE), 
    SWout_Avg = mean(SWout_Avg, na.rm = TRUE), 
    LWin_Avg = mean(LWin_Avg, na.rm = TRUE), 
    LWout_Avg = mean(LWout_Avg, na.rm = TRUE), 
    SWnet_Avg = mean(SWnet_Avg, na.rm = TRUE), 
    LWnet_Avg = mean(LWnet_Avg, na.rm = TRUE), 
    NR_Avg = mean(NR_Avg, na.rm = TRUE), 
    SnowDepth_cm = mean(SnowDepth_cm, na.rm = TRUE))
```

Plotting tree well diams + weather

```{r}
scaling_factor_SW <- 0.3
```

```{r}
transb_fullseason_well_SW_plot <- ggplot() +
  # Vertical lines for when wells were reset
  geom_vline(data = transb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), 
             color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Shortwave in 
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = SWin_Avg * scaling_factor_SW, fill = "SWin"), alpha = 0.5) + 
  # Shortwave out
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = SWout_Avg * scaling_factor_SW, fill = "SWout"), alpha = 0.4) + 
  # Tree well diameter lines
  geom_line(data = long_transb_treewell_diams_fullseason_V2, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_SW, name = "Radiation (W/m²)")
  ) +
  # Corrected color and linetype mappings
  scale_fill_manual(name = "Radiation Component", 
    values = c("SWin" = "orange", "SWout" = "red")) +  
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "b) TSZ", 
       x = "Date", 
       fill = "Radiation Component", 
       color = "Tree ID", 
       linetype = "Burn Status") +
  theme_bw()

transb_fullseason_well_SW_plot
```

```{r}
persb_fullseason_well_SW_plot <- ggplot() +
  # Shortwave in 
  geom_col(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = SWin_Avg * scaling_factor_SW, fill = "SWin"), alpha = 0.5) + 
  # Shortwave out
  geom_col(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = SWout_Avg * scaling_factor_SW, fill = "SWout"), alpha = 0.4) + 
  # Vertical lines for when wells were reset
  geom_vline(data = persb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), 
             color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Tree well diameter lines
  geom_line(data = comb_persb_treewell_diam_fullseason, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_SW, name = "Radiation (W/m²)")
  ) +
  # Corrected color and linetype mappings
  scale_fill_manual(name = "Radiation Component", 
    values = c("SWin" = "orange", "SWout" = "red")) +  
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "a) PSZ", 
       x = "Date", 
       fill = "Radiation Component", 
       color = "Tree ID", 
       linetype = "Burn Status") +
  theme_bw()

persb_fullseason_well_SW_plot
```

```{r}
ggsave("nsf/persb_fullseason_well_SW_plot.png", 
       plot = persb_fullseason_well_SW_plot, width = 13, height = 7, dpi = 600)
```

```{r}
ggsave("nsf/transb_fullseason_well_SW_plot.png", 
       plot = transb_fullseason_well_SW_plot, width = 13, height = 7, dpi = 600)
```

LWin/out

```{r}
scaling_factor_LW <- 0.5
```

```{r}
transb_fullseason_well_LW_plot <- ggplot() +
  # Longwave in 
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = LWin_Avg * scaling_factor_LW, fill = "LWin"), alpha = 0.5) + 
  # Longwave out
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = LWout_Avg * scaling_factor_LW, fill = "LWout"), alpha = 0.4) + 
   # Vertical lines for when wells were reset
  geom_vline(data = transb_treewell_reset_dataframe, 
             aes(xintercept = as.numeric(date)), 
             color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Tree well diameter lines
  geom_line(data = long_transb_treewell_diams_fullseason, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_LW, name = "Radiation (W/m²)")
  ) +
  # Corrected color and linetype mappings
  scale_fill_manual(name = "Radiation Component", 
    values = c("LWin" = "dodgerblue1", "LWout" = "dodgerblue3")) +  
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "b) TSZ", 
    x = "Date", 
       fill = "Radiation Component", 
       color = "Tree ID", 
       linetype = "Burn Status") +
  theme_bw()

transb_fullseason_well_LW_plot
```

```{r}
persb_fullseason_well_LW_plot <- ggplot() +
  # Longwave in 
  geom_col(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = LWin_Avg * scaling_factor_LW, fill = "LWin"), alpha = 0.5) + 
  # Longwave out
  geom_col(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = LWout_Avg * scaling_factor_LW, fill = "LWout"), alpha = 0.4) + 
   # Vertical lines for when wells were reset
  geom_vline(data = persb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), 
             color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Tree well diameter lines
  geom_line(data = comb_persb_treewell_diam_fullseason, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_LW, name = "Radiation (W/m²)")
  ) +
  # Corrected color and linetype mappings
  scale_fill_manual(name = "Radiation Component", 
    values = c("LWin" = "dodgerblue1", "LWout" = "dodgerblue3")) +  
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "a) PSZ",
    x = "Date", 
       fill = "Radiation Component", 
       color = "Tree ID", 
       linetype = "Burn Status") +
  theme_bw()

persb_fullseason_well_LW_plot
```

```{r}
ggsave("nsf/persb_fullseason_well_LW_plot.png", 
       plot = persb_fullseason_well_LW_plot, width = 13, height = 7, dpi = 600)
```

```{r}
ggsave("nsf/transb_fullseason_well_LW_plot.png", 
       plot = transb_fullseason_well_LW_plot, width = 13, height = 7, dpi = 600)
```

NR Avg plot

```{r}
scaling_factor_NR <- 2
```

```{r}
transb_fullseason_well_LW_plot <- ggplot() +
  # Tree well diameter lines
  geom_line(data = long_transb_treewell_diams_fullseason_V2, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Vertical lines for when wells were reset
  geom_vline(data = transb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), 
             color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Longwave in 
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = NR_Avg * scaling_factor_NR), fill = "orange", alpha = 0.5) + 
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_NR, name = "Radiation (W/m²)")
  ) +
  # Corrected color and linetype mappings
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(x = "Date", color = "Tree ID", linetype = "Burn Status") +
  theme_bw()

transb_fullseason_well_LW_plot
```

Air Temp

\*\* I like this option below the most, so far! But need to mess around with reset notation/visual more

```{r}
scaling_factor_airT <- 10
```

```{r}
transb_fullseason_well_airTCRad_plot <- ggplot() +
  # NR Avg (Radiation)
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = NR_Avg, fill = "Total Net Radiation"), alpha = 0.5) + 
  # Vertical lines for when wells were reset
  geom_vline(data = transb_treewell_reset_dataframe_V2, 
            aes(xintercept = as.numeric(date)), color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Air Temp
  geom_line(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = AirTC_Avg * scaling_factor_airT, color = "Air Temp"), linewidth = 0.8, alpha = 0.8) + 
  # Tree well diameter lines
  geom_line(data = long_transb_treewell_diams_fullseason_V2, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm) & Radiation (W/m²)", 
    sec.axis = sec_axis(~ . / scaling_factor_airT, name = "Air Temp (°C)")
  ) +
  # Corrected color and linetype mappings
  scale_color_manual(name = "Tree ID & Wx Station Component", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple", "Air Temp" = "dodgerblue3")) +  
  scale_fill_manual(name = "Radiation Component", 
    values = c("Total Net Radiation" = "orange")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "b) TSZ", 
       x = "Date", 
       color = "Legend", 
       linetype = "Burn Status") +
  theme_bw()

transb_fullseason_well_airTCRad_plot
```

```{r}
persb_fullseason_well_airTCRad_plot <- ggplot() +
  # NR Avg (Radiation)
  geom_col(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = NR_Avg, fill = "Total Net Radiation"), alpha = 0.5) + 
  # Vertical lines for when wells were reset
  geom_vline(data = persb_treewell_reset_dataframe_V2, 
            aes(xintercept = as.numeric(date)), color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Air Temp
  geom_line(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = AirTC_Avg * scaling_factor_airT, color = "Air Temp"), linewidth = 0.8, alpha = 0.8) + 
  # Tree well diameter lines
  geom_line(data = comb_persb_treewell_diam_fullseason, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm) & Radiation (W/m²)", 
    sec.axis = sec_axis(~ . / scaling_factor_airT, name = "Air Temp (°C)")
  ) +
  # Corrected color and linetype mappings
  scale_color_manual(name = "Tree ID & Wx Station Component", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple", "Air Temp" = "dodgerblue3")) +  
  scale_fill_manual(name = "Radiation Component", 
    values = c("Total Net Radiation" = "orange")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "a) PSZ", 
       x = "Date", 
       color = "Legend", 
       linetype = "Burn Status") +
  theme_bw()

persb_fullseason_well_airTCRad_plot
```

Combining Plots

```{r}
comb_fullseason_well_airTRAD_plot <- ggarrange(persb_fullseason_well_airTCRad_plot, transb_fullseason_well_airTCRad_plot, nrow = 2, ncol = 1, common.legend = TRUE, legend = "bottom")

comb_fullseason_well_airTRAD_plot
```

```{r}
ggsave("nsf/comb_fullseason_well_airTRAD_plot.png", 
       width = 12, height = 10,
       plot = comb_fullseason_well_airTRAD_plot, dpi = 600)
```

Individually saving plots

```{r}
ggsave("nsf/persb_fullseason_well_airTCRad_plot.png", 
       plot = persb_fullseason_well_airTCRad_plot, width = 13, height = 7, dpi = 600)
```

```{r}
ggsave("nsf/transb_fullseason_well_airTCRad_plot.png", 
       plot = transb_fullseason_well_airTCRad_plot, width = 13, height = 7, dpi = 600)
```

Snow Depth

```{r}
sd_persb <- comb_persb_treewell_diam_fullseason %>%
  filter(tree_id == "1")
```

```{r}
scaling_factor_sd <- 1
```

```{r}
persb_fullseason_well_sd_plot <- ggplot() +
  # Snow depth on secondary y-axis
  geom_col(data = sd_persb, 
           aes(x = date, y = maximum_depth_cm * scaling_factor_sd, fill = "Snow Depth"), alpha = 0.5) + 
  # Vertical lines for when wells were reset
  geom_vline(data = persb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), color = "grey23", 
             linetype = "solid", size = 0.5, alpha = 0.7) +
  # Tree well diameter lines (Primary y-axis)
  geom_line(data = comb_persb_treewell_diam_fullseason, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), 
            linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_sd, name = "Snow Depth (cm)")
  ) +
  # Corrected color and linetype mappings
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_fill_manual(name = NULL, values = c("Snow Depth" = "dodgerblue3")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "a) PSZ", 
       x = "Date", 
       color = "Tree ID", 
       linetype = "Burn Status", 
       fill = "Snow Depth") +
  theme_bw()

persb_fullseason_well_sd_plot
```

```{r}
sd_transb <- long_transb_treewell_diams_fullseason_V2 %>%
  filter(tree_id == "1")
```

```{r}
transb_fullseason_well_sd_plot <- ggplot() +
  # Snow depth on secondary y-axis
  geom_col(data = sd_transb, 
           aes(x = date, y = maximum_depth_cm * scaling_factor_sd, fill = "Snow Depth"), alpha = 0.5) + 
  # Vertical lines for when wells were reset
  geom_vline(data = transb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), color = "grey23", 
             linetype = "solid", size = 0.5, alpha = 0.7) +
  # Tree well diameter lines (Primary y-axis)
  geom_line(data = long_transb_treewell_diams_fullseason_V2, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), 
            linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_sd, name = "Snow Depth (cm)")
  ) +
  # Corrected color and linetype mappings
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_fill_manual(name = NULL, 
                    values = c("Snow Depth" = "dodgerblue3")) +
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "b) TSZ", 
       x = "Date", 
       color = "Legend", 
       linetype = "Burn Status") +
  theme_bw()

transb_fullseason_well_sd_plot
```

```{r}
ggsave("nsf/persb_fullseason_well_sd_plot.png", 
       plot = persb_fullseason_well_sd_plot, width = 13, height = 7, dpi = 600)
```

```{r}
ggsave("nsf/transb_fullseason_well_sd_plot.png", 
       plot = transb_fullseason_well_sd_plot, width = 13, height = 7, dpi = 600)
```

## Well & Weather Correlation

### Data Wrangling

```{r}
#pulling in tree temp data and creating a mean daily average

p_b_solar_times <- read_csv("nsf/treetemp_data/p_b_solar_times.csv") %>%
  mutate(
    sunrise = as.POSIXct(sunrise, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"),
    sunrise = with_tz(sunrise, tz = "MST")
  ) %>%
   mutate(
    sunset = as.POSIXct(sunset, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"),
    sunset = with_tz(sunset, tz = "MST")
  )

full_15min_ns <- read_csv("nsf/treetemp_data/full_15min_ns.csv") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                               datetime = with_tz(datetime, tz = 'MST')) %>%
  mutate(day = as.Date(day, format = ("%Y-%m-%d"))) %>%
  inner_join(p_b_solar_times, by = "day") %>%
  #creating a phase column that parses by daily sunrise/sunset times
  mutate(
    phase = case_when(
      datetime >= sunrise & datetime < sunset ~ "day",
      datetime < sunrise ~ "night",
      datetime >= sunset ~ "night",
      TRUE ~ NA_character_)) %>%
  select(datetime, day, month, phase, zone, snow_phase, burn_status, north_temp, south_temp, solarNoon, sunrise, sunset, dawn, dusk)
```

```{r}
persb_daily_treetemp_data <- full_15min_ns %>%
  filter(zone == "PSZ", phase == "day") %>%
  rename(date = "day") %>%
  group_by(date) %>%
  summarize(mean_tree_temp = mean((north_temp + south_temp)/2))
```

```{r}
transb_daily_treetemp_data <- full_15min_ns %>%
  filter(zone == "TSZ", phase == "day") %>%
  rename(date = "day") %>%
  group_by(date) %>%
  summarize(mean_tree_temp = mean((north_temp + south_temp)/2))
```

### Correlation Tests

```{r}
#colors for points
treeid_colors <- c("1" = "#1B7837", "2" = "#D95F02", "3" = "#2166AC", "4" = "grey23")
```

PSZ

```{r}
persb_corr_data_V2 <- comb_persb_treewell_diam_fullseason %>%
  # Select relevant columns
  #had to remove the burn_status and tree_diam columns because those values are different from tree to tree!
  select(date, tree_id, zone, treewell_developed, reset, well_diam, maximum_depth_cm) %>%
  # Pivot wider so each tree_id has its own well_diam column
  pivot_wider(names_from = tree_id, values_from = well_diam, names_prefix = "well_diam_tree") %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  # Compute differenced well diameter for each tree where well diameter increases
  mutate(
    well_diam_diff_tree1 = if_else(well_diam_tree1 > lag(well_diam_tree1), 
                                   abs(well_diam_tree1 - lag(well_diam_tree1)), NA_real_),
    well_diam_diff_tree2 = if_else(well_diam_tree2 > lag(well_diam_tree2), 
                                   abs(well_diam_tree2 - lag(well_diam_tree2)), NA_real_),
    well_diam_diff_tree3 = if_else(well_diam_tree3 > lag(well_diam_tree3), 
                                   abs(well_diam_tree3 - lag(well_diam_tree3)), NA_real_),
    well_diam_diff_tree4 = if_else(well_diam_tree4 > lag(well_diam_tree4), 
                                   abs(well_diam_tree4 - lag(well_diam_tree4)), NA_real_)
  ) %>%
  # Remove rows where all well_diam_diff values are NA
  filter(!if_all(starts_with("well_diam_diff"), is.na))
```

```{r}
#using well diameter minus tree diameter to see if there's a difference in correlation!
persb_corr_data_V3 <- comb_persb_treewell_diam_fullseason %>%
  # Select relevant columns
  #had to remove the burn_status and tree_diam columns because those values are different from tree to tree!
  select(date, tree_id, zone, treewell_developed, reset, well_diamV2, maximum_depth_cm) %>%
  # Pivot wider so each tree_id has its own well_diam column
  pivot_wider(names_from = tree_id, values_from = well_diamV2, names_prefix = "well_diam_tree") %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  # Compute differenced well diameter for each tree where well diameter increases
  mutate(
    well_diam_diff_tree1 = if_else(well_diam_tree1 > lag(well_diam_tree1), 
                                   abs(well_diam_tree1 - lag(well_diam_tree1)), NA_real_),
    well_diam_diff_tree2 = if_else(well_diam_tree2 > lag(well_diam_tree2), 
                                   abs(well_diam_tree2 - lag(well_diam_tree2)), NA_real_),
    well_diam_diff_tree3 = if_else(well_diam_tree3 > lag(well_diam_tree3), 
                                   abs(well_diam_tree3 - lag(well_diam_tree3)), NA_real_),
    well_diam_diff_tree4 = if_else(well_diam_tree4 > lag(well_diam_tree4), 
                                   abs(well_diam_tree4 - lag(well_diam_tree4)), NA_real_)
  ) %>%
  # Remove rows where all well_diam_diff values are NA
  filter(!if_all(starts_with("well_diam_diff"), is.na))
```

```{r}
persb_corr_long <- persb_corr_data_V2 %>%
  pivot_longer(cols = starts_with("well_diam_diff_tree"), 
               names_to = "tree_id", 
               values_to = "well_diam_diff") %>%
  mutate(tree_id = str_replace(tree_id, "well_diam_diff_tree", "")) %>%
  select(-c(well_diam_tree1, well_diam_tree2, well_diam_tree3, well_diam_tree4)) %>%
   mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",  # Assign "GB" to tree_id 1, 2, 3
    tree_id == 4 ~ "DB"              # Assign "DB" to tree_id 4
  )) %>%
  #adding in an accumulation and ablation season
  mutate(season = case_when(
    date < as.Date("2024-05-06") ~ "accumulation",
    date >= as.Date("2024-05-06") ~ "ablation"
  ))
```

```{r}
#well diameter without tree diameter!
persb_corr_long_V2 <- persb_corr_data_V3 %>%
  pivot_longer(cols = starts_with("well_diam_diff_tree"), 
               names_to = "tree_id", 
               values_to = "well_diam_diff") %>%
  mutate(tree_id = str_replace(tree_id, "well_diam_diff_tree", "")) %>%
  select(-c(well_diam_tree1, well_diam_tree2, well_diam_tree3, well_diam_tree4)) %>%
   mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",  # Assign "GB" to tree_id 1, 2, 3
    tree_id == 4 ~ "DB"              # Assign "DB" to tree_id 4
  ))
```

```{r}
#run only if I am separating the following plots by month!
persb_corr_may <- persb_corr_long %>%
  filter(date >= "2024-05-01" & date <= "2024-05-30")
```

```{r}
persb_corr_accu <- persb_corr_long %>%
  filter(date < "2024-05-01")

persb_corr_abla <- persb_corr_long %>%
  filter(date >= "2024-05-01")
```

```{r}
#not using right now!
p_AirTC_r2_values <- persb_corr_long %>%
  drop_na(well_diam_diff, AirTC_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, AirTC_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3))) # Create label for plotting
```

```{r}
# AirTC Correlation
# Compute R^2 for each tree_id

p_AirTC_results <- persb_corr_long %>%
  drop_na(well_diam_diff, AirTC_Avg) %>%
  group_by(tree_id, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
persb_AirTC_corr_plot <- ggplot(persb_corr_long, aes(x = AirTC_Avg, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Air Temperature",
    x = "Air Temperature (°C)",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  guides(color = "none") +  # Remove color legend
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_AirTC_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_AirTC_corr_plot
```

```{r}
ggsave("persb_AirTC_corr_plot.png", plot = persb_AirTC_corr_plot, dpi = 600)
```

Lagged results model

```{r}
#trying a lagged regression to see if day-before data is what causes change?

persb_corr_lagged <- persb_corr_long %>%
  arrange(tree_id, date) %>%  # Sorting by tree_id and date ensures correct lagging
  group_by(tree_id) %>%
  mutate(AirTC_Avg_lag1 = lag(AirTC_Avg, n = 1)) %>%  # Lag AirTC_Avg by 1 time step
  ungroup()

# Fit the lagged regression model for each tree_id
lagged_results <- persb_corr_lagged %>%
  drop_na(well_diam_diff, AirTC_Avg_lag1) %>%  # Remove NAs
  group_by(tree_id) %>%
  summarise(
    model = list(lm(well_diam_diff ~ AirTC_Avg_lag1, data = cur_data())),  # Fit lagged regression
    .groups = "drop"
  )

p_AirTC_r2_values_lag <- lagged_results %>%
  mutate(R2 = map_dbl(model, ~ summary(.x)$r.squared)) %>%  # Extract R² from each model
  mutate(R2_label = paste0("Lagged R² = ", round(R2, 3))) %>%
  select(tree_id, R2, R2_label)

p_AirTC_r2_values_lag 
```

\*\* lagged results seem to decrease Rsquared value.

```{r}
#not using right now!
p_TreeTemp_r2_values <- persb_corr_long %>%
  drop_na(well_diam_diff, mean_tree_temp) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, mean_tree_temp, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))
```

```{r}
# Tree Temp Correlation
# Compute R^2 for each tree_id

p_TreeTemp_results <- persb_corr_long %>%
  drop_na(well_diam_diff, mean_tree_temp) %>%
  group_by(tree_id, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, mean_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
persb_TreeTemp_corr_plot <- ggplot(persb_corr_long, aes(x = mean_tree_temp, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Tree Temperature",
    x = "Tree Temperature (°C)",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_TreeTemp_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_TreeTemp_corr_plot
```

```{r}
ggsave("persb_TreeTemp_corr_plot.png", plot = persb_TreeTemp_corr_plot, dpi = 600)
```

```{r}
persb_corr_TreeTemp_lagged <- persb_corr_long %>%
  arrange(tree_id, date) %>%  # Sorting by tree_id and date ensures correct lagging
  group_by(tree_id) %>%
  mutate(mean_tree_temp_lag1 = lag(mean_tree_temp, n = 1)) %>%  # Lag AirTC_Avg by 1 time step
  ungroup()

# Fit the lagged regression model for each tree_id
persb_TreeTemp_lagged_results <- persb_corr_TreeTemp_lagged %>%
  drop_na(well_diam_diff, mean_tree_temp_lag1) %>%  # Remove NAs
  group_by(tree_id) %>%
  summarise(
    model = list(lm(well_diam_diff ~ mean_tree_temp_lag1, data = cur_data())),  # Fit lagged regression
    .groups = "drop"
  )

p_TreeTemp_r2_values_lag <- persb_TreeTemp_lagged_results %>%
  mutate(R2 = map_dbl(model, ~ summary(.x)$r.squared)) %>%  # Extract R² from each model
  mutate(R2_label = paste0("Lagged R² = ", round(R2, 3))) %>%
  select(tree_id, R2, R2_label)

p_TreeTemp_r2_values_lag
```

```{r}
#not using right now!
p_SWin_r2_values <- persb_corr_long %>%
  drop_na(well_diam_diff, SWin_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, SWin_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))  # Create label for plotting
```

```{r}
# SWin Correlation
# Compute R^2 for each tree_id
p_SWin_results <- persb_corr_long %>%
  drop_na(well_diam_diff, SWin_Avg) %>%
  group_by(burn_status, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, SWin_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    R2_label = paste0("R² = ", round(R2, 3), "\n", "P-value = ", signif(p_value, 3))  # Stack values with newline
  )

# Scatterplot with facet_wrap
persb_SWin_corr_plot <- ggplot(persb_corr_long, aes(x = SWin_Avg, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ, SWin",
    x = "Daily Incoming SW (W/m^2))",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_SWin_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_SWin_corr_plot
```

```{r}
#not using right now!
p_NetSW_r2_values <- persb_corr_long%>%
  drop_na(well_diam_diff, SWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, SWnet_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))  # Create label for plotting
```

```{r}
# NetSW Correlation
# Compute R^2 for each tree_id
p_NetSW_results <- persb_corr_long %>%
  drop_na(well_diam_diff, SWnet_Avg) %>%
  group_by(burn_status, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
persb_NetSW_corr_plot <- ggplot(persb_corr_long, aes(x = SWnet_Avg, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Net SW",
    x = "Daily Net SW (W/m^2))",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
 geom_text(data = p_NetSW_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NetSW_corr_plot
```

```{r}
ggsave("persb_NetSW_corr_plot.png", plot = persb_NetSW_corr_plot, dpi = 600)
```

```{r}
#not using right now
p_NetLW_r2_values <- persb_corr_long %>%
  drop_na(well_diam_diff, LWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, LWnet_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))  # Create label for plotting
```

```{r}
# NetLW Correlation
# Compute R^2 for each tree_id
p_NetLW_results <- persb_corr_long %>%
  drop_na(well_diam_diff, LWnet_Avg) %>%
  group_by(burn_status, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
persb_NetLW_corr_plot <- ggplot(persb_corr_long, aes(x = LWnet_Avg, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Net LW",
    x = "Daily Net LW (W/m^2))",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
   geom_text(data = p_NetLW_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NetLW_corr_plot
```

```{r}
ggsave("persb_NetLW_corr_plot.png", plot = persb_NetLW_corr_plot, dpi = 600)
```

```{r}
#not using right now!
p_NR_r2_values <- persb_corr_long %>%
  drop_na(well_diam_diff, NR_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, NR_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))  # Create label for plotting
```

```{r}
# Total net Radiation Correlation
# Compute R^2 for each tree_id
p_NR_results <- persb_corr_long %>%
  drop_na(well_diam_diff, NR_Avg) %>%
  group_by(tree_id, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
persb_NR_corr_plot <- ggplot(persb_corr_long, aes(x = NR_Avg, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Total Net Radiation ",
    x = "Daily Mean Net Radiation (W/m^2)",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NR_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NR_corr_plot
```

```{r}
ggsave("persb_NR_corr_plot.png", plot = persb_NR_corr_plot, dpi = 600)
```

```{r}
persb_corr_NR_lagged <- persb_corr_long %>%
  arrange(tree_id, date) %>%  # Sorting by tree_id and date ensures correct lagging
  group_by(tree_id) %>%
  mutate(NR_Avg_lag1 = lag(NR_Avg, n = 1)) %>%  # Lag AirTC_Avg by 1 time step
  ungroup()

# Fit the lagged regression model for each tree_id
persb_NR_lagged_results <- persb_corr_NR_lagged %>%
  drop_na(well_diam_diff, NR_Avg_lag1) %>%  # Remove NAs
  group_by(tree_id) %>%
  summarise(
    model = list(lm(well_diam_diff ~ NR_Avg_lag1, data = cur_data())),  # Fit lagged regression
    .groups = "drop"
  )

p_NR_r2_values_lag <- persb_NR_lagged_results %>%
  mutate(R2 = map_dbl(model, ~ summary(.x)$r.squared)) %>%  # Extract R² from each model
  mutate(R2_label = paste0("Lagged R² = ", round(R2, 3))) %>%
  select(tree_id, R2, R2_label)

p_NR_r2_values_lag
```

```{r}
#not using right now
p_SD_r2_values <- persb_corr_long %>%
  drop_na(well_diam_diff, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, maximum_depth_cm, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3))) 
```

```{r}
# SD Correlation
# Compute R^2 for each tree_id
p_SD_results <- persb_corr_long %>%
  drop_na(well_diam_diff, maximum_depth_cm) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
persb_wxSD_corr_plot <- ggplot(persb_corr_long, aes(x = maximum_depth_cm, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Snow Depth",
    x = "Daily Maximum Snow Depth (cm)",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_SD_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_SD_corr_plot
```

```{r}
ggsave("persb_SD_corr_plot.png", plot = persb_SD_corr_plot, dpi = 600)
```

```{r}
persb_corr_SD_lagged <- persb_corr_long %>%
  arrange(tree_id, date) %>%  # Sorting by tree_id and date ensures correct lagging
  group_by(tree_id) %>%
  mutate(max_SD_lag1 = lag(maximum_depth_cm, n = 1)) %>%  # Lag AirTC_Avg by 1 time step
  ungroup()

# Fit the lagged regression model for each tree_id
persb_SD_lagged_results <- persb_corr_SD_lagged %>%
  drop_na(well_diam_diff, max_SD_lag1) %>%  # Remove NAs
  group_by(tree_id) %>%
  summarise(
    model = list(lm(well_diam_diff ~ max_SD_lag1, data = cur_data())),  # Fit lagged regression
    .groups = "drop"
  )

p_SD_r2_values_lag <- persb_SD_lagged_results %>%
  mutate(R2 = map_dbl(model, ~ summary(.x)$r.squared)) %>%  # Extract R² from each model
  mutate(R2_label = paste0("Lagged R² = ", round(R2, 3))) %>%
  select(tree_id, R2, R2_label)

p_SD_r2_values_lag
```

```{r}
# Weather station SD Correlation
# Compute R^2 for each tree_id
p_wxSD_results <- persb_corr_long %>%
  drop_na(well_diam_diff, SnowDepth_cm) %>%
  group_by(tree_id, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, SnowDepth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
persb_wxSD_corr_plot <- ggplot(persb_corr_long, aes(x = SnowDepth_cm, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id + season) +  # Separate by tree_id
  labs(
    title = "PSZ: Snow Depth",
    x = "Wx Station Daily Snow Depth (cm)",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_wxSD_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_wxSD_corr_plot
```

TSZ

```{r}
transb_corr_data <- long_transb_treewell_diams_fullseason_V2 %>%
  # Select relevant columns
  #had to remove the burn_status and tree_diam columns because those values are different from tree to tree!
  select(date, tree_id, zone, treewell_developed, reset, well_diam, maximum_depth_cm) %>%
  # Pivot wider so each tree_id has its own well_diam column
  pivot_wider(names_from = tree_id, values_from = well_diam, names_prefix = "well_diam_tree") %>%
  # Join with weather data
  inner_join(filtered_daily_transb_wx_15min_r, by = "date") %>%
  inner_join(transb_daily_treetemp_data, by = "date") %>%
  # Compute differenced well diameter for each tree where well diameter increases
  mutate(
    well_diam_diff_tree1 = if_else(well_diam_tree1 > lag(well_diam_tree1), 
                                   abs(well_diam_tree1 - lag(well_diam_tree1)), NA_real_),
    well_diam_diff_tree2 = if_else(well_diam_tree2 > lag(well_diam_tree2), 
                                   abs(well_diam_tree2 - lag(well_diam_tree2)), NA_real_),
    well_diam_diff_tree3 = if_else(well_diam_tree3 > lag(well_diam_tree3), 
                                   abs(well_diam_tree3 - lag(well_diam_tree3)), NA_real_),
    well_diam_diff_tree4 = if_else(well_diam_tree4 > lag(well_diam_tree4), 
                                   abs(well_diam_tree4 - lag(well_diam_tree4)), NA_real_)
  ) %>%
  # Remove rows where all well_diam_diff values are NA
  filter(!if_all(starts_with("well_diam_diff"), is.na))
```

```{r}
transb_corr_long <- transb_corr_data %>%
  pivot_longer(cols = starts_with("well_diam_diff_tree"), 
               names_to = "tree_id", 
               values_to = "well_diam_diff") %>%
  mutate(tree_id = str_replace(tree_id, "well_diam_diff_tree", "")) %>%
  select(-c(well_diam_tree1, well_diam_tree2, well_diam_tree3, well_diam_tree4)) %>%
  mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",  # Assign "GB" to tree_id 1, 2, 3
    tree_id == 4 ~ "DB"              # Assign "DB" to tree_id 4
  ))  %>%
  #adding in an accumulation and ablation season
  mutate(season = case_when(
    date < as.Date("2024-04-01") ~ "accumulation",
    date >= as.Date("2024-04-01") ~ "ablation"
  ))
```

```{r}
#run if I am separating the well_diam_diff data!
transb_corr_feb <- transb_corr_long %>%
  filter(date >= "2024-02-02" & date <= "2024-02-29")

transb_corr_march <- transb_corr_long %>%
  filter(date >= "2024-03-01" & date <= "2024-03-31")

transb_corr_april <- transb_corr_long %>%
  filter(date >= "2024-04-01" & date <= "2024-04-30")

transb_corr_may <- transb_corr_long %>%
  filter(date >= "2024-05-01" & date <= "2024-05-31")
```

```{r}
#not using right now
t_AirTC_r2_values <- transb_corr_long %>%
  drop_na(well_diam_diff, AirTC_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, AirTC_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3))) # Create label for plotting
```

```{r}
# AirTC Correlation
# Compute R^2 for each tree_id
t_AirTC_results <- transb_corr_long %>%
  drop_na(well_diam_diff, AirTC_Avg) %>%
  group_by(tree_id, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
 mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
transb_AirTC_corr_plot <- ggplot(transb_corr_long, aes(x = AirTC_Avg, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Air Temperature",
    y = "Air Temperature (°C)",
    x = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_AirTC_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_AirTC_corr_plot
```

```{r}
ggsave("transb_AirTC_corr_plot.png", plot = transb_AirTC_corr_plot, dpi = 600)
```

```{r}
#not using right now!
t_TreeTemp_r2_values <- transb_corr_long %>%
  drop_na(well_diam_diff, mean_tree_temp) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, mean_tree_temp, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3))) # Create label for plotting

```

```{r}
# Tree Temp
# Compute R^2 for each tree_id
t_TreeTemp_results <- transb_corr_long %>%
  drop_na(well_diam_diff, mean_tree_temp) %>%
  group_by(burn_status, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, mean_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
transb_TreeTemp_corr_plot <- ggplot(transb_corr_long, aes(x = mean_tree_temp, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Tree Temperature",
    x = "Tree Temperature (°C)",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_TreeTemp_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_TreeTemp_corr_plot
```

```{r}
ggsave("transb_TreeTemp_corr_plot.png", plot = transb_TreeTemp_corr_plot, dpi = 600)
```

```{r}
#not using right now!
t_NetSW_r2_values <- transb_corr_long %>%
  drop_na(well_diam_diff, SWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, SWnet_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))  # Create label for plotting
```

```{r}
# Net SW Correlation
# Compute R^2 for each tree_id
t_NetSW_results <- transb_corr_long %>%
  drop_na(well_diam_diff, SWnet_Avg) %>%
  group_by(burn_status, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
transb_NetSW_corr_plot <- ggplot(transb_corr_long, aes(x = SWnet_Avg, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Net SW",
    x = "Daily Net SW (W/m^2))",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetSW_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NetSW_corr_plot
```

```{r}
ggsave("transb_NetSW_corr_plot.png", plot = transb_NetSW_corr_plot, dpi = 600)
```

```{r}
#not using right now!
t_NetLW_r2_values <- transb_corr_long %>%
  drop_na(well_diam_diff, LWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, LWnet_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))  # Create label for plotting
```

```{r}
# Net LW Correlation
# Compute R^2 for each tree_id
t_NetLW_results <- transb_corr_long %>%
  drop_na(well_diam_diff, LWnet_Avg) %>%
  group_by(burn_status, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
transb_NetLW_corr_plot <- ggplot(transb_corr_long, aes(x = LWnet_Avg, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Net LW",
    x = "Daily Net LW (W/m^2))",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
   geom_text(data = t_NetLW_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NetLW_corr_plot
```

```{r}
ggsave("transb_NetLW_corr_plot.png", plot = transb_NetLW_corr_plot, dpi = 600)
```

```{r}
#not using right now!
t_NR_r2_values <- transb_corr_long %>%
  drop_na(well_diam_diff, NR_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, NR_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))  # Create label for plotting
```

```{r}
# Total net Radiation Correlation
# Compute R^2 for each tree_id
t_NR_results <- transb_corr_long %>%
  drop_na(well_diam_diff, NR_Avg) %>%
  group_by(burn_status, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
transb_NR_corr_plot <- ggplot(transb_corr_long, aes(x = NR_Avg, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Total Net Radiation ",
    x = "Daily Mean Net Radiation (W/m^2)",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NR_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)


transb_NR_corr_plot
```

```{r}
ggsave("transb_NR_corr_plot.png", plot = transb_NR_corr_plot, dpi = 600)
```

```{r}
#not using right now
t_SD_r2_values <- transb_corr_long %>%
  drop_na(well_diam_diff, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam_diff, maximum_depth_cm, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))  # Create label for plotting
```

```{r}
# Snow Depth Correlation
# Compute R^2 for each tree_id
t_SD_results <- transb_corr_long %>%
  drop_na(well_diam_diff, maximum_depth_cm) %>%
  group_by(tree_id, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
transb_SD_corr_plot <- ggplot(transb_corr_long, aes(x = maximum_depth_cm, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id + season) +  # Separate by tree_id
  labs(
    title = "TSZ: Snow Depth",
    x = "Daily Maximum Snow Depth (cm)",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_SD_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_SD_corr_plot
```

```{r}
ggsave("transb_SD_corr_plot.png", plot = transb_SD_corr_plot, dpi = 600)
```

```{r}
# Weather station SD Correlation
# Compute R^2 for each tree_id
t_wxSD_results <-transb_corr_long %>%
  drop_na(well_diam_diff, SnowDepth_cm) %>%
  group_by(tree_id, season) %>%
  summarize(
    cor_test = list(cor.test(well_diam_diff, SnowDepth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot with facet_wrap
transb_wxSD_corr_plot <- ggplot(transb_corr_long, aes(x = SnowDepth_cm, y = well_diam_diff, color = tree_id)) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id + season) +  # Separate by tree_id
  labs(
    title = "TSZ: Snow Depth",
    x = "Wx Station Daily Snow Depth (cm)",
    y = "Well Diameter Difference (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_wxSD_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_wxSD_corr_plot
```

## New Approach

-   seeing if I just correlate the daily well diameter with weather station variables changes the correlation results

### PSZ

```{r}
persb_corr_data_accu <- comb_persb_treewell_diam_fullseason %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  filter(date < "2024-05-06")
```

```{r}
persb_corr_data_abla<- comb_persb_treewell_diam_fullseason %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  filter(date >= "2024-05-06")
```

```{r}
#not using right now!
p_AirTC_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, AirTC_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam, AirTC_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))
```

```{r}
# AirTC Correlation
# Compute R^2 for each tree_id
p_AirTC_accu_results <- persb_corr_data_accu %>%
  drop_na(well_diam, AirTC_Avg) %>%
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )


# Scatterplot
persb_AirTC_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = AirTC_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Air Temp",
    x = "Air Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_AirTC_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_AirTC_corr_plot_accu
```

```{r}
ggsave("persb_AirTC_corr_plot_accu.png", plot = persb_AirTC_corr_plot_accu, dpi = 600)
```

```{r}
# Compute R^2 for each tree_id
p_AirTC_abla_results <- persb_corr_data_abla %>%
  drop_na(well_diam, AirTC_Avg) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) # Create label for plotting

# Scatterplot
persb_AirTC_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = AirTC_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Air Temp",
    x = "Air Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_AirTC_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_AirTC_corr_plot_abla
```

```{r}
ggsave("persb_AirTC_corr_plot_abla.png", plot = persb_AirTC_corr_plot_abla, dpi = 600)
```

```{r}
# AirTC Correlation
# Compute R^2 for each tree_id
p_TreeTemp_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, mean_tree_temp) %>%
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, mean_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_TreeTemp_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = mean_tree_temp, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Tree Temperature",
    x = "Tree Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_TreeTemp_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_TreeTemp_corr_plot_accu
```

```{r}
ggsave("persb_TreeTemp_corr_plot_accu.png", plot = persb_TreeTemp_corr_plot_accu, dpi = 600)
```

```{r}
p_TreeTemp_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, mean_tree_temp) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, mean_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_TreeTemp_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = mean_tree_temp, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Tree Temperature",
    x = "Tree Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_TreeTemp_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_TreeTemp_corr_plot_abla
```

```{r}
ggsave("persb_TreeTemp_corr_plot_abla.png", plot = persb_TreeTemp_corr_plot_abla, dpi = 600)
```

\*\* when I include only ablation dates, the R\^2 value increases substantially

```{r}
# SWnet Correlation
# Compute R^2 for each tree_id
p_NetSW_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, SWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 


# Scatterplot
persb_NetSW_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = SWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Net SW",
    x = "Net SW (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NetSW_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)
persb_NetSW_corr_plot_accu
```

```{r}
ggsave("persb_NetSW_corr_plot_accu.png", plot = persb_NetSW_corr_plot_accu, dpi = 600)
```

```{r}
# SWnet Correlation
# Compute R^2 for each tree_id
p_NetSW_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, SWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_NetSW_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = SWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Net SW",
    x = "Net SW (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NetSW_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NetSW_corr_plot_abla
```

```{r}
ggsave("persb_NetSW_corr_plot_abla.png", plot = persb_NetSW_corr_plot_abla, dpi = 600)
```

```{r}
# LWnet Correlation
# Compute R^2 for each tree_id
p_NetLW_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, LWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_NetLW_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = LWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Net LW",
    x = "Net LW (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NetLW_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NetLW_corr_plot_accu
```

```{r}
ggsave("persb_NetLW_corr_plot_accu.png", plot = persb_NetLW_corr_plot_accu, dpi = 600)
```

```{r}
# LWnet Correlation
# Compute R^2 for each tree_id
p_NetLW_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, LWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_NetLW_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = LWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Net LW",
    x = "Net LW (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NetLW_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NetLW_corr_plot_abla
```

```{r}
ggsave("persb_NetLW_corr_plot_abla.png", plot = persb_NetLW_corr_plot_abla, dpi = 600)
```

```{r}
# Net Radiation Correlation
# Compute R^2 for each tree_id
p_NR_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, NR_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
persb_NR_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = NR_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Total Net Rad",
    x = "Net Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NR_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NR_corr_plot_accu
```

```{r}
ggsave("persb_NR_corr_plot_accu.png", plot = persb_NR_corr_plot_accu, dpi = 600)
```

```{r}
# Net Radiation Correlation
# Compute R^2 for each tree_id
p_NR_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, NR_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
persb_NR_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = NR_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Total Net Rad",
    x = "Net Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NR_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NR_corr_plot_abla
```

```{r}
ggsave("persb_NR_corr_plot_abla.png", plot = persb_NR_corr_plot_abla, dpi = 600)
```

```{r}
# Snow Depth Correlation
# Compute R^2 for each tree_id
p_SD_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
persb_SD_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = maximum_depth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Snow Depth",
    x = "Daily Max Snow Depth (cm))",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_SD_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_SD_corr_plot_accu
```

```{r}
ggsave("persb_SD_corr_plot_accu.png", plot = persb_SD_corr_plot_accu, dpi = 600)
```

```{r}
# Snow Depth Correlation
# Compute R^2 for each tree_id
p_SD_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
persb_SD_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = maximum_depth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Snow Depth",
    x = "Daily Max Snow Depth (cm))",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_SD_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_SD_corr_plot_abla
```

```{r}
ggsave("persb_SD_corr_plot_abla.png", plot = persb_SD_corr_plot_abla, dpi = 600)
```

### TSZ

```{r}
transb_corr_data_accu <- long_transb_treewell_diams_fullseason_V2 %>%
  # Join with weather data
  inner_join(filtered_daily_transb_wx_15min_r, by = "date") %>%
  inner_join(transb_daily_treetemp_data, by = "date") %>%
  filter(date < "2024-04-01")
```

```{r}
transb_corr_data_abla <- long_transb_treewell_diams_fullseason_V2 %>%
  # Join with weather data
  inner_join(filtered_daily_transb_wx_15min_r, by = "date") %>%
  inner_join(transb_daily_treetemp_data, by = "date") %>%
  filter(date >= "2024-04-01" & date <= "2024-04-25")
```

```{r}
# AirTC Correlation
# Compute R^2 for each tree_id
t_AirTC_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, AirTC_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_AirTC_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = AirTC_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Air Temp",
    x = "Air Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_AirTC_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_AirTC_corr_plot_accu
```

```{r}
ggsave("transb_AirTC_corr_plot_accu.png", plot = transb_AirTC_corr_plot_accu, dpi = 600)
```

```{r}
# AirTC Correlation
# Compute R^2 for each tree_id
t_AirTC_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, AirTC_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_AirTC_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = AirTC_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Air Temp",
    x = "Air Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_AirTC_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_AirTC_corr_plot_abla
```

```{r}
ggsave("transb_AirTC_corr_plot_abla.png", plot = transb_AirTC_corr_plot_abla, dpi = 600)
```

```{r}
# Tree Temp Correlation
# Compute R^2 for each tree_id
t_TreeTemp_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, mean_tree_temp) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, mean_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_TreeTemp_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = mean_tree_temp, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Tree Temp",
    x = "Tree Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_TreeTemp_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_TreeTemp_corr_plot_accu
```

```{r}
ggsave("transb_TreeTemp_corr_plot_accu.png", plot = transb_TreeTemp_corr_plot_accu, dpi = 600)
```

```{r}
# Tree Temp Correlation
# Compute R^2 for each tree_id
t_TreeTemp_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, mean_tree_temp) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, mean_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_TreeTemp_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = mean_tree_temp, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Tree Temp",
    x = "Tree Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_TreeTemp_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_TreeTemp_corr_plot_abla
```

```{r}
ggsave("transb_TreeTemp_corr_plot_abla.png", plot = transb_TreeTemp_corr_plot_abla, dpi = 600)
```

```{r}
# Net SW Correlation
# Compute R^2 for each tree_id
t_NetSW_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, SWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NetSW_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = SWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Net SW Radiation",
    x = "Net SW Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetSW_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NetSW_corr_plot_accu
```

```{r}
ggsave("transb_NetSW_corr_plot_accu.png", plot = transb_NetSW_corr_plot_accu, dpi = 600)
```

```{r}
# Net SW Correlation
# Compute R^2 for each tree_id
t_NetSW_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, SWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NetSW_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = SWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Net SW Radiation",
    x = "Net SW Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetSW_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NetSW_corr_plot_abla
```

```{r}
ggsave("transb_NetSW_corr_plot_abla.png", plot = transb_NetSW_corr_plot_abla, dpi = 600)
```

```{r}
# Net LW Correlation
# Compute R^2 for each tree_id
t_NetLW_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, LWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NetLW_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = LWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Net LW Radiation",
    x = "Net LW Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetLW_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NetLW_corr_plot_accu
```

```{r}
ggsave("transb_NetLW_corr_plot_accu.png", plot = transb_NetLW_corr_plot_accu, dpi = 600)
```

```{r}
# Net LW Correlation
# Compute R^2 for each tree_id
t_NetLW_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, LWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NetLW_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = LWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Net LW Radiation",
    x = "Net LW Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetLW_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NetLW_corr_plot_abla
```

```{r}
ggsave("transb_NetLW_corr_plot_abla.png", plot = transb_NetLW_corr_plot_abla, dpi = 600)
```

```{r}
# Net Radiation Correlation
# Compute R^2 for each tree_id
t_NR_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, NR_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NR_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = NR_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Net Radiation",
    x = "Total Net Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetLW_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NR_corr_plot_accu
```

```{r}
ggsave("transb_NR_corr_plot_accu.png", plot = transb_NR_corr_plot_accu, dpi = 600)
```

```{r}
# Net Radiation Correlation
# Compute R^2 for each tree_id
t_NR_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, NR_Avg) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NR_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = NR_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Net Radiation",
    x = "Total Net Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetLW_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NR_corr_plot_abla
```

```{r}
ggsave("transb_NR_corr_plot_abla.png", plot = transb_NR_corr_plot_abla, dpi = 600)
```

```{r}
# Snow Depth Correlation
# Compute R^2 for each tree_id
t_SD_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_SD_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = maximum_depth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Snow Depth",
    x = "Daily Maximum Snow Depth (cm)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_SD_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_SD_corr_plot_accu
```

```{r}
ggsave("transb_SD_corr_plot_accu.png", plot = transb_SD_corr_plot_accu, dpi = 600)
```

```{r}
# Snow Depth Correlation
# Compute R^2 for each tree_id
t_SD_r2_values_abla <- transb_corr_data_abla%>%
  drop_na(well_diam, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(burn_status) %>%
  summarize(
    cor_test = list(cor.test(well_diam, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_SD_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = maximum_depth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Snow Depth",
    x = "Daily Maximum Snow Depth (cm)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_SD_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_SD_corr_plot_abla
```

```{r}
ggsave("transb_SD_corr_plot_abla.png", plot = transb_SD_corr_plot_abla, dpi = 600)
```

## Cumulative Comparisons

### PSZ

## New Snow Depth vs Diameter Scatterplots

PSZ

```{r}
persb_corr_data_abla_V2 <- persb_corr_data_abla %>%
  filter(date >= "2024-05-06")
```

```{r}
p_SD_r2_values_abla_V2 <- persb_corr_data_abla_V2 %>%
  drop_na(well_diam, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R² (square of correlation coefficient)
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    R2_label = paste0("R² = ", round(R2, 3), ", p = ", signif(p_value, 3))
  ) %>%
  select(-cor_test)  # Remove the list column

 # Create label for plotting

# Scatterplot
persb_SD_abla_wellsnowdepth <- ggplot(persb_corr_data_abla_V2, aes(x = maximum_depth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1, ncol = 4) +  # Separate by tree_id
  labs(
    title = "a) PSZ",
    x = NULL,
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_y_continuous(limits = c(NA, 200)) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_SD_r2_values_abla_V2, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_SD_abla_wellsnowdepth
```

TSZ

```{r}
transb_corr_data_abla_V2 <- transb_corr_data_abla %>%
  filter(date >= "2024-04-01" & date <= "2024-04-25")
```

```{r}
t_SD_r2_values_abla_V2 <- transb_corr_data_abla_V2 %>%
  drop_na(well_diam, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam, maximum_depth_cm, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3))) # Create label for plotting

# Scatterplot
transb_SD_abla_wellsnowdepth <- ggplot(transb_corr_data_abla_V2, aes(x = maximum_depth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1, ncol = 4) +  # Separate by tree_id
  labs(
    title = "b) TSZ",
    x = "Maximum Daily Snow Depth (cm)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_y_continuous(limits = c(NA, 200)) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_SD_r2_values_abla_V2, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_SD_abla_wellsnowdepth
```

```{r}
comb_snowdepth_scatterplot_V3 <- ggarrange(persb_SD_abla_wellsnowdepth, transb_SD_abla_wellsnowdepth, nrow = 2, ncol = 1, common.legend = TRUE, legend = "bottom")

comb_snowdepth_scatterplot_V3
```

```{r}
ggsave(filename = "comb_snowdepth_scatterplot_V3.png", plot = comb_snowdepth_scatterplot_V3, dpi = 600)

```
