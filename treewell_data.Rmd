---
title: "treewell_data"
author: "Erika Lee"
date: "2024-05-16"
output: html_document
---

```{r setup, warnings='hide',message=FALSE}
library(tidyverse) # Package with dplyr, tibble, readr, and others to help clean coding
library(knitr) #Makes nice tables
library(kableExtra) #Makes even nicer tables
library(lubridate) #Makes working with dates easier
library(tidyr)
library(readxl)#Makes multiple simultaneous models easier
library(plotly)
library(rstatix)
```

```{r}
setwd("/Volumes/wcnr-network/Research/Kampf/Private/field_data")
```

## Download Prep

Download Data

```{r}
treewell_composite=read_excel("nsf/treewell_data/treewell_data_r.xlsx")
```

## Tidying Dataframe

```{r}
#adjusting date/time, although there is technically no time in this data
treewell_clean <- treewell_composite %>%
  mutate(date = ymd(date)) %>%
  #adding in a column with site name
  mutate(site = if_else(str_detect(tree_ID, "tt"), "transitional", "persistent")) %>%
  #reorder columns
  select(c(tree_ID, site, everything()))
```

```{r}
treewell_zeroed <- treewell_clean %>%
  mutate(across(-(1:4), ~ ifelse(is.na(.), 0, .))) %>%
  rename(zone = site)
```

Creating Dataframes for 5 and 10 cm increment measurements

```{r}
#5cm dataframe
treewell_5cm <- treewell_zeroed %>%
  filter(increments_cm==5)

#10cm dataframe
treewell_10cm <- treewell_zeroed %>%
  filter(increments_cm==10)

#persistent dataframe
treewell_pers <- treewell_zeroed %>%
  filter(zone == "persistent")

#transitional dataframe
treewell_trans <- treewell_zeroed %>%
  filter(zone == "transitional")
```

## Data Exploration

```{r}
#initial visualization - all data histogram
treewell_d_hist <- ggplot(data = treewell_zeroed, aes(x = treewell_diameter)) +
  geom_histogram(binwidth = 5, fill = "#2166AC", color = "black") +
  labs(
  #  title = "Histogram of Treewell Diameter",
    x = "Treewell Diameter (cm)",
    y = "Frequency"
  ) +
  facet_wrap(~date) +
  theme_bw()

print(treewell_d_hist)

#initial visualization - all data scatterplot w/ correlation
dbh_treewell_diameter_plot <- ggplot(data = treewell_zeroed, aes(y = treewell_diameter, x = dbh)) +
  geom_smooth(method = 'lm', se = TRUE, color = "grey") +
  geom_point(aes(color = zone)) +
  labs(
   # title = "Well vs Tree Diameter",
    y = "Well Diameter (cm)",
    x = "Tree Diameter (cm)"
  ) +
  theme_bw() +
  scale_color_manual(values = c(
    "persistent" = "#2166AC",
    "transitional" = "#D95F02"))

ggplotly(dbh_treewell_diameter_plot)
```

## Correlation Test

```{r}
#calculate pearsons correlation coefficient
correlation_result <- cor.test(treewell_zeroed$treewell_diameter, treewell_zeroed$dbh)

print(correlation_result)
```

## Aspect Data Exploration

```{r}
#pivoting the clean dataset longer to have aspect included
treewell_long <- treewell_zeroed %>%
  select(-c(tree_mort, site)) %>%
  pivot_longer(cols = c(d_edge_N, d_edge_E, d_edge_S, d_edge_W), names_to = "d_edge_aspect", values_to = "d_edge_data") %>%
  pivot_longer(cols = c(sd_tree_N, sd_tree_E, sd_tree_S, sd_tree_W), names_to = "sd_tree_aspect", values_to = "sd_tree_data") %>%
  pivot_longer(cols = c(sd_1_N, sd_1_E, sd_1_S, sd_1_W), names_to = "sd_1_aspect", values_to = "sd_1_data") %>%
  pivot_longer(cols = c(sd_2_N, sd_2_E, sd_2_S, sd_2_W), names_to = "sd_2_aspect", values_to = "sd_2_data") %>%
  pivot_longer(cols = c(sd_3_N, sd_3_E, sd_3_S, sd_3_W), names_to = "sd_3_aspect", values_to = "sd_3_data") %>%
  #adjusting the variable names in the measurement rows
  mutate(d_edge_aspect = case_when(
    str_detect(d_edge_aspect, "N") ~ "N",
    str_detect(d_edge_aspect, "E") ~ "E",
    str_detect(d_edge_aspect, "S") ~ "S",
    str_detect(d_edge_aspect, "W") ~ "W",
    TRUE ~ d_edge_aspect
  )) %>%
  mutate(sd_tree_aspect = case_when(
    str_detect(sd_tree_aspect, "N") ~ "N",
    str_detect(sd_tree_aspect, "E") ~ "E",
    str_detect(sd_tree_aspect, "S") ~ "S",
    str_detect(sd_tree_aspect, "W") ~ "W",
    TRUE ~ sd_tree_aspect
  )) %>%
  mutate(sd_1_aspect = case_when(
    str_detect(sd_1_aspect, "N") ~ "N",
    str_detect(sd_1_aspect, "E") ~ "E",
    str_detect(sd_1_aspect, "S") ~ "S",
    str_detect(sd_1_aspect, "W") ~ "W",
    TRUE ~ sd_1_aspect,
  )) %>%
  mutate(sd_2_aspect = case_when(
    str_detect(sd_2_aspect, "N") ~ "N",
    str_detect(sd_2_aspect, "E") ~ "E",
    str_detect(sd_2_aspect, "S") ~ "S",
    str_detect(sd_2_aspect, "W") ~ "W",
    TRUE ~ sd_2_aspect,
  )) %>%
  mutate(sd_3_aspect = case_when(
    str_detect(sd_3_aspect, "N") ~ "N",
    str_detect(sd_3_aspect, "E") ~ "E",
    str_detect(sd_3_aspect, "S") ~ "S",
    str_detect(sd_3_aspect, "W") ~ "W",
    TRUE ~ sd_3_aspect,
  ))
```

```{r}
#creating aspect dataframes
treewell_n <- treewell_zeroed %>%
  select(c(tree_ID, zone, date, tree_mort, dbh, treewell_diameter, d_edge_N, sd_tree_N, sd_1_N, sd_2_N, sd_3_N, increments_cm))

treewell_e <- treewell_zeroed %>%
  select(c(tree_ID, zone, date, tree_mort, dbh, treewell_diameter, d_edge_E, sd_tree_E, sd_1_E, sd_2_E, sd_3_E, increments_cm))

treewell_s <- treewell_zeroed %>%
  select(c(tree_ID, zone, date, tree_mort, dbh, treewell_diameter, d_edge_S, sd_tree_S, sd_1_S, sd_2_S, sd_3_S, increments_cm))

treewell_w <- treewell_zeroed %>%
  select(c(tree_ID, zone, date, tree_mort, dbh, treewell_diameter, d_edge_W, sd_tree_W, sd_1_W, sd_2_W, sd_3_W, increments_cm))
```

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

Chunk of work from 9/9/24 - exported plots

Exploring aspect comparison and site comparison

```{r}
#creating a long dataframe that is zeroed - making individual dataframes for aspects first, then joining
treewell_n_long <- treewell_n %>%
  pivot_longer(cols = starts_with("d_edge"), 
    names_to = "measurement", 
    values_to = "well_diameter",
    values_drop_na = TRUE
  ) %>%
  mutate(aspect = "north") %>%
  rename(treewell_diameter_full = treewell_diameter) %>%
  select(tree_ID, zone, date, tree_mort, aspect, dbh, treewell_diameter_full, measurement, well_diameter, increments_cm)

treewell_e_long <- treewell_e %>%
  pivot_longer(cols = starts_with("d_edge"), 
    names_to = "measurement", 
    values_to = "well_diameter",
    values_drop_na = TRUE
  ) %>%
  mutate(aspect = "east") %>%
  rename(treewell_diameter_full = treewell_diameter) %>%
  select(tree_ID, zone, date, tree_mort, aspect, dbh, treewell_diameter_full, measurement, well_diameter, increments_cm)

treewell_s_long <- treewell_s %>%
  pivot_longer(cols = starts_with("d_edge"), 
    names_to = "measurement", 
    values_to = "well_diameter",
    values_drop_na = TRUE
  ) %>%
  mutate(aspect = "south") %>%
  rename(treewell_diameter_full = treewell_diameter) %>%
  select(tree_ID, zone, date, tree_mort, aspect, dbh, treewell_diameter_full, measurement, well_diameter, increments_cm)

treewell_w_long <- treewell_w %>%
  pivot_longer(cols = starts_with("d_edge"), 
    names_to = "measurement", 
    values_to = "well_diameter",
    values_drop_na = TRUE
  ) %>%
  mutate(aspect = "west") %>%
  rename(treewell_diameter_full = treewell_diameter) %>%
  select(tree_ID, zone, date, tree_mort, aspect, dbh, treewell_diameter_full, measurement, well_diameter, increments_cm)
```

```{r}
#full join of new dataframes
treewell_long_may <- treewell_n_long %>%
  full_join(treewell_e_long) %>%
  full_join(treewell_s_long) %>%
  full_join(treewell_w_long) %>%
  filter(date == "2024-05-03")

trans_treewell_long_aspect_may <- treewell_long_may %>%
  filter(zone == "transitional")

pers_treewell_long_aspect_may <- treewell_long_may %>%
  filter(zone == "persistent")

#transitional april dataframe
treewell_long_april <- treewell_n_long %>%
  full_join(treewell_e_long) %>%
  full_join(treewell_s_long) %>%
  full_join(treewell_w_long) %>%
  filter(date == "2024-04-12")

trans_treewell_long_aspect_april <- treewell_long_april %>%
  filter(zone == "transitional")
```

```{r}
#plotting aspect in points
##transitional
trans_treewell_aspect_may_plot <- ggplot(data = trans_treewell_long_aspect_may) +
  geom_point(aes(x = dbh, y = well_diameter, color = zone)) +
  theme_bw() +
  geom_smooth(aes(x = dbh, y = well_diameter), method = 'lm', se = TRUE, color = "grey") +
  labs(title = "Transitional May", x = "Tree Diameter (cm)", y = "Well Diameter (cm)") +
  theme_bw() +  # Use a minimal theme for a clean look
  facet_wrap(~aspect) +
  coord_cartesian(ylim = c(0, 100), xlim = c(0,30)) +
  scale_color_manual(values = c(
    "persistent" = "#2166AC",
    "transitional" = "#D95F02")) +
  theme(legend.position = "none")

trans_treewell_aspect_may_plot

##persistent
pers_treewell_aspect_may_plot <- ggplot(data = pers_treewell_long_aspect_may) +
  geom_point(aes(x = dbh, y = well_diameter, color = zone)) +
  theme_bw() +
  geom_smooth(aes(x = dbh, y = well_diameter), method = 'lm', se = TRUE, color = "grey") +
  labs(title = "Persistent May", x = "Tree Diameter (cm)", y = "Well Diameter (cm)") +
  theme_bw() +  # Use a minimal theme for a clean look
  facet_wrap(~aspect) +
  coord_cartesian(ylim = c(0, 100), xlim = c(0,30)) +
  scale_color_manual(values = c(
    "persistent" = "#2166AC",
    "transitional" = "#D95F02")) +
  theme(legend.position = "none")

pers_treewell_aspect_may_plot

##transitional april plot
trans_treewell_aspect_april_plot <- ggplot(data = trans_treewell_long_aspect_april) +
  geom_point(aes(x = dbh, y = well_diameter, color = zone)) +
  theme_bw() +
  geom_smooth(aes(x = dbh, y = well_diameter), method = 'lm', se = TRUE, color = "grey") +
  labs(title = "Transitional April", x = "Tree Diameter (cm)", y = "Well Diameter (cm)") +
  theme_bw() +  # Use a minimal theme for a clean look
  facet_wrap(~aspect) +
  #coord_cartesian(ylim = c(0, 45))
  coord_cartesian(ylim = c(0, 100), xlim = c(0,30)) +
    scale_color_manual(values = c(
    "persistent" = "#2166AC",
    "transitional" = "#D95F02")) +
  theme(legend.position = "none")

trans_treewell_aspect_april_plot

```

```{r}
library(ggpubr)
#arranging plots
comb_treewell_aspect_plot <- ggarrange(trans_treewell_aspect_april_plot, pers_treewell_aspect_may_plot, trans_treewell_aspect_may_plot, ncol = 3, nrow = 1)

comb_treewell_aspect_plot
```

Same plots as above, but with free x and y scales!

```{r}
trans_treewell_aspect_may_plot_freexy <- ggplot(data = trans_treewell_long_aspect_may) +
  geom_point(aes(x = dbh, y = well_diameter, color = zone)) +
  theme_bw() +
  geom_smooth(aes(x = dbh, y = well_diameter), method = 'lm', se = TRUE, color = "grey") +
  labs(title = "Transitional May", x = "Tree Diameter (cm)", y = "Well Diameter (cm)") +
  theme_bw() +  # Use a minimal theme for a clean look
  facet_wrap(~aspect) +
  scale_color_manual(values = c(
    "persistent" = "#2166AC",
    "transitional" = "#D95F02")) +
  theme(legend.position = "none")

trans_treewell_aspect_may_plot_freexy

##persistent
pers_treewell_aspect_may_plot_freexy <- ggplot(data = pers_treewell_long_aspect_may) +
  geom_point(aes(x = dbh, y = well_diameter, color = zone)) +
  theme_bw() +
  geom_smooth(aes(x = dbh, y = well_diameter), method = 'lm', se = TRUE, color = "grey") +
  labs(title = "Persistent May", x = "Tree Diameter (cm)", y = "Well Diameter (cm)") +
  theme_bw() +  # Use a minimal theme for a clean look
  facet_wrap(~aspect) +
  scale_color_manual(values = c(
    "persistent" = "#2166AC",
    "transitional" = "#D95F02")) +
  theme(legend.position = "none")

pers_treewell_aspect_may_plot_freexy

##transitional april plot
trans_treewell_aspect_april_plot_freexy <- ggplot(data = trans_treewell_long_aspect_april) +
  geom_point(aes(x = dbh, y = well_diameter, color = zone)) +
  theme_bw() +
  geom_smooth(aes(x = dbh, y = well_diameter), method = 'lm', se = TRUE, color = "grey") +
  labs(title = "Transitional April", x = "Tree Diameter (cm)", y = "Well Diameter (cm)") +
  theme_bw() +  # Use a minimal theme for a clean look
  facet_wrap(~aspect) +
    scale_color_manual(values = c(
    "persistent" = "#2166AC",
    "transitional" = "#D95F02")) +
  theme(legend.position = "none")

trans_treewell_aspect_april_plot_freexy
```

```{r}
#combining freexy plots
comb_treewell_aspect_plot_freexy <- ggarrange(trans_treewell_aspect_april_plot_freexy, pers_treewell_aspect_may_plot_freexy, trans_treewell_aspect_may_plot_freexy, ncol = 3, nrow = 1)

comb_treewell_aspect_plot_freexy
```

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

Plotting Aspect Scatter plot individually, then combining

Zone-specific Plots

```{r}
#boxplots by date
treewell_boxplot <- ggplot(data = treewell_zeroed, aes(x = dbh, y = treewell_diameter, fill = site)) + 
  geom_boxplot() + 
  theme_bw() +
  labs(title = "Well Diameter by Tree Diameter", x = "Tree Diameter (cm)", y = "Well Diameter (cm)") +
  facet_wrap(~date)

treewell_boxplot
```

Point Plots

\*\* not sure this is very helpful? Try putting regression lines on them.

\*\* can also plot snow depths with this, if needed?

5/13 Histogram Plots

```{r}
#creating dataframe for only may
treewell_maydata <- treewell_zeroed %>%
  filter(date == "2024-05-03")

#treewell diameter histogram
treewell_may_hist <- ggplot(data = treewell_maydata, aes(x = treewell_diameter)) +
  geom_histogram(binwidth = 5, fill = "#2166AC", color = "black") +
  labs(
    #title = "Histogram of Treewell Diameter in May",
    x = "Full Treewell Diameter (cm)",
    y = "Frequency"
  ) +
  facet_wrap(~zone) +
  theme_bw()

print(treewell_may_hist)

treediameter_hist <- ggplot(data = treewell_maydata, aes(x = dbh)) +
  geom_histogram(binwidth = 5, fill = "#2166AC", color = "black") +
  labs(
    #title = "Histogram of Treewell Diameter in May",
    x = "Tree Diameter (cm)",
    y = "Frequency"
  ) +
  facet_wrap(~zone) +
  theme_bw()

print(treediameter_hist)
```
