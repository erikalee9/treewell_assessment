---
title: "snowcam_treewell_data"
output: html_document
date: "2024-12-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse) # Package with dplyr, tibble, readr, and others to help clean coding
library(knitr) #Makes nice tables
library(kableExtra) #Makes even nicer tables
library(lubridate) #Makes working with dates easier
library(tidyr)
library(readxl)#Makes multiple simultaneous models easier
library(plotly)
library(rstatix)
library(ggpubr)
library(ggpmisc)
library(zoo)

setwd("/Volumes/wcnr-network/Research/Kampf/Private/field_data")
```

## Data Download

```{r}
transb_snowcam_treewell_data = read_csv("nsf/treewell_data/snowcam_data/105E_transb_tree_well_diams_V2.csv")

persb_highmort_snowcam_treewell_data = read_csv("nsf/treewell_data/snowcam_data/LP_highmort_persb_tree_well_diams_V2.csv")

persb_lowmort_snowcam_treewell_data = read_csv("nsf/treewell_data/snowcam_data/LP_lowmort_persb_tree_well_diams_V2.csv")
```

```{r}
#snowcamera snow depth data
transb_snowcam_depth_data = read_csv("nsf/camera_snowdepths/2024_105E_transb_snowdepths.csv")

persb_highmort_snowcam_depth_data = read_csv("nsf/camera_snowdepths/2024_persb_lp_highmort_east_snowdepths.csv")

persb_lowmort_snowcam_depth_data = read_csv("nsf/camera_snowdepths/2024_persb_lp_lowmort_snowdepths.csv")
```

## Data Wrangling

```{r}
#edited snowcam data to match the timeline of the well data
transb_snowcam_depth_edited <- transb_snowcam_depth_data %>%
  filter(date >= "2024-04-01" & date <= "2024-05-09") %>%
  rename(burn_status = "mortality") %>%
  select(date, burn_status, zone, "maximum_depth(cm)", treewell_developed, conditions) %>%
  mutate(zone = "TSZ") %>%
  rename(max_depth_cm = "maximum_depth(cm)")

persb_highmort_snowcam_depth_edited <- persb_highmort_snowcam_depth_data %>%
  filter(date >= "2024-04-15" & date <= "2024-05-18") %>%
  select(date, mortality, burn_status, zone, max_depth_cm, treewell_developement, conditions) %>%
  mutate(zone = "PSZ") 

persb_lowmort_snowcam_depth_edited <- persb_lowmort_snowcam_depth_data %>%
  filter(date >= "2024-04-15" & date <= "2024-05-31") %>%
  select(date, mortality, burn_status, zone, max_depth_cm, conditions) %>%
  mutate(zone = "PSZ") 
```

```{r}
#snowcam treewell data edited
transb_snowcam_treewell_data_edited <- transb_snowcam_treewell_data %>%
  mutate(date = as.Date(date, format = "%m/%d/%y")) %>%
  mutate(mortality = "mixed") %>%
  select(date, zone, burn_status, mortality, tree_id, tree_diam_cm, well_diam_cm)

persb_highmort_snowcam_treewell_data_edited <- persb_highmort_snowcam_treewell_data %>%
  mutate(date = as.Date(date, format = "%m/%d/%y")) %>%
  select(date, zone, burn_status, mortality, tree_id, tree_diam_cm, well_diam_cm)

persb_lowmort_snowcam_treewell_data_edited <- persb_lowmort_snowcam_treewell_data %>%
  mutate(date = as.Date(date, format = "%m/%d/%y")) %>%
  select(date, zone, burn_status, mortality, everything()) %>%
  select(date, zone, burn_status, mortality, tree_id, tree_diam_cm, well_diam_cm)
```

```{r}
#combined treewell dataframe 
full_snowcam_treewell_data <- rbind(persb_highmort_snowcam_treewell_data_edited, persb_lowmort_snowcam_treewell_data_edited, transb_snowcam_treewell_data_edited)
```

### Weather Data

```{r}
transb_wx_15min_r <- read_csv('nsf/trans_burned/trans_burned_wx_15min_r.csv') %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                               datetime = with_tz(datetime, tz = 'MST'))

transub_wx_15min_r <- read_csv('nsf/trans_unburned/trans_unburned_wx_15min_r.csv') %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                               datetime = with_tz(datetime, tz = 'MST'))

persb_wx_hourly_r <- read_csv('nsf/pers_burned/pers_burned_wx_hourly_r.csv') %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                               datetime = with_tz(datetime, tz = 'MST'))

#persub_wx_15min_r <- read_csv('nsf/pers_unburned/pers_unburned_wx_15min_r.csv') %>%
  #mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                       #        datetime = with_tz(datetime, tz = 'MST'))

#use hourly unburned and burned for PSZ
persub_wx_hourly_r <- read_csv('nsf/pers_unburned/pers_unburned_wx_hourly_r.csv') %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                               datetime = with_tz(datetime, tz = 'MST'))
  
p_b_solar_times <- read_csv("nsf/treetemp_data/p_b_solar_times.csv") %>%
  mutate(
    sunrise = as.POSIXct(sunrise, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"), # Assuming data is in UTC
    sunset = as.POSIXct(sunset, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"),
    sunrise = with_tz(sunrise, "MST"),  # Convert to MST timezone
    sunset = with_tz(sunset, "MST")     # Convert to MST timezone
  )
```

```{r}
#filtered weather data to the datetime range that we need and added phase and NR_Avg_calcs
filtered_transb_wx_15min <- transb_wx_15min_r %>%
  mutate(day = as.Date.POSIXct(datetime, tz = "MST"),
    month = as.numeric(format(datetime, "%m")),
    datetime = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime >= as.POSIXct("2024-02-02 00:00:00", tz = "MST") & 
         datetime < as.POSIXct("2024-07-01 00:00:00", tz = "MST")) %>%
  inner_join(p_b_solar_times, by = "day") %>%
  #creating a phase column that parses by daily sunrise/sunset times
  mutate(
    phase = case_when(
      datetime >= sunrise & datetime < sunset ~ "day",
      datetime < sunrise ~ "night",
      datetime >= sunset ~ "night",
      TRUE ~ NA_character_)) %>%
  mutate(zone = "TSZ", burn_status = "burned") %>%
  filter(!is.nan(SWin_Avg)) %>%
  #adding in my own calculated NR_Avg column
  mutate(SnowDepth_cm = (SnowDepth_m*100)) %>%
  mutate(NR_Avg_new = (SWin_Avg - SWout_Avg) + (LWin_Avg - LWout_Avg)) %>%
  select(datetime, day, month, phase, zone, burn_status, NR_Avg_new, SnowDepth_cm, everything())
```

```{r}
filtered_transub_wx_15min <- transub_wx_15min_r %>%
  mutate(day = as.Date.POSIXct(datetime, tz = "MST"),
    month = as.numeric(format(datetime, "%m")),
    datetime = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime >= as.POSIXct("2024-02-02 00:00:00", tz = "MST") & 
         datetime < as.POSIXct("2024-07-01 00:00:00", tz = "MST")) %>%
  inner_join(p_b_solar_times, by = "day") %>%
  #creating a phase column that parses by daily sunrise/sunset times
  mutate(
    phase = case_when(
      datetime >= sunrise & datetime < sunset ~ "day",
      datetime < sunrise ~ "night",
      datetime >= sunset ~ "night",
      TRUE ~ NA_character_)) %>%
  mutate(zone = "TSZ", burn_status = "unburned") %>%
  #adding in my own calculated NR_Avg column
  #adding in my own calculated NR_Avg column
  mutate(SnowDepth_cm = (SnowDepth_m*100)) %>%
  mutate(NR_Avg_new = (SWin_Avg - SWout_Avg) + (LWin_Avg - LWout_Avg)) %>%
  select(datetime, day, month, phase, zone, burn_status, NR_Avg_new, everything())
```

```{r}
filtered_persub_wx_hourly <- persub_wx_hourly_r %>%
  mutate(day = as.Date.POSIXct(datetime, tz = "MST"),
    month = as.numeric(format(datetime, "%m")),
    datetime = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime >= as.POSIXct("2024-02-02 00:00:00", tz = "MST") & 
         datetime < as.POSIXct("2024-07-01 00:00:00", tz = "MST")) %>%
  inner_join(p_b_solar_times, by = "day") %>%
  #creating a phase column that parses by daily sunrise/sunset times
  mutate(
    phase = case_when(
      datetime >= sunrise & datetime < sunset ~ "day",
      datetime < sunrise ~ "night",
      datetime >= sunset ~ "night",
      TRUE ~ NA_character_)) %>%
  mutate(zone = "PSZ", burn_status = "unburned") %>%
  #adding in my own calculated NR_Avg column
  mutate(SnowDepth_cm = (SnowDepth_m*100)) %>%
  #adding in my own calculated NR_Avg column
  mutate(NR_Avg_new = (SWin_Avg - SWout_Avg) + (LWin_Avg - LWout_Avg)) %>%
  select(datetime, day, month, phase, zone, burn_status, NR_Avg_new, everything())
```

```{r}
filtered_persb_wx_hourly <- persb_wx_hourly_r %>%
  mutate(day = as.Date.POSIXct(datetime, tz = "MST"),
    month = as.numeric(format(datetime, "%m")),
    datetime = with_tz(datetime, tzone = "MST")) %>%
  filter(datetime >= as.POSIXct("2024-02-02 00:00:00", tz = "MST") & 
         datetime < as.POSIXct("2024-07-01 00:00:00", tz = "MST")) %>%
  inner_join(p_b_solar_times, by = "day") %>%
  #creating a phase column that parses by daily sunrise/sunset times
  mutate(
    phase = case_when(
      datetime >= sunrise & datetime < sunset ~ "day",
      datetime < sunrise ~ "night",
      datetime >= sunset ~ "night",
      TRUE ~ NA_character_)) %>%
  mutate(zone = "PSZ", burn_status = "burned") %>%
  #adding in my own calculated NR_Avg column
  mutate(SnowDepth_cm = (SnowDepth_m*100)) %>%
 #adding in my own calculated NR_Avg column
  mutate(NR_Avg_new = (SWin_Avg - SWout_Avg) + (LWin_Avg - LWout_Avg)) %>%
  select(datetime, day, month, phase, zone, burn_status, NR_Avg_new, everything())
```

## Full Season Tree Well Analysis

#### Tree ID Colors

```{r}
#setting constants for tree_id colors and burn status linetypes
treeid_colors <- c(
  "tree_1" = "#1B7837",
  "tree_2" = "#D95F02",
  "tree_3" = "#2166AC",
  "tree_4" = "grey23"
)

burnstatus_linetype <- c("GB" = "solid", "DB" = "dashed")
```

```{r}
transb_treewell_diams_fullseason <- read_csv("nsf/treewell_data/snowcam_treewell_data/transb_treewell_diams_fullseason.csv") %>%
  filter(date <= "2024-05-08")

transb_treewell_diams_fullseason_V2 <- read_csv("nsf/treewell_data/snowcam_treewell_data/transb_treewell_diams_fullseason_V2.csv") %>%
  filter(date <= "2024-05-08")
```

```{r}
persb_high_treewell_diams_fullseason <- read_csv("nsf/treewell_data/snowcam_treewell_data/persb_highmort_treewell_diams_fullseason.csv") %>%
  filter(date >= "2024-02-02" & date <= "2024-05-23")

persb_high_treewell_diams_fullseason_V2 <- read_csv("nsf/treewell_data/snowcam_treewell_data/persb_highmort_treewell_diams_fullseason_V2.csv")  
```

```{r}
persb_low_treewell_diams_fullseason <- read_csv("nsf/treewell_data/snowcam_treewell_data/persb_lowmort_treewell_diams_fullseason.csv") %>%
  filter(date >= "2024-02-02" & date <= "2024-05-30")

persb_low_treewell_diams_fullseason_V2 <- read_csv("nsf/treewell_data/snowcam_treewell_data/persb_lowmort_treewell_diams_fullseason_V2.csv") %>%
   filter(date >= "2024-02-02" & date <= "2024-05-23")
```

```{r}
#pivoting the well and tree diam columns to be long format
long_transb_treewell_diams_fullseason <- transb_treewell_diams_fullseason %>%
  pivot_longer(cols = starts_with("tree_diam_") | starts_with("well_diam_"), 
               names_to = c(".value", "tree_id"), 
               names_pattern = "(.*)_(\\d+)_cm") %>%
  mutate(tree_id = as.integer(tree_id)) %>%
  #adding burn status to long dataframe per tree
  mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",
    tree_id == 4 ~ "DB",
    TRUE ~ NA_character_  # Handles any unexpected values
  ))
```

```{r}
long_transb_treewell_diams_fullseason_V2 <- transb_treewell_diams_fullseason_V2 %>%
  pivot_longer(cols = starts_with("tree_diam_") | starts_with("well_diam_"), 
               names_to = c(".value", "tree_id"), 
               names_pattern = "(.*)_(\\d+)_cm") %>%
  mutate(tree_id = as.integer(tree_id)) %>%
  #adding burn status to long dataframe per tree
  mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",
    tree_id == 4 ~ "DB",
    TRUE ~ NA_character_  # Handles any unexpected values
  ))
```

```{r}
long_persb_high_treewell_diams_fullseason_V2 <- persb_high_treewell_diams_fullseason_V2 %>%
  pivot_longer(cols = starts_with("tree_diam_") | starts_with("well_diam_"), 
               names_to = c(".value", "tree_id"), 
               names_pattern = "(.*)_(\\d+)_cm") %>%
  mutate(tree_id = as.integer(tree_id)) %>%
  mutate(date = as.Date(date)) %>%
  # Adding burn status to long dataframe per tree
  mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",
    tree_id == 4 ~ "DB",
    TRUE ~ NA_character_  # Handles any unexpected values
  )) %>%
  select(date, time_mst, zone, burn_status, maximum_depth_cm, 
         conditions, treewell_developed, reset, tree_id, tree_diam, well_diam)
```

```{r}
long_persb_low_treewell_diams_fullseason <- persb_low_treewell_diams_fullseason %>%
  pivot_longer(cols = starts_with("tree_diam_") | starts_with("well_diam_"), 
               names_to = c(".value", "tree_id"), 
               names_pattern = "(.*)_(\\d+)_cm") %>%
  mutate(tree_id = as.integer(tree_id)) %>%
  mutate(burn_status = "GB") %>%
  select(date, time_mst, zone, burn_status, maximum_depth_cm, conditions, treewell_developed, reset, tree_id, tree_diam, well_diam)
```

```{r}
long_persb_low_treewell_diams_fullseason_V2 <- persb_low_treewell_diams_fullseason_V2 %>%
  pivot_longer(cols = starts_with("tree_diam_") | starts_with("well_diam_"), 
               names_to = c(".value", "tree_id"), 
               names_pattern = "(.*)_(\\d+)_cm") %>%
  mutate(tree_id = as.integer(tree_id)) %>%
  mutate(burn_status = "GB") %>%
  select(date, time_mst, zone, burn_status, maximum_depth_cm, conditions, treewell_developed, reset, tree_id, tree_diam, well_diam)
```

```{r}
#combining persb_high and persb_low to get ONLY the DB of pers_high and GB of pers_low
DB_long_persb_high_treewell_diam_fullseason <- long_persb_high_treewell_diams_fullseason_V2 %>%
  filter(burn_status == "DB")

GB_long_persb_low_treewell_diams_fullseason <- 
  long_persb_low_treewell_diams_fullseason
```

```{r}
#combined dataframe with GB from low mort and DB from high mort
comb_persb_treewell_diam_fullseason <- rbind( long_persb_low_treewell_diams_fullseason_V2, DB_long_persb_high_treewell_diam_fullseason) %>%
  mutate(well_diamV2 = well_diam - tree_diam)
```

```{r}
#dataframe for when treewell's reset
transb_treewell_reset_dataframe <- long_transb_treewell_diams_fullseason %>%
  filter(reset == "Yes", tree_id == "1")

transb_treewell_reset_dataframe_V2 <- long_transb_treewell_diams_fullseason_V2 %>%
  filter(reset == "Yes", tree_id == "1")

persb_treewell_reset_dataframe <- long_persb_high_treewell_diams_fullseason %>%
  filter(reset == "Yes", tree_id == "1")

persb_treewell_reset_dataframe_V2 <- long_persb_high_treewell_diams_fullseason_V2 %>%
  filter(reset == "Yes", tree_id == "1")
```

```{r}
filtered_daily_transb_wx_15min_r <- filtered_transb_wx_15min %>%
  filter(day >= "2024-02-02" & day <= "2024-07-01") %>%
  filter(phase == "day") %>%
  #converting radiation values from W/m^2 to MJ/m^2 per day
  mutate(SWin_Avg = (SWin_Avg * 86400/1000000), LWin_Avg = (LWin_Avg * 86400/1000000), SWout_Avg = (SWout_Avg * 86400/1000000), LWout_Avg = (LWout_Avg * 86400/1000000), SWnet_Avg = (SWnet_Avg * 86400/1000000), LWnet_Avg = (LWnet_Avg * 86400/1000000), NR_Avg_new = (NR_Avg_new * 86400/1000000)) %>%
  group_by(date) %>%
  summarize(
    AirTC_Avg = mean(AirTC_Avg, na.rm = TRUE), 
    WS_ms_Avg = mean(WS_ms_Avg, na.rm = TRUE), 
    SWin_Avg = mean(SWin_Avg, na.rm = TRUE), 
    SWout_Avg = mean(SWout_Avg, na.rm = TRUE), 
    LWin_Avg = mean(LWin_Avg, na.rm = TRUE), 
    LWout_Avg = mean(LWout_Avg, na.rm = TRUE), 
    SWnet_Avg = mean(SWnet_Avg, na.rm = TRUE), 
    LWnet_Avg = mean(LWnet_Avg, na.rm = TRUE), 
    NR_Avg = mean(NR_Avg_new, na.rm = TRUE), 
    SnowDepth_cm = mean(SnowDepth_cm, na.rm = TRUE),
    cum_AirTC = sum(AirTC_Avg, na.rm = TRUE), 
    cum_SWnet = sum(SWnet_Avg, na.rm = TRUE), 
    cum_LWnet = sum(LWnet_Avg, na.rm = TRUE), 
    cum_NR = sum(NR_Avg_new, na.rm = TRUE)) %>%
  #creating a rolling cumulative sum between days
  arrange(date) %>%
  mutate(totalcum_AirTC = cumsum(AirTC_Avg), totalcum_SWnet = cumsum(SWnet_Avg), totalcum_LWnet = cumsum(LWnet_Avg), totalcum_NR = cumsum(NR_Avg), totalcum_SnowDepth = cumsum(SnowDepth_cm))
```

```{r}
filtered_daily_persb_wx_hourly_r <- filtered_persb_wx_hourly %>%
  filter(day >= "2024-02-02" & day <= "2024-07-01") %>%
  filter(phase == "day") %>%
   #converting radiation values from W/m^2 to MJ/m^2 per day
  mutate(SWin_Avg = (SWin_Avg * 86400/1000000), LWin_Avg = (LWin_Avg * 86400/1000000), SWout_Avg = (SWout_Avg * 86400/1000000), LWout_Avg = (LWout_Avg * 86400/1000000), SWnet_Avg = (SWnet_Avg * 86400/1000000), LWnet_Avg = (LWnet_Avg * 86400/1000000), NR_Avg_new = (NR_Avg_new * 86400/1000000)) %>%
  group_by(date) %>%
  summarize(
    AirTC_Avg = mean(AirTC_Avg, na.rm = TRUE), 
    WS_ms_Avg = mean(WS_ms_Avg, na.rm = TRUE), 
    SWin_Avg = mean(SWin_Avg, na.rm = TRUE), 
    SWout_Avg = mean(SWout_Avg, na.rm = TRUE), 
    LWin_Avg = mean(LWin_Avg, na.rm = TRUE), 
    LWout_Avg = mean(LWout_Avg, na.rm = TRUE), 
    SWnet_Avg = mean(SWnet_Avg, na.rm = TRUE), 
    LWnet_Avg = mean(LWnet_Avg, na.rm = TRUE), 
    NR_Avg = mean(NR_Avg_new, na.rm = TRUE), 
    SnowDepth_cm = mean(SnowDepth_cm, na.rm = TRUE),
    cum_AirTC = sum(AirTC_Avg, na.rm = TRUE), 
    cum_SWnet = sum(SWnet_Avg, na.rm = TRUE), 
    cum_LWnet = sum(LWnet_Avg, na.rm = TRUE), 
    cum_NR = sum(NR_Avg_new, na.rm = TRUE)) %>%
  #creating a rolling cumulative sum between days
  arrange(date) %>%
  mutate(totalcum_AirTC = cumsum(AirTC_Avg), totalcum_SWnet = cumsum(SWnet_Avg), totalcum_LWnet = cumsum(LWnet_Avg), totalcum_NR = cumsum(NR_Avg), totalcum_SnowDepth = cumsum(SnowDepth_cm))
```

### Plotting

#### Tree Diams + Weather

SWin/out

```{r}
scaling_factor_SW <- 0.3
```

```{r}
transb_fullseason_well_SW_plot <- ggplot() +
  # Vertical lines for when wells were reset
  geom_vline(data = transb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), 
             color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Shortwave in 
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = SWin_Avg * scaling_factor_SW, fill = "SWin"), alpha = 0.5) + 
  # Shortwave out
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = SWout_Avg * scaling_factor_SW, fill = "SWout"), alpha = 0.4) + 
  # Tree well diameter lines
  geom_line(data = long_transb_treewell_diams_fullseason_V2, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_SW, name = "Radiation (W/m²)")
  ) +
  # Corrected color and linetype mappings
  scale_fill_manual(name = "Radiation Component", 
    values = c("SWin" = "orange", "SWout" = "red")) +  
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "b) TSZ", 
       x = "Date", 
       fill = "Radiation Component", 
       color = "Tree ID", 
       linetype = "Burn Status") +
  theme_bw()

transb_fullseason_well_SW_plot
```

```{r}
persb_fullseason_well_SW_plot <- ggplot() +
  # Shortwave in 
  geom_col(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = SWin_Avg * scaling_factor_SW, fill = "SWin"), alpha = 0.5) + 
  # Shortwave out
  geom_col(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = SWout_Avg * scaling_factor_SW, fill = "SWout"), alpha = 0.4) + 
  # Vertical lines for when wells were reset
  geom_vline(data = persb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), 
             color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Tree well diameter lines
  geom_line(data = comb_persb_treewell_diam_fullseason, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_SW, name = "Radiation (W/m²)")
  ) +
  # Corrected color and linetype mappings
  scale_fill_manual(name = "Radiation Component", 
    values = c("SWin" = "orange", "SWout" = "red")) +  
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "a) PSZ", 
       x = "Date", 
       fill = "Radiation Component", 
       color = "Tree ID", 
       linetype = "Burn Status") +
  theme_bw()

persb_fullseason_well_SW_plot
```

```{r}
ggsave("nsf/persb_fullseason_well_SW_plot.png", 
       plot = persb_fullseason_well_SW_plot, width = 13, height = 7, dpi = 600)
```

```{r}
ggsave("nsf/transb_fullseason_well_SW_plot.png", 
       plot = transb_fullseason_well_SW_plot, width = 13, height = 7, dpi = 600)
```

LWin/out

```{r}
scaling_factor_LW <- 0.5
```

```{r}
transb_fullseason_well_LW_plot <- ggplot() +
  # Longwave in 
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = LWin_Avg * scaling_factor_LW, fill = "LWin"), alpha = 0.5) + 
  # Longwave out
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = LWout_Avg * scaling_factor_LW, fill = "LWout"), alpha = 0.4) + 
   # Vertical lines for when wells were reset
  geom_vline(data = transb_treewell_reset_dataframe, 
             aes(xintercept = as.numeric(date)), 
             color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Tree well diameter lines
  geom_line(data = long_transb_treewell_diams_fullseason, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_LW, name = "Radiation (W/m²)")
  ) +
  # Corrected color and linetype mappings
  scale_fill_manual(name = "Radiation Component", 
    values = c("LWin" = "dodgerblue1", "LWout" = "dodgerblue3")) +  
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "b) TSZ", 
    x = "Date", 
       fill = "Radiation Component", 
       color = "Tree ID", 
       linetype = "Burn Status") +
  theme_bw()

transb_fullseason_well_LW_plot
```

```{r}
persb_fullseason_well_LW_plot <- ggplot() +
  # Longwave in 
  geom_col(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = LWin_Avg * scaling_factor_LW, fill = "LWin"), alpha = 0.5) + 
  # Longwave out
  geom_col(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = LWout_Avg * scaling_factor_LW, fill = "LWout"), alpha = 0.4) + 
   # Vertical lines for when wells were reset
  geom_vline(data = persb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), 
             color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Tree well diameter lines
  geom_line(data = comb_persb_treewell_diam_fullseason, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_LW, name = "Radiation (W/m²)")
  ) +
  # Corrected color and linetype mappings
  scale_fill_manual(name = "Radiation Component", 
    values = c("LWin" = "dodgerblue1", "LWout" = "dodgerblue3")) +  
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "a) PSZ",
    x = "Date", 
       fill = "Radiation Component", 
       color = "Tree ID", 
       linetype = "Burn Status") +
  theme_bw()

persb_fullseason_well_LW_plot
```

```{r}
ggsave("nsf/persb_fullseason_well_LW_plot.png", 
       plot = persb_fullseason_well_LW_plot, width = 13, height = 7, dpi = 600)
```

```{r}
ggsave("nsf/transb_fullseason_well_LW_plot.png", 
       plot = transb_fullseason_well_LW_plot, width = 13, height = 7, dpi = 600)
```

NR Avg plot

```{r}
scaling_factor_NR <- 2
```

```{r}
transb_fullseason_well_LW_plot <- ggplot() +
  # Tree well diameter lines
  geom_line(data = long_transb_treewell_diams_fullseason_V2, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Vertical lines for when wells were reset
  geom_vline(data = transb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), 
             color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Longwave in 
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = NR_Avg * scaling_factor_NR), fill = "orange", alpha = 0.5) + 
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_NR, name = "Radiation (W/m²)")
  ) +
  # Corrected color and linetype mappings
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(x = "Date", color = "Tree ID", linetype = "Burn Status") +
  theme_bw()

transb_fullseason_well_LW_plot
```

Air Temp

```{r}
scaling_factor_airT <- 10
```

```{r}
transb_fullseason_well_airTCRad_plot <- ggplot() +
  # NR Avg (Radiation)
  geom_col(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = NR_Avg, fill = "Total Net Radiation"), alpha = 0.5) + 
  # Vertical lines for when wells were reset
  geom_vline(data = transb_treewell_reset_dataframe_V2, 
            aes(xintercept = as.numeric(date)), color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Air Temp
  geom_line(data = filtered_daily_transb_wx_15min_r, 
           aes(x = date, y = AirTC_Avg * scaling_factor_airT, color = "Air Temp"), linewidth = 0.8, alpha = 0.8) + 
  # Tree well diameter lines
  geom_line(data = long_transb_treewell_diams_fullseason_V2, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm) & Radiation (W/m²)", 
    sec.axis = sec_axis(~ . / scaling_factor_airT, name = "Air Temp (°C)")
  ) +
  # Corrected color and linetype mappings
  scale_color_manual(name = "Tree ID & Wx Station Component", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple", "Air Temp" = "dodgerblue3")) +  
  scale_fill_manual(name = "Radiation Component", 
    values = c("Total Net Radiation" = "orange")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "b) TSZ", 
       x = "Date", 
       color = "Legend", 
       linetype = "Burn Status") +
  theme_bw()

transb_fullseason_well_airTCRad_plot
```

```{r}
persb_fullseason_well_airTCRad_plot <- ggplot() +
  # NR Avg (Radiation)
  geom_col(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = NR_Avg, fill = "Total Net Radiation"), alpha = 0.5) + 
  # Vertical lines for when wells were reset
  geom_vline(data = persb_treewell_reset_dataframe_V2, 
            aes(xintercept = as.numeric(date)), color = "grey23", linetype = "solid", size = 0.5, alpha = 0.7) +
  # Air Temp
  geom_line(data = filtered_daily_persb_wx_hourly_r, 
           aes(x = date, y = AirTC_Avg * scaling_factor_airT, color = "Air Temp"), linewidth = 0.8, alpha = 0.8) + 
  # Tree well diameter lines
  geom_line(data = comb_persb_treewell_diam_fullseason, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm) & Radiation (W/m²)", 
    sec.axis = sec_axis(~ . / scaling_factor_airT, name = "Air Temp (°C)")
  ) +
  # Corrected color and linetype mappings
  scale_color_manual(name = "Tree ID & Wx Station Component", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple", "Air Temp" = "dodgerblue3")) +  
  scale_fill_manual(name = "Radiation Component", 
    values = c("Total Net Radiation" = "orange")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "a) PSZ", 
       x = "Date", 
       color = "Legend", 
       linetype = "Burn Status") +
  theme_bw()

persb_fullseason_well_airTCRad_plot
```

Combining Plots

```{r}
comb_fullseason_well_airTRAD_plot <- ggarrange(persb_fullseason_well_airTCRad_plot, transb_fullseason_well_airTCRad_plot, nrow = 2, ncol = 1, common.legend = TRUE, legend = "bottom")

comb_fullseason_well_airTRAD_plot
```

```{r}
ggsave("nsf/comb_fullseason_well_airTRAD_plot.png", 
       width = 12, height = 10,
       plot = comb_fullseason_well_airTRAD_plot, dpi = 600)
```

Individually saving plots

```{r}
ggsave("nsf/persb_fullseason_well_airTCRad_plot.png", 
       plot = persb_fullseason_well_airTCRad_plot, width = 13, height = 7, dpi = 600)
```

```{r}
ggsave("nsf/transb_fullseason_well_airTCRad_plot.png", 
       plot = transb_fullseason_well_airTCRad_plot, width = 13, height = 7, dpi = 600)
```

Snow Depth

```{r}
sd_persb <- comb_persb_treewell_diam_fullseason %>%
  filter(tree_id == "1")
```

```{r}
scaling_factor_sd <- 1
```

```{r}
persb_fullseason_well_sd_plot <- ggplot() +
  # Snow depth on secondary y-axis
  geom_col(data = sd_persb, 
           aes(x = date, y = maximum_depth_cm * scaling_factor_sd, fill = "Snow Depth"), alpha = 0.5) + 
  # Vertical lines for when wells were reset
  geom_vline(data = persb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), color = "grey23", 
             linetype = "solid", size = 0.5, alpha = 0.7) +
  # Tree well diameter lines (Primary y-axis)
  geom_line(data = comb_persb_treewell_diam_fullseason, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), 
            linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_sd, name = "Snow Depth (cm)")
  ) +
  # Corrected color and linetype mappings
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_fill_manual(name = NULL, values = c("Snow Depth" = "dodgerblue3")) +  
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "a) PSZ", 
       x = "Date", 
       color = "Tree ID", 
       linetype = "Burn Status", 
       fill = "Snow Depth") +
  theme_bw()

persb_fullseason_well_sd_plot
```

```{r}
sd_transb <- long_transb_treewell_diams_fullseason_V2 %>%
  filter(tree_id == "1")
```

```{r}
transb_fullseason_well_sd_plot <- ggplot() +
  # Snow depth on secondary y-axis
  geom_col(data = sd_transb, 
           aes(x = date, y = maximum_depth_cm * scaling_factor_sd, fill = "Snow Depth"), alpha = 0.5) + 
  # Vertical lines for when wells were reset
  geom_vline(data = transb_treewell_reset_dataframe_V2, 
             aes(xintercept = as.numeric(date)), color = "grey23", 
             linetype = "solid", size = 0.5, alpha = 0.7) +
  # Tree well diameter lines (Primary y-axis)
  geom_line(data = long_transb_treewell_diams_fullseason_V2, 
            aes(x = date, y = well_diam, color = factor(tree_id), linetype = burn_status), 
            linewidth = 0.8) +  
  # Y-axis scaling
  scale_y_continuous(
    name = "Well Diameter (cm)", 
    sec.axis = sec_axis(~ . / scaling_factor_sd, name = "Snow Depth (cm)")
  ) +
  # Corrected color and linetype mappings
  scale_color_manual(name = "Tree ID", 
    values = c("1" = "red", "2" = "blue", "3" = "green", "4" = "purple")) +  
  scale_fill_manual(name = NULL, 
                    values = c("Snow Depth" = "dodgerblue3")) +
  scale_linetype_manual(name = "Burn Status", 
    values = c("GB" = "solid", "DB" = "dashed")) +  
  # Labels and theme
  labs(title = "b) TSZ", 
       x = "Date", 
       color = "Legend", 
       linetype = "Burn Status") +
  theme_bw()

transb_fullseason_well_sd_plot
```

```{r}
ggsave("nsf/persb_fullseason_well_sd_plot.png", 
       plot = persb_fullseason_well_sd_plot, width = 13, height = 7, dpi = 600)
```

```{r}
ggsave("nsf/transb_fullseason_well_sd_plot.png", 
       plot = transb_fullseason_well_sd_plot, width = 13, height = 7, dpi = 600)
```

## Correlation Scatterplots

### Data Wrangling

Well and Weather correlations

```{r}
#pulling in tree temp data and creating a mean daily average

p_b_solar_times <- read_csv("nsf/treetemp_data/p_b_solar_times.csv") %>%
  mutate(
    sunrise = as.POSIXct(sunrise, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"),
    sunrise = with_tz(sunrise, tz = "MST")
  ) %>%
   mutate(
    sunset = as.POSIXct(sunset, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"),
    sunset = with_tz(sunset, tz = "MST")
  )

full_15min_ns <- read_csv("nsf/treetemp_data/full_15min_ns.csv") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")),
                               datetime = with_tz(datetime, tz = 'MST')) %>%
  mutate(day = as.Date(day, format = ("%Y-%m-%d"))) %>%
  inner_join(p_b_solar_times, by = "day") %>%
  #creating a phase column that parses by daily sunrise/sunset times
  mutate(
    phase = case_when(
      datetime >= sunrise & datetime < sunset ~ "day",
      datetime < sunrise ~ "night",
      datetime >= sunset ~ "night",
      TRUE ~ NA_character_)) %>%
  select(datetime, day, month, phase, zone, snow_phase, burn_status, north_temp, south_temp, solarNoon, sunrise, sunset, dawn, dusk)
```

```{r}
persb_daily_treetemp_data <- full_15min_ns %>%
  filter(zone == "PSZ", phase == "day") %>%
  rename(date = "day") %>%
  group_by(date) %>%
  summarize(mean_tree_temp = mean((north_temp + south_temp)/2), cum_daily_tree_temp = sum(north_temp + south_temp)) %>%
  #adding total cumulative sum for entire period
  arrange(date) %>%
  mutate(totalcum_treetemp_sum = cumsum(cum_daily_tree_temp)) %>%
  mutate(totalcum_treetemp= cumsum(mean_tree_temp))

persb_daily_treetemp_data_nt <- full_15min_ns %>%
  filter(zone == "PSZ", phase == "night") %>%
  rename(date = "day") %>%
  group_by(date) %>%
  summarize(mean_tree_temp = mean((north_temp + south_temp)/2), cum_daily_tree_temp = sum(north_temp + south_temp)) %>%
  #adding total cumulative sum for entire period
  arrange(date) %>%
  mutate(totalcum_treetemp_sum = cumsum(cum_daily_tree_temp)) %>%
  mutate(totalcum_treetemp= cumsum(mean_tree_temp))
```

```{r}
transb_daily_treetemp_data <- full_15min_ns %>%
  filter(zone == "TSZ", phase == "day") %>%
  rename(date = "day") %>%
  group_by(date) %>%
  summarize(mean_tree_temp = mean((north_temp + south_temp)/2), cum_daily_tree_temp = sum(north_temp + south_temp)) %>%
  #adding total cumulative sum for entire period
  arrange(date) %>%
  mutate(totalcum_treetemp_sum = cumsum(cum_daily_tree_temp)) %>%
  mutate(totalcum_treetemp= cumsum(mean_tree_temp))

transb_daily_treetemp_data_nt <- full_15min_ns %>%
  filter(zone == "TSZ", phase == "night") %>%
  rename(date = "day") %>%
  group_by(date) %>%
  summarize(mean_tree_temp = mean((north_temp + south_temp)/2), cum_daily_tree_temp = sum(north_temp + south_temp)) %>%
  #adding total cumulative sum for entire period
  arrange(date) %>%
  mutate(totalcum_treetemp_sum = cumsum(cum_daily_tree_temp)) %>%
  mutate(totalcum_treetemp= cumsum(mean_tree_temp))
```

```{r}
#colors for points
treeid_colors <- c("1" = "#1B7837", "2" = "#D95F02", "3" = "#2166AC", "4" = "grey23")
```

```{r}
persb_corr_data_V2 <- comb_persb_treewell_diam_fullseason %>%
  # Select relevant columns
  #had to remove the burn_status and tree_diam columns because those values are different from tree to tree!
  select(date, tree_id, zone, treewell_developed, reset, well_diam, maximum_depth_cm) %>%
  # Pivot wider so each tree_id has its own well_diam column
  pivot_wider(names_from = tree_id, values_from = well_diam, names_prefix = "well_diam_tree") %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  # Compute differenced well diameter for each tree where well diameter increases
  mutate(
    well_diam_diff_tree1 = if_else(well_diam_tree1 > lag(well_diam_tree1), 
                                   abs(well_diam_tree1 - lag(well_diam_tree1)), NA_real_),
    well_diam_diff_tree2 = if_else(well_diam_tree2 > lag(well_diam_tree2), 
                                   abs(well_diam_tree2 - lag(well_diam_tree2)), NA_real_),
    well_diam_diff_tree3 = if_else(well_diam_tree3 > lag(well_diam_tree3), 
                                   abs(well_diam_tree3 - lag(well_diam_tree3)), NA_real_),
    well_diam_diff_tree4 = if_else(well_diam_tree4 > lag(well_diam_tree4), 
                                   abs(well_diam_tree4 - lag(well_diam_tree4)), NA_real_)
  ) %>%
  # Remove rows where all well_diam_diff values are NA
  filter(!if_all(starts_with("well_diam_diff"), is.na))
```

```{r}
#using well diameter minus tree diameter to see if there's a difference in correlation!
persb_corr_data_V3 <- comb_persb_treewell_diam_fullseason %>%
  # Select relevant columns
  #had to remove the burn_status and tree_diam columns because those values are different from tree to tree!
  select(date, tree_id, zone, treewell_developed, reset, well_diamV2, maximum_depth_cm) %>%
  # Pivot wider so each tree_id has its own well_diam column
  pivot_wider(names_from = tree_id, values_from = well_diamV2, names_prefix = "well_diam_tree") %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  # Compute differenced well diameter for each tree where well diameter increases
  mutate(
    well_diam_diff_tree1 = if_else(well_diam_tree1 > lag(well_diam_tree1), 
                                   abs(well_diam_tree1 - lag(well_diam_tree1)), NA_real_),
    well_diam_diff_tree2 = if_else(well_diam_tree2 > lag(well_diam_tree2), 
                                   abs(well_diam_tree2 - lag(well_diam_tree2)), NA_real_),
    well_diam_diff_tree3 = if_else(well_diam_tree3 > lag(well_diam_tree3), 
                                   abs(well_diam_tree3 - lag(well_diam_tree3)), NA_real_),
    well_diam_diff_tree4 = if_else(well_diam_tree4 > lag(well_diam_tree4), 
                                   abs(well_diam_tree4 - lag(well_diam_tree4)), NA_real_)
  ) %>%
  # Remove rows where all well_diam_diff values are NA
  filter(!if_all(starts_with("well_diam_diff"), is.na))
```

```{r}
persb_corr_long <- persb_corr_data_V2 %>%
  pivot_longer(cols = starts_with("well_diam_diff_tree"), 
               names_to = "tree_id", 
               values_to = "well_diam_diff") %>%
  mutate(tree_id = str_replace(tree_id, "well_diam_diff_tree", "")) %>%
  select(-c(well_diam_tree1, well_diam_tree2, well_diam_tree3, well_diam_tree4)) %>%
   mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",  # Assign "GB" to tree_id 1, 2, 3
    tree_id == 4 ~ "DB"              # Assign "DB" to tree_id 4
  )) %>%
  #adding in an accumulation and ablation season
  mutate(season = case_when(
    date < as.Date("2024-05-06") ~ "accumulation",
    date >= as.Date("2024-05-06") ~ "ablation"
  ))
```

```{r}
#well diameter without tree diameter!
persb_corr_long_V2 <- persb_corr_data_V3 %>%
  pivot_longer(cols = starts_with("well_diam_diff_tree"), 
               names_to = "tree_id", 
               values_to = "well_diam_diff") %>%
  mutate(tree_id = str_replace(tree_id, "well_diam_diff_tree", "")) %>%
  select(-c(well_diam_tree1, well_diam_tree2, well_diam_tree3, well_diam_tree4)) %>%
   mutate(burn_status = case_when(
    tree_id %in% c(1, 2, 3) ~ "GB",  # Assign "GB" to tree_id 1, 2, 3
    tree_id == 4 ~ "DB"              # Assign "DB" to tree_id 4
  ))
```

```{r}
persb_corr_accu <- persb_corr_long %>%
  filter(date < "2024-05-01")

persb_corr_abla <- persb_corr_long %>%
  filter(date >= "2024-05-01")
```

```{r}
#Persb ablation defined as peak SWE date in burned zone
persb_corr_accu_V2 <- persb_corr_long %>%
  filter(date <= "2024-04-06")

persb_corr_abla_V2 <- persb_corr_long %>%
  filter(date > "2024-04-06")
```

```{r}
#Persb ablation defined as 2ndary peak SWE
persb_corr_accu_V3 <- persb_corr_long %>%
  filter(date <= "2024-04-28")

persb_corr_abla_V3 <- persb_corr_long %>%
  filter(date > "2024-04-28")
```

###  PSZ Tests

```{r}
persb_corr_data_accu <- comb_persb_treewell_diam_fullseason %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  filter(date < "2024-05-06") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)

persb_corr_data_abla <- comb_persb_treewell_diam_fullseason %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  filter(date >= "2024-05-06"& date <= "2024-05-23") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)
```

```{r}
#PEAK SWE as ablation date
persb_corr_data_accu_V2 <- comb_persb_treewell_diam_fullseason %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  filter(date <= "2024-04-06") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)

persb_corr_data_abla_V2<- comb_persb_treewell_diam_fullseason %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  filter(date > "2024-04-06" & date <= "2024-05-23") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)
```

```{r}
#ablation beginning after 2ndary peaks SWE date
persb_corr_data_accu_V3 <- comb_persb_treewell_diam_fullseason %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  filter(date <= "2024-05-01") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)

persb_corr_data_abla_V3<- comb_persb_treewell_diam_fullseason %>%
  # Join with weather data
  inner_join(filtered_daily_persb_wx_hourly_r, by = "date") %>%
  inner_join(persb_daily_treetemp_data, by = "date") %>%
  filter(date > "2024-05-01") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)
```

#### Air Temp

```{r}
#not using right now!
p_AirTC_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, AirTC_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(R2 = cor(well_diam, AirTC_Avg, use = "complete.obs")^2, .groups = "drop") %>%
  mutate(R2_label = paste0("R² = ", round(R2, 3)))
```

```{r}
# AirTC Correlation
# Compute R^2 for each tree_id
p_AirTC_accu_results <- persb_corr_data_accu %>%
  drop_na(well_diam, AirTC_Avg) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )


# Scatterplot
persb_AirTC_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = AirTC_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Air Temp",
    x = "Air Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_AirTC_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_AirTC_corr_plot_accu
```

```{r}
ggsave("persb_AirTC_corr_plot_accu.png", plot = persb_AirTC_corr_plot_accu, dpi = 600)
```

```{r}
# Compute R^2 for each tree_id
p_AirTC_abla_results <- persb_corr_data_abla %>%
  drop_na(well_diam, AirTC_Avg) %>%
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) # Create label for plotting

# Scatterplot
persb_AirTC_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = AirTC_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Air Temp",
    x = "Air Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_AirTC_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_AirTC_corr_plot_abla
```

```{r}
ggsave("persb_AirTC_corr_plot_abla.png", plot = persb_AirTC_corr_plot_abla, dpi = 600)
```

#### Tree Temp

```{r}
# Tree Temp Correlation
# Compute R^2 for each tree_id
p_TreeTemp_r2_values_accu_V2 <- persb_corr_data_accu_V2 %>%
  drop_na(well_diam_m, mean_tree_temp) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, mean_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_TreeTemp_corr_plot_accu_V2 <- ggplot(persb_corr_data_accu_V2, aes(x = mean_tree_temp, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1, ncol = 4) +  # Separate by tree_id
  labs(
    title = "a) PSZ",
    x = "Tree Temperature (°C)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_TreeTemp_r2_values_accu_V2, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_TreeTemp_corr_plot_accu_V2
```

```{r}
ggsave("persb_TreeTemp_corr_plot_accu.png", plot = persb_TreeTemp_corr_plot_accu, dpi = 600)
```

```{r}
p_TreeTemp_r2_values_abla_V3 <- persb_corr_data_abla_V3 %>%
  drop_na(well_diam, mean_tree_temp) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, mean_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_TreeTemp_corr_plot_abla_V3 <- ggplot(persb_corr_data_abla_V3, aes(x = mean_tree_temp, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Tree Temperature",
    x = "Tree Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_TreeTemp_r2_values_abla_V2, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_TreeTemp_corr_plot_abla_V2
```

```{r}
ggsave("persb_TreeTemp_corr_plot_abla.png", plot = persb_TreeTemp_corr_plot_abla, dpi = 600)
```

Cumulative Daily Assessment

```{r}
# Cumulative Daily Tree Temp Correlation
# Compute R^2 for each tree_id
p_cumTreeTemp_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam_m, cum_daily_tree_temp) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, cum_daily_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_cumTreeTemp_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = cum_daily_tree_temp, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Cumulative Tree Temperature",
    x = "Cumulative Daily Tree Temperature (°C)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_cumTreeTemp_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_cumTreeTemp_corr_plot_accu
```

```{r}
# Cumulative Daily Tree Temp Correlation
# Compute R^2 for each tree_id
p_cumTreeTemp_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, cum_daily_tree_temp) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, cum_daily_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_cumTreeTemp_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = cum_daily_tree_temp, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Cumulative Tree Temperature",
    x = "Cumulative Daily Tree Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_cumTreeTemp_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_cumTreeTemp_corr_plot_abla
```

Total Cumulative

```{r}
# Cumulative Daily Tree Temp Correlation
# Compute R^2 for each tree_id
p_totalcumTreeTemp_r2_values_accu_V2 <- persb_corr_data_accu_V2 %>%
  drop_na(well_diam_m, totalcum_treetemp) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, totalcum_treetemp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
persb_totalcumTreeTemp_corr_plot_accu_V2 <- ggplot(persb_corr_data_accu_V2, aes(x = totalcum_treetemp, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "a) PSZ",
    x = NULL,
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_x_continuous(breaks = c(-100, 0, 100, 200), 
                     labels = c("-100", "0", "100", "200")) +
  scale_y_continuous(breaks = c(0.4, 0.8, 1.2, 1.6),
                     labels = c("0.4", "0.8", "1.2", "1.6"))+
  expand_limits(x = c(-100, 200), y = c(0.5, 2.0)) + 
  guides(color = "none") +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_totalcumTreeTemp_r2_values_accu_V2, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

persb_totalcumTreeTemp_corr_plot_accu_V2
```

```{r}
# Cumulative Daily Tree Temp Correlation
# Compute R^2 for each tree_id
p_totalcumTreeTemp_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam_m, totalcum_treetemp) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, totalcum_treetemp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
persb_totalcumTreeTemp_corr_plot_abla_V3 <- ggplot(persb_corr_data_abla_V3, aes(x = totalcum_treetemp, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "a) PSZ",
    x = NULL,
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_x_continuous(breaks = c(200, 250, 300, 350), 
                     labels = c("200", "250", "300", "350")) +
  scale_y_continuous(breaks = c(0.5, 1.0, 1.5, 2.0),
                     labels = c("0.5", "1.0", "1.5", "2.0"))+
  expand_limits(x = c(200, 350), y = c(0.5, 2.0)) + 
  theme(panel.spacing = unit(1, "lines")) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_totalcumTreeTemp_r2_values_abla_V2, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

persb_totalcumTreeTemp_corr_plot_abla_V3
```

```{r}
PSZ_totalcum_TreeTemp <- ggarrange(persb_totalcumTreeTemp_corr_plot_accu, persb_totalcumTreeTemp_corr_plot_abla, nrow = 2, ncol = 1, common.legend = TRUE, legend = "none")

PSZ_totalcum_TreeTemp <- annotate_figure(
  PSZ_totalcum_TreeTemp, 
  top = text_grob("a) PSZ", hjust = 0, x = 0.02)
)

PSZ_totalcum_TreeTemp
```

####  Net SW

```{r}
# SWnet Correlation
# Compute R^2 for each tree_id
p_NetSW_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, SWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 


# Scatterplot
persb_NetSW_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = SWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Net SW",
    x = "Net SW (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NetSW_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)
persb_NetSW_corr_plot_accu
```

```{r}
ggsave("persb_NetSW_corr_plot_accu.png", plot = persb_NetSW_corr_plot_accu, dpi = 600)
```

```{r}
# SWnet Correlation
# Compute R^2 for each tree_id
p_NetSW_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, SWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_NetSW_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = SWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Net SW",
    x = "Net SW (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NetSW_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NetSW_corr_plot_abla
```

```{r}
ggsave("persb_NetSW_corr_plot_abla.png", plot = persb_NetSW_corr_plot_abla, dpi = 600)
```

#### Net LW

```{r}
# LWnet Correlation
# Compute R^2 for each tree_id
p_NetLW_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, LWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_NetLW_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = LWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Net LW",
    x = "Net LW (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NetLW_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NetLW_corr_plot_accu
```

```{r}
ggsave("persb_NetLW_corr_plot_accu.png", plot = persb_NetLW_corr_plot_accu, dpi = 600)
```

```{r}
# LWnet Correlation
# Compute R^2 for each tree_id
p_NetLW_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, LWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
persb_NetLW_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = LWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Net LW",
    x = "Net LW (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NetLW_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NetLW_corr_plot_abla
```

```{r}
ggsave("persb_NetLW_corr_plot_abla.png", plot = persb_NetLW_corr_plot_abla, dpi = 600)
```

```{r}
# Net Radiation Correlation
# Compute R^2 for each tree_id
p_NR_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, NR_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
persb_NR_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = NR_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Total Net Rad",
    x = "Net Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NR_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NR_corr_plot_accu
```

```{r}
ggsave("persb_NR_corr_plot_accu.png", plot = persb_NR_corr_plot_accu, dpi = 600)
```

```{r}
# Net Radiation Correlation
# Compute R^2 for each tree_id
p_NR_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, NR_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
persb_NR_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = NR_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Total Net Rad",
    x = "Net Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NR_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_NR_corr_plot_abla
```

```{r}
ggsave("persb_NR_corr_plot_abla.png", plot = persb_NR_corr_plot_abla, dpi = 600)
```

Total Cumulative Data

```{r}
# Net Radiation Correlation
# Compute R^2 for each tree_id
p_totalcumNR_r2_values_accu <- persb_corr_data_accu_V3 %>%
  drop_na(well_diam_m, totalcum_NR) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, totalcum_NR, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
persb_totalcumNR_corr_plot_accu <- ggplot(persb_corr_data_accu_V3, aes(x = totalcum_NR, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "a) PSZ",
    x = NULL,
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_x_continuous(labels = scales::label_comma()) +
  scale_y_continuous(breaks = c(0.5, 1.0, 1.5, 2.0),
                     labels = c("0.5", "1.0", "1.5", "2.0"))+
  expand_limits(y = c(0.5, 2.0)) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_totalcumNR_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

persb_totalcumNR_corr_plot_accu
```

```{r}
# Net Radiation Correlation
# Compute R^2 for each tree_id
p_totalcumNR_r2_values_abla <- persb_corr_data_abla_V3 %>%
  drop_na(well_diam_m, totalcum_NR) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, totalcum_NR, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
persb_totalcumNR_corr_plot_abla <- ggplot(persb_corr_data_abla_V3, aes(x = totalcum_NR, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "a) PSZ",
    x = NULL,
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_y_continuous(breaks = c(0.5, 1.0, 1.5, 2.0),
                     labels = c("0.5", "1.0", "1.5", "2.0"))+
  expand_limits(y = c(0.5, 2.0)) + 
  guides(color = "none") +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_totalcumNR_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

persb_totalcumNR_corr_plot_abla
```

```{r}
PSZ_totalcum_NR <- ggarrange(persb_totalcumNR_corr_plot_accu, persb_totalcumNR_corr_plot_abla, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "none")

PSZ_totalcum_NR <- annotate_figure(
  PSZ_totalcum_NR, 
  top = text_grob("a) PSZ", hjust = 0, x = 0.02)
)

PSZ_totalcum_NR
```

#### Snow Depth

```{r}
# Snow Depth Correlation
# Compute R^2 for each tree_id
p_SD_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
persb_SD_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = maximum_depth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Snow Depth",
    x = "Daily Max Snow Depth (cm))",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_SD_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_SD_corr_plot_accu
```

```{r}
ggsave("persb_SD_corr_plot_accu.png", plot = persb_SD_corr_plot_accu, dpi = 600)
```

```{r}
# Snow Depth Correlation
# Compute R^2 for each tree_id
p_SD_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
persb_SD_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = maximum_depth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Snow Depth",
    x = "Daily Max Snow Depth (cm))",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_SD_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

persb_SD_corr_plot_abla
```

```{r}
ggsave("persb_SD_corr_plot_abla.png", plot = persb_SD_corr_plot_abla, dpi = 600)
```

```{r}
# Wx Station Snow Depth Correlation
# Compute R^2 for each tree_id
p_wxSD_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam, SnowDepth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SnowDepth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
persb_SD_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = SnowDepth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Accumulation, Snow Depth",
    x = "Wx Station Daily Snow Depth (cm))",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_wxSD_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4)

persb_wxSD_corr_plot_accu
```

```{r}
# Wx Station Snow Depth Correlation
# Compute R^2 for each tree_id
p_wxSD_r2_values_abla <- persb_corr_data_abla %>%
  drop_na(well_diam, SnowDepth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SnowDepth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
persb_SD_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = SnowDepth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "PSZ: Ablation, Snow Depth",
    x = "Wx Station Daily Snow Depth (cm))",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_wxSD_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label),
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4)

persb_wxSD_corr_plot_abla
```

### TSZ Tests

```{r}
transb_corr_data_accu <- long_transb_treewell_diams_fullseason_V2 %>%
  # Join with weather data
  inner_join(filtered_daily_transb_wx_15min_r, by = "date") %>%
  inner_join(transb_daily_treetemp_data, by = "date") %>%
  filter(date < "2024-04-01") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)
```

```{r}
transb_corr_data_abla <- long_transb_treewell_diams_fullseason_V2 %>%
  # Join with weather data
  inner_join(filtered_daily_transb_wx_15min_r, by = "date") %>%
  inner_join(transb_daily_treetemp_data, by = "date") %>%
  filter(date >= "2024-04-01" & date <= "2024-04-25") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)
```

```{r}
#PEAK SWE as ablation date
trasb_corr_data_accu_V2 <- long_transb_treewell_diams_fullseason_V2 %>%
  # Join with weather data
  inner_join(filtered_daily_transb_wx_15min_r, by = "date") %>%
  inner_join(transb_daily_treetemp_data, by = "date") %>%
  filter(date <= "2024-03-03") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)

transb_corr_data_abla_V2<- long_transb_treewell_diams_fullseason_V2 %>%
  # Join with weather data
  inner_join(filtered_daily_transb_wx_15min_r, by = "date") %>%
  inner_join(transb_daily_treetemp_data, by = "date") %>%
  filter(date > "2024-03-03" & date <= "2024-04-25") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)
```

```{r}
#ablation beginning at 2ndary peak SWE
trasb_corr_data_accu_V3 <- long_transb_treewell_diams_fullseason_V2 %>%
  # Join with weather data
  inner_join(filtered_daily_transb_wx_15min_r, by = "date") %>%
  inner_join(transb_daily_treetemp_data, by = "date") %>%
  filter(date <= "2024-04-07") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)

transb_corr_data_abla_V3<- long_transb_treewell_diams_fullseason_V2 %>%
  # Join with weather data
  inner_join(filtered_daily_transb_wx_15min_r, by = "date") %>%
  inner_join(transb_daily_treetemp_data, by = "date") %>%
  filter(date > "2024-04-07" & date <= "2024-04-25") %>%
  mutate(well_diam_m = well_diam/100, SnowDepth_m = SnowDepth_cm/100)
```

#### Air Temp

```{r}
# AirTC Correlation
# Compute R^2 for each tree_id
t_AirTC_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, AirTC_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_AirTC_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = AirTC_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Air Temp",
    x = "Air Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_AirTC_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_AirTC_corr_plot_accu
```

```{r}
ggsave("transb_AirTC_corr_plot_accu.png", plot = transb_AirTC_corr_plot_accu, dpi = 600)
```

```{r}
# AirTC Correlation
# Compute R^2 for each tree_id
t_AirTC_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, AirTC_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_AirTC_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = AirTC_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Air Temp",
    x = "Air Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_AirTC_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_AirTC_corr_plot_abla
```

```{r}
ggsave("transb_AirTC_corr_plot_abla.png", plot = transb_AirTC_corr_plot_abla, dpi = 600)
```

#### Tree Temp

```{r}
# Tree Temp Correlation
# Compute R^2 for each tree_id
t_TreeTemp_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, mean_tree_temp) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, mean_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_TreeTemp_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = mean_tree_temp, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Tree Temp",
    x = "Tree Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_TreeTemp_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_TreeTemp_corr_plot_accu
```

```{r}
ggsave("transb_TreeTemp_corr_plot_accu.png", plot = transb_TreeTemp_corr_plot_accu, dpi = 600)
```

```{r}
# Tree Temp Correlation
# Compute R^2 for each tree_id
t_TreeTemp_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, mean_tree_temp) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, mean_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_TreeTemp_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = mean_tree_temp, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Tree Temp",
    x = "Tree Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_TreeTemp_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_TreeTemp_corr_plot_abla
```

```{r}
ggsave("transb_TreeTemp_corr_plot_abla.png", plot = transb_TreeTemp_corr_plot_abla, dpi = 600)
```

Cumulative Daily

```{r}
# Cumulative Daily Tree Temp Correlation
# Compute R^2 for each tree_id
t_cumTreeTemp_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, cum_daily_tree_temp) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, cum_daily_tree_temp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
transb_cumTreeTemp_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = cum_daily_tree_temp, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Cumulative Tree Temperature",
    x = "Cumulative Daily Tree Temperature (°C)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_cumTreeTemp_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_cumTreeTemp_corr_plot_abla
```

Total Cumulative

```{r}
# Cumulative Daily Tree Temp Correlation
# Compute R^2 for each tree_id
t_totalcumTreeTemp_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam_m, totalcum_treetemp) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, totalcum_treetemp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
transb_totalcumTreeTemp_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = totalcum_treetemp, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "b) TSZ",
    x = "Cumulative Tree Temperature (°C)", 
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_x_continuous(labels = scales::label_comma()) + 
  guides(color = "none") +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_totalcumTreeTemp_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

transb_totalcumTreeTemp_corr_plot_accu
```

```{r}
# Cumulative Daily Tree Temp Correlation
# Compute R^2 for each tree_id
t_totalcumTreeTemp_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam_m, totalcum_treetemp) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, totalcum_treetemp, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
transb_totalcumTreeTemp_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = totalcum_treetemp, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "b) TSZ",
    x = "Cumulative Tree Temperature (°C)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
 scale_color_manual(values = treeid_colors) + 
  scale_x_continuous(labels = scales::label_comma()) + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1)) +
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_totalcumTreeTemp_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) +
  theme(panel.spacing = unit(1, "lines")) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

transb_totalcumTreeTemp_corr_plot_abla
```

```{r}
TSZ_totalcum_TreeTemp <- ggarrange(transb_totalcumTreeTemp_corr_plot_accu, transb_totalcumTreeTemp_corr_plot_abla, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "bottom")

TSZ_totalcum_TreeTemp <- annotate_figure(
  TSZ_totalcum_TreeTemp, 
  top = text_grob("b) TSZ", hjust = 0, x = 0.02)
)

TSZ_totalcum_TreeTemp
```

#### Net SW

```{r}
# Net SW Correlation
# Compute R^2 for each tree_id
t_NetSW_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, SWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NetSW_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = SWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Net SW Radiation",
    x = "Net SW Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetSW_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NetSW_corr_plot_accu
```

```{r}
ggsave("transb_NetSW_corr_plot_accu.png", plot = transb_NetSW_corr_plot_accu, dpi = 600)
```

```{r}
# Net SW Correlation
# Compute R^2 for each tree_id
t_NetSW_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, SWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NetSW_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = SWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Net SW Radiation",
    x = "Net SW Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetSW_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NetSW_corr_plot_abla
```

```{r}
ggsave("transb_NetSW_corr_plot_abla.png", plot = transb_NetSW_corr_plot_abla, dpi = 600)
```

#### Net LW

```{r}
# Net LW Correlation
# Compute R^2 for each tree_id
t_NetLW_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, LWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NetLW_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = LWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Net LW Radiation",
    x = "Net LW Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetLW_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NetLW_corr_plot_accu
```

```{r}
ggsave("transb_NetLW_corr_plot_accu.png", plot = transb_NetLW_corr_plot_accu, dpi = 600)
```

```{r}
# Net LW Correlation
# Compute R^2 for each tree_id
t_NetLW_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, LWnet_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NetLW_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = LWnet_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Net LW Radiation",
    x = "Net LW Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetLW_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NetLW_corr_plot_abla
```

```{r}
ggsave("transb_NetLW_corr_plot_abla.png", plot = transb_NetLW_corr_plot_abla, dpi = 600)
```

```{r}
# Net Radiation Correlation
# Compute R^2 for each tree_id
t_NR_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, NR_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NR_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = NR_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Net Radiation",
    x = "Total Net Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NetLW_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NR_corr_plot_accu
```

```{r}
ggsave("transb_NR_corr_plot_accu.png", plot = transb_NR_corr_plot_accu, dpi = 600)
```

```{r}
# Net Radiation Correlation
# Compute R^2 for each tree_id
t_NR_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, NR_Avg) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_NR_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = NR_Avg, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Net Radiation",
    x = "Total Net Radiation (W/m^2)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_NR_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_NR_corr_plot_abla
```

```{r}
ggsave("transb_NR_corr_plot_abla.png", plot = transb_NR_corr_plot_abla, dpi = 600)
```

Daily Cumulative

```{r}
# Cumulative Daily Tree Temp Correlation
# Compute R^2 for each tree_id
t_cumNR_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, cum_NR) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, cum_NR, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  ) 

# Scatterplot
transb_cumNR_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = cum_NR, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Cumulative NR",
    x = "Cumulative Daily Net Radiation (MJ))",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_cumNR_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_cumNR_corr_plot_abla
```

Total Cumulative

```{r}
t_totalcumNR_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam_m, totalcum_NR) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, totalcum_NR, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
transb_totalcumNR_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = totalcum_NR, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "b) TSZ",
    x = "Cumulative Net Radiation (MJ/m²)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_x_continuous(breaks = c(0, 75, 150, 225),
                     labels = c("0", "75", "150", "225")) + 
  scale_y_continuous(
  breaks = c(0.1, 0.2, 0.3, 0.4),  # Manually set your 4 desired breaks
  labels = scales::number_format(accuracy = 0.1)  # Ensure one decimal place
) + 
  expand_limits(x = c(0, 225), y = c(0.1, 0.4)) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_totalcumNR_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

transb_totalcumNR_corr_plot_accu
```

```{r}
t_totalcumNR_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam_m, totalcum_NR) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, totalcum_NR, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  ) 

# Scatterplot
transb_totalcumNR_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = totalcum_NR, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "b) TSZ",
    x = "Cumulative Net Radiation (MJ/m²)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_x_continuous(labels = scales::label_comma()) +
  scale_y_continuous(breaks = c(0.3, 0.6, 0.9, 1.2),
                     labels = c("0.3", "0.6", "0.9", "1.2"))+
  expand_limits(y = c(0.3, 1.2)) + 
  # Remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_totalcumNR_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

transb_totalcumNR_corr_plot_abla
```

```{r}
TSZ_totalcum_NR <- ggarrange(transb_totalcumNR_corr_plot_accu, transb_totalcumNR_corr_plot_abla, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "bottom")

TSZ_totalcum_NR <- annotate_figure(
  TSZ_totalcum_NR, 
  top = text_grob("b) TSZ", hjust = 0, x = 0.02)
)

TSZ_totalcum_NR
```

#### Snow Depth

```{r}
# Snow Depth Correlation
# Compute R^2 for each tree_id
t_SD_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_SD_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = maximum_depth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Snow Depth",
    x = "Daily Maximum Snow Depth (cm)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_SD_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_SD_corr_plot_accu
```

```{r}
ggsave("transb_SD_corr_plot_accu.png", plot = transb_SD_corr_plot_accu, dpi = 600)
```

```{r}
# Snow Depth Correlation
# Compute R^2 for each tree_id
t_SD_r2_values_abla <- transb_corr_data_abla%>%
  drop_na(well_diam, maximum_depth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, maximum_depth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_SD_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = maximum_depth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Snow Depth",
    x = "Daily Maximum Snow Depth (cm)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_SD_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_SD_corr_plot_abla
```

```{r}
ggsave("transb_SD_corr_plot_abla.png", plot = transb_SD_corr_plot_abla, dpi = 600)
```

```{r}
# Weather Station Snow Depth Correlation
# Compute R^2 for each tree_id
t_wxSD_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam, SnowDepth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SnowDepth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_wxSD_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = SnowDepth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Accumulation, Snow Depth",
    x = "Weather Station Snow Depth (cm)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_wxSD_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_wxSD_corr_plot_accu
```

```{r}
# Weather Station Snow Depth Correlation
# Compute R^2 for each tree_id
t_wxSD_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam, SnowDepth_cm) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam, SnowDepth_cm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    R2_label = paste0(
      "R² = ", round(R2, 3), "\n",
      "P-value = ", signif(p_value, 3), "\n"
    )  # Include CI in the label
  )

# Scatterplot
transb_wxSD_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = SnowDepth_cm, y = well_diam, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "TSZ: Ablation, Snow Depth",
    x = "Weather Station Snow Depth (cm)",
    y = "Well Diameter (cm)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_wxSD_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

transb_wxSD_corr_plot_abla
```

### Arranging Plots

```{r}
#Tree Temp
comb_corr_treetemp <- ggarrange(PSZ_totalcum_TreeTemp, TSZ_totalcum_TreeTemp, nrow = 2, ncol = 1, common.legend = TRUE, legend = "bottom")

comb_corr_treetemp
```

```{r}
ggsave("comb_corr_treetemp.png", width = 8, height = 10, plot = comb_corr_treetemp, dpi = 600)
```

```{r}
#NR
comb_corr_NR<- ggarrange(PSZ_totalcum_NR, TSZ_totalcum_NR, nrow = 2, ncol = 1, common.legend = TRUE, legend = "none", align = "hv")

comb_corr_NR
```

```{r}
ggsave("comb_corr_NR.png", width = 8, height = 10, plot = comb_corr_NR, dpi = 600)
```

#### Individual Plots

V2 - by accumulation and ablation season

Tree Temp

```{r}
persb_totalcumTreeTemp_corr_plot_accu <- persb_totalcumTreeTemp_corr_plot_accu +
  theme(plot.margin = margin(10, 15, 10, 10))  # top, right, bottom, left

persb_totalcumTreeTemp_corr_plot_accu

transb_totalcumTreeTemp_corr_plot_accu <- transb_totalcumTreeTemp_corr_plot_accu +
  theme(plot.margin = margin(10, 15, 10, 10))

transb_totalcumTreeTemp_corr_plot_accu
```

```{r}
comb_totalcumTreeTemp_accu <- ggarrange(persb_totalcumTreeTemp_corr_plot_accu, transb_totalcumTreeTemp_corr_plot_accu, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "bottom")

comb_totalcumTreeTemp_accu
```

```{r}
ggsave("comb_totalcumTreeTemp_accu.png", width = 7.5, height = 6, plot = comb_totalcumTreeTemp_accu, dpi = 600)
```

```{r}
persb_totalcumTreeTemp_corr_plot_abla <- persb_totalcumTreeTemp_corr_plot_abla +
  theme(plot.margin = margin(10, 15, 10, 10))  # top, right, bottom, left

persb_totalcumTreeTemp_corr_plot_abla

transb_totalcumTreeTemp_corr_plot_abla <- transb_totalcumTreeTemp_corr_plot_abla +
  theme(plot.margin = margin(10, 15, 10, 10))

transb_totalcumTreeTemp_corr_plot_abla
```

```{r}
comb_totalcumTreeTemp_abla <- ggarrange(persb_totalcumTreeTemp_corr_plot_abla, transb_totalcumTreeTemp_corr_plot_abla, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "bottom")

comb_totalcumTreeTemp_abla
```

```{r}
ggsave("comb_totalcumTreeTemp_abla.png", width = 7.5, height = 6, plot = comb_totalcumTreeTemp_abla, dpi = 600)
```

NR

```{r}
comb_totalcumNR_abla <- ggarrange(persb_totalcumNR_corr_plot_abla, transb_totalcumNR_corr_plot_abla, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "bottom")

comb_totalcumNR_abla
```

```{r}
ggsave("comb_totalcumNR_abla.png", width = 7.5, height = 6, plot = comb_totalcumNR_abla, dpi = 600)
```

```{r}
comb_totalcumNR_accu <- ggarrange(persb_totalcumNR_corr_plot_accu, transb_totalcumNR_corr_plot_accu, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "bottom")

comb_totalcumNR_accu
```

```{r}
ggsave("comb_totalcumNR_accu.png", width = 7.5, height = 6, plot = comb_totalcumNR_accu, dpi = 600)
```

## Tree Temp Correlation

Correlating tree temp with various energy budget values, during accumulation and ablation

### Cumulative

#### PSZ

Air temp

```{r}
# AirTC Correlation
p_AirTree_accu_results <- persb_corr_data_accu %>%
  drop_na(mean_tree_temp, totalcum_AirTC) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, totalcum_AirTC, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

p_AirTree_abla_results <- persb_corr_data_abla %>%
  drop_na(mean_tree_temp, totalcum_AirTC) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, totalcum_AirTC, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
p_cum_AirTree_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = mean_tree_temp, y = totalcum_AirTC)) +
  geom_point(color ="#2166AC", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "a) PSZ Accumulation",
    x = "Air Temperature (°C)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_AirTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_cum_AirTree_corr_plot_accu
```

```{r}
p_cum_AirTree_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = mean_tree_temp, y = totalcum_AirTC)) +
  geom_point(color ="#2166AC", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "b) PSZ Ablation",
    x = "Air Temperature (°C)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_AirTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_cum_AirTree_corr_plot_abla
```

SW

```{r}
p_SWTree_accu_results <- persb_corr_data_accu %>%
  drop_na(mean_tree_temp, totalcum_SWnet) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, totalcum_SWnet, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

p_SWTree_abla_results <- persb_corr_data_abla %>%
  drop_na(mean_tree_temp, totalcum_SWnet) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, totalcum_SWnet, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
p_cum_SWTree_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = mean_tree_temp, y = totalcum_SWnet)) +
  geom_point(color ="#D95F02", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "a) PSZ Accumulation",
    x = "Net Shortwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_SWTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_cum_SWTree_corr_plot_accu
```

```{r}
p_cum_SWTree_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = mean_tree_temp, y = totalcum_SWnet)) +
  geom_point(color ="#D95F02", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "b) PSZ Ablation",
    x = "Net Shortwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_SWTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_cum_SWTree_corr_plot_abla
```

LW

```{r}
p_LWTree_accu_results <- persb_corr_data_accu %>%
  drop_na(mean_tree_temp, totalcum_LWnet) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, totalcum_LWnet, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

p_LWTree_abla_results <- persb_corr_data_abla %>%
  drop_na(mean_tree_temp, totalcum_LWnet) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, totalcum_LWnet, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
p_cum_LWTree_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = mean_tree_temp, y = totalcum_LWnet)) +
  geom_point(color ="#1B7837", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "a) PSZ Accumulation",
    x = "Net Longwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_LWTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_cum_LWTree_corr_plot_accu
```

```{r}
p_cum_LWTree_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = mean_tree_temp, y = totalcum_LWnet)) +
  geom_point(color ="#1B7837", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "b) PSZ Ablation",
    x = "Net Longwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_LWTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_cum_LWTree_corr_plot_abla
```

NR

```{r}
p_NRTree_accu_results <- persb_corr_data_accu %>%
  drop_na(mean_tree_temp, totalcum_NR) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, totalcum_NR, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

p_NRTree_abla_results <- persb_corr_data_abla %>%
  drop_na(mean_tree_temp, totalcum_NR) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, totalcum_NR, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
p_cum_NRTree_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = mean_tree_temp, y = totalcum_NR)) +
  geom_point(color ="#1B7837", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "a) PSZ Accumulation",
    x = "Total Net Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NRTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_cum_NRTree_corr_plot_accu
```

```{r}
p_cum_NRTree_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = mean_tree_temp, y = totalcum_NR)) +
  geom_point(color ="#1B7837", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "b) PSZ Ablation",
    x = "Total Net Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_NRTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_cum_NRTree_corr_plot_abla
```

#### TSZ

\*\* have not plotted these yet

Air Temp

```{r}
# AirTC Correlation
t_AirTree_accu_results <- transb_corr_data_accu %>%
  drop_na(totalcum_treetemp, totalcum_AirTC) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(totalcum_treetemp, totalcum_AirTC, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

t_AirTree_abla_results <- transb_corr_data_abla %>%
  drop_na(totalcum_treetemp, totalcum_AirTC) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(totalcum_treetemp, totalcum_AirTC, use = "complete.obs")),
    .groups = "drop"
  ) %>%
 mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

SW

```{r}
t_SWTree_accu_results <- transb_corr_data_accu %>%
  drop_na(totalcum_treetemp, totalcum_SWnet) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(totalcum_treetemp, totalcum_SWnet, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

t_SWTree_abla_results <- transb_corr_data_abla %>%
  drop_na(totalcum_treetemp, totalcum_SWnet) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(totalcum_treetemp, totalcum_SWnet, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

LW

```{r}
t_LWTree_accu_results <- transb_corr_data_accu %>%
  drop_na(totalcum_treetemp, totalcum_LWnet) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(totalcum_treetemp, totalcum_LWnet, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

t_LWTree_abla_results <- transb_corr_data_abla %>%
  drop_na(totalcum_treetemp, totalcum_LWnet) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(totalcum_treetemp, totalcum_LWnet, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

NR

```{r}
t_NRTree_accu_results <- transb_corr_data_accu %>%
  drop_na(totalcum_treetemp, totalcum_NR) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(totalcum_treetemp, totalcum_NR, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

t_NRTree_abla_results <- transb_corr_data_abla %>%
  drop_na(totalcum_treetemp, totalcum_NR) %>%
  #don't have to group by tree, because this data is just comparing the weather station data, not tree data!
  #group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(totalcum_treetemp, totalcum_NR, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

### Daily Mean

#### PSZ

\
Air Temp

```{r}
p_dailyAirTree_accu_results <- persb_corr_data_accu %>%
  drop_na(mean_tree_temp, AirTC_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )


p_dailyAirTree_abla_results <- persb_corr_data_abla%>%
  drop_na(mean_tree_temp, AirTC_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
p_daily_AirTree_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = mean_tree_temp, y = AirTC_Avg)) +
  geom_point(color ="#2166AC", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "a) PSZ Accumulation",
    x = "Air Temperature (°C)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_dailyAirTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_daily_AirTree_corr_plot_accu
```

```{r}
p_daily_AirTree_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = mean_tree_temp, y = AirTC_Avg)) +
  geom_point(color = "#2166AC", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "b) PSZ Ablation",
    x = "Air Temperature (°C)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_dailyAirTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_daily_AirTree_corr_plot_abla
```

SW

```{r}
p_dailySWTree_accu_results <- persb_corr_data_accu %>%
  drop_na(mean_tree_temp, SWnet_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
    mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

p_dailySWTree_abla_results <- persb_corr_data_abla %>%
  drop_na(mean_tree_temp, SWnet_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
p_daily_SWTree_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = mean_tree_temp, y = SWnet_Avg)) +
  geom_point(color = "#D95F02", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "a) PSZ Accumulation",
    x = "Net Shortwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_dailySWTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_daily_SWTree_corr_plot_accu
```

```{r}
p_daily_SWTree_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = mean_tree_temp, y = SWnet_Avg)) +
  geom_point(color = "#D95F02", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "b) PSZ Ablation",
    x = "Net Shortwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
  #scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_dailySWTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_daily_SWTree_corr_plot_abla
```

LW

```{r}
p_dailyLWTree_accu_results <- persb_corr_data_accu %>%
  drop_na(mean_tree_temp, LWnet_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

p_dailyLWTree_abla_results <- persb_corr_data_abla %>%
  drop_na(mean_tree_temp, LWnet_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
p_daily_LWTree_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = mean_tree_temp, y = LWnet_Avg)) +
  geom_point(color = "#1B7837", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "a) PSZ Accumulation",
    x = "Net Longwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_dailyLWTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_daily_LWTree_corr_plot_accu
```

```{r}
p_daily_LWTree_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = mean_tree_temp, y = LWnet_Avg)) +
  geom_point(color = "#1B7837", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "b) PSZ Ablation",
    x = "Net Longwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_dailyLWTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_daily_LWTree_corr_plot_abla
```

NR

```{r}
p_dailyNRTree_accu_results <- persb_corr_data_accu %>%
  drop_na(mean_tree_temp, NR_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

p_dailyNRTree_abla_results <- persb_corr_data_abla %>%
  drop_na(mean_tree_temp, NR_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
p_daily_NRTree_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = mean_tree_temp, y = NR_Avg)) +
  geom_point(color = "grey23", size = 2, alpha = 0.5) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "a) PSZ Accumulation",
    x = "Total Net Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_dailyNRTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_daily_NRTree_corr_plot_accu
```

```{r}
p_daily_NRTree_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = mean_tree_temp, y = NR_Avg)) +
  geom_point(color = "grey23", size = 2, alpha = 0.5) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "b) PSZ Ablation",
    x = "Total Net Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_dailyNRTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

p_daily_NRTree_corr_plot_abla
```

#### TSZ

Air Temp

```{r}
t_dailyAirTree_accu_results <- transb_corr_data_accu %>%
  drop_na(mean_tree_temp, AirTC_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

t_dailyAirTree_abla_results <- transb_corr_data_abla%>%
  drop_na(mean_tree_temp, AirTC_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, AirTC_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
t_daily_AirTree_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = mean_tree_temp, y = AirTC_Avg)) +
  geom_point(color = "#2166AC", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "c) TSZ Accumulation",
    x = "Air Temperature (°C)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_dailyAirTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

t_daily_AirTree_corr_plot_accu
```

```{r}
t_daily_AirTree_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = mean_tree_temp, y = AirTC_Avg)) +
  geom_point(color = "#2166AC", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "d) TSZ Ablation",
    x = "Air Temperature (°C)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_dailyAirTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

t_daily_AirTree_corr_plot_abla
```

SW

```{r}
t_dailySWTree_accu_results <- transb_corr_data_accu %>%
  drop_na(mean_tree_temp, SWnet_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

t_dailySWTree_abla_results <- transb_corr_data_abla %>%
  drop_na(mean_tree_temp, SWnet_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, SWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
t_daily_SWTree_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = mean_tree_temp, y = SWnet_Avg)) +
  geom_point(color = "#D95F02", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "c) TSZ Accumulation",
    x = "Net Shortwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_dailySWTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

t_daily_SWTree_corr_plot_accu
```

```{r}
t_daily_SWTree_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = mean_tree_temp, y = SWnet_Avg)) +
  geom_point(color = "#D95F02", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "d) TSZ Ablation",
    x = "Net Shortwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_dailySWTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

t_daily_SWTree_corr_plot_abla
```

LW

```{r}
t_dailyLWTree_accu_results <- transb_corr_data_accu %>%
  drop_na(mean_tree_temp, LWnet_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

t_dailyLWTree_abla_results <- transb_corr_data_abla %>%
  drop_na(mean_tree_temp, LWnet_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, LWnet_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
t_daily_LWTree_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = mean_tree_temp, y = LWnet_Avg)) +
  geom_point(color = "#1B7837", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "c) TSZ Accumulation",
    x = "Net Longwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_dailyLWTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

t_daily_LWTree_corr_plot_accu
```

```{r}
t_daily_LWTree_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = mean_tree_temp, y = LWnet_Avg)) +
  geom_point(color = "#1B7837", size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "d) TSZ Ablation",
    x = "Net Longwave Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_dailyLWTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

t_daily_LWTree_corr_plot_abla
```

NR

```{r}
t_dailyNRTree_accu_results <- transb_corr_data_accu %>%
  drop_na(mean_tree_temp, NR_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )

t_dailyNRTree_abla_results <- transb_corr_data_abla %>%
  drop_na(mean_tree_temp, NR_Avg) %>%
  filter(tree_id == "1") %>%
  summarize(
    cor_test = list(cor.test(mean_tree_temp, NR_Avg, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
t_daily_NRTree_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = mean_tree_temp, y = NR_Avg)) +
  geom_point(color = "grey23", size = 2, alpha = 0.5) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "c) TSZ Accumulation",
    x = "Total Net Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_dailyNRTree_accu_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

t_daily_NRTree_corr_plot_accu
```

```{r}
t_daily_NRTree_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = mean_tree_temp, y = NR_Avg)) +
  geom_point(color = "grey23", size = 2, alpha = 0.5) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  #facet_wrap(~ tree_id) +  # Separate by tree_id
  labs(
    title = "d) TSZ Ablation",
    x = "Total Net Radiation (W/m^2)",
    y = "Tree Surface Temperature (°C)",
    color = "Tree ID"
  ) +
  theme_bw() +
  #remove color legend 
  guides(color = "none") +
 # scale_shape_manual(name = "Burn Status", values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_dailyNRTree_abla_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4)

t_daily_NRTree_corr_plot_abla
```

#### Saving all Daily Plots

```{r}
#AirTemp
comb_daily_AirTree <- ggarrange(p_daily_AirTree_corr_plot_accu, p_daily_AirTree_corr_plot_abla, t_daily_AirTree_corr_plot_accu, t_daily_AirTree_corr_plot_abla, nrow = 2, ncol = 2)

comb_daily_AirTree
```

```{r}
ggsave("comb_daily_AirTree.png", plot = comb_daily_AirTree, dpi = 600)
```

```{r}
#Shortwave Radiation
comb_daily_SWTree <- ggarrange(p_daily_SWTree_corr_plot_accu, p_daily_SWTree_corr_plot_abla, t_daily_SWTree_corr_plot_accu, t_daily_SWTree_corr_plot_abla, nrow = 2, ncol = 2)

comb_daily_SWTree
```

```{r}
ggsave("comb_daily_SWTree.png", plot = comb_daily_SWTree, dpi = 600)
```

```{r}
#Longwave Radiation
comb_daily_LWTree <- ggarrange(p_daily_LWTree_corr_plot_accu, p_daily_LWTree_corr_plot_abla, t_daily_LWTree_corr_plot_accu, t_daily_LWTree_corr_plot_abla, nrow = 2, ncol = 2)

comb_daily_LWTree
```

```{r}
ggsave("comb_daily_LWTree.png", plot = comb_daily_LWTree, dpi = 600)
```

```{r}
#Total Net Radiation
comb_daily_NRTree <- ggarrange(p_daily_NRTree_corr_plot_accu, p_daily_NRTree_corr_plot_abla, t_daily_NRTree_corr_plot_accu, t_daily_NRTree_corr_plot_abla, nrow = 2, ncol = 2)

comb_daily_NRTree
```

```{r}
ggsave("comb_daily_NRTree.png", plot = comb_daily_NRTree, dpi = 600)
```

## Volume Calculations

### Data Wrangling

####  PSZ

```{r}
vol_persb_corr_data_accu <- persb_corr_data_accu %>%
  #group_by(date, tree_id) %>%
  mutate(rad_treewell_cm2 = well_diam/2, 
         vol_treewell_cm3 = (2/3) * pi * rad_treewell_cm2^3, 
         #radius of cylinder w/ diameter of 150 cm
         rad_cylinder_cm2 = 150/2,
         #creating the volume of the tree using snow camera snowdepth
         vol_treedsnow_cm3 = pi * rad_cylinder_cm2^2 * maximum_depth_cm, 
         #volumne of treed area with treewell subtracted
         vol_tree_cm3 = vol_treedsnow_cm3 - vol_treewell_cm3, 
         #creating the volume of the snow under sensor
         vol_sensor_cm3 = pi * rad_cylinder_cm2^2 * SnowDepth_cm, 
         #converting volumne to m^3
         vol_sensor_m3 = vol_sensor_cm3/1e6,
         vol_tree_m3 = vol_tree_cm3/1e6)

vol_persb_corr_data_abla <- persb_corr_data_abla %>%
  #group_by(date, tree_id) %>%
  mutate(rad_treewell_cm2 = well_diam/2, 
         vol_treewell_cm3 = (2/3) * pi * rad_treewell_cm2^3, 
         #radius of cylinder w/ diameter of 150 cm
         rad_cylinder_cm2 = 150/2,
         #creating the volume of the tree using snow camera snowdepth
         vol_treedsnow_cm3 = pi * rad_cylinder_cm2^2 * maximum_depth_cm, 
         #volumne of treed area with treewell subtracted
         vol_tree_cm3 = vol_treedsnow_cm3 - vol_treewell_cm3, 
         #creating the volume of the snow under sensor
         vol_sensor_cm3 = pi * rad_cylinder_cm2^2 * SnowDepth_cm, 
         #converting volumne to m^3
         vol_sensor_m3 = vol_sensor_cm3/1e6,
         vol_tree_m3 = vol_tree_cm3/1e6)
```

```{r}
#full season volume dataframe
fullseason_vol_persb <- rbind(vol_persb_corr_data_accu, vol_persb_corr_data_abla) %>%
  select(-time_mst) %>%
  mutate(season = case_when(
    date < as.Date("2024-05-06") ~ "accumulation",
    date >= as.Date("2024-05-06") ~ "ablation"
  )) %>%
  select(date, zone, conditions, treewell_developed, reset, season, burn_status, tree_id, everything())
```

```{r}
#PEAK SWE as ablation date - V2
fullseason_vol_persb_V2 <- rbind(vol_persb_corr_data_accu, vol_persb_corr_data_abla) %>%
  select(-time_mst) %>%
  mutate(season = case_when(
    date <= as.Date("2024-04-06") ~ "accumulation",
    date > as.Date("2024-04-06") ~ "ablation"
  )) %>%
  select(date, zone, conditions, treewell_developed, reset, season, burn_status, tree_id, everything())
```

```{r}
#PEAK SWE as ablation date - V2
fullseason_vol_persb_V3 <- rbind(vol_persb_corr_data_accu, vol_persb_corr_data_abla) %>%
  select(-time_mst) %>%
  mutate(season = case_when(
    date <= as.Date("2024-04-28") ~ "accumulation",
    date > as.Date("2024-04-28") ~ "ablation"
  )) %>%
  select(date, zone, conditions, treewell_developed, reset, season, burn_status, tree_id, everything())
```

```{r}
#creating a new dataframe for the SNOW volume calcs that extends entire season where snowpack is on the ground for the open area
vol_persb_daily_wx_fullseason <- filtered_daily_persb_wx_hourly_r %>%
  mutate(SnowDepth_m = SnowDepth_cm/100) %>%
  mutate(rad_cylinder_cm2 = 150/2,
         vol_sensor_cm3 = pi * rad_cylinder_cm2^2 * SnowDepth_cm, 
         #converting volumne to m^3
         vol_sensor_m3 = vol_sensor_cm3/1e6) %>%
  filter(date < "2024-06-01")
```

#### TSZ

```{r}
vol_transb_corr_data_accu <- transb_corr_data_accu %>%
  select(-id) %>%
  #group_by(date, tree_id) %>%
  mutate(rad_treewell_cm2 = well_diam/2, 
         vol_treewell_cm3 = (2/3) * pi * rad_treewell_cm2^3, 
         #radius of cylinder w/ diameter of 150 cm
         rad_cylinder_cm2 = 150/2,
         #creating the volume of the tree using snow camera snowdepth
         vol_treedsnow_cm3 = pi * rad_cylinder_cm2^2 * maximum_depth_cm, 
         #volumne of treed area with treewell subtracted
         vol_tree_cm3 = vol_treedsnow_cm3 - vol_treewell_cm3, 
         #creating the volume of the snow under sensor
         vol_sensor_cm3 = pi * rad_cylinder_cm2^2 * SnowDepth_cm, 
         #converting volumne to m^3
         vol_sensor_m3 = vol_sensor_cm3/1e6,
         vol_tree_m3 = vol_tree_cm3/1e6)
```

```{r}
vol_transb_corr_data_abla <- transb_corr_data_abla %>%
  select(-c(id, tree_diam_m)) %>%
  #group_by(date, tree_id) %>%
  mutate(rad_treewell_cm2 = well_diam/2, 
         vol_treewell_cm3 = (2/3) * pi * rad_treewell_cm2^3, 
         #radius of cylinder w/ diameter of 150 cm
         rad_cylinder_cm2 = 150/2,
         #creating the volume of the tree using snow camera snowdepth
         vol_treedsnow_cm3 = pi * rad_cylinder_cm2^2 * maximum_depth_cm, 
         #volumne of treed area with treewell subtracted
         vol_tree_cm3 = vol_treedsnow_cm3 - vol_treewell_cm3, 
         #creating the volume of the snow under sensor
         vol_sensor_cm3 = pi * rad_cylinder_cm2^2 * SnowDepth_cm, 
         #converting volumne to m^3
         vol_sensor_m3 = vol_sensor_cm3/1e6,
         vol_tree_m3 = vol_tree_cm3/1e6)
```

```{r}
#full season volume dataframe
fullseason_vol_transb <- rbind(vol_transb_corr_data_accu, vol_transb_corr_data_abla) %>%
  select(-c(species, mortality, time_mst)) %>%
  mutate(season = case_when(
    date < as.Date("2024-04-01") ~ "accumulation",
    date >= as.Date("2024-04-01") ~ "ablation"
  )) %>%
  select(date, zone, conditions, treewell_developed, reset, season, burn_status, tree_id, everything())
```

```{r}
# peak SWE defined as beginning of ablation
fullseason_vol_transb_V2 <- rbind(vol_transb_corr_data_accu, vol_transb_corr_data_abla) %>%
  select(-c(species, mortality, time_mst)) %>%
  mutate(season = case_when(
    date <= as.Date("2024-03-03") ~ "accumulation",
    date > as.Date("2024-03-03") ~ "ablation"
  )) %>%
  select(date, zone, conditions, treewell_developed, reset, season, burn_status, tree_id, everything())
```

```{r}
# ablation beginning at secondary peak SWE
fullseason_vol_transb_V3 <- rbind(vol_transb_corr_data_accu, vol_transb_corr_data_abla) %>%
  select(-c(species, mortality, time_mst)) %>%
  mutate(season = case_when(
    date <= as.Date("2024-04-07") ~ "accumulation",
    date > as.Date("2024-04-07") ~ "ablation"
  )) %>%
  select(date, zone, conditions, treewell_developed, reset, season, burn_status, tree_id, everything())
```

```{r}
vol_transb_daily_wx_fullseason <- filtered_daily_transb_wx_15min_r %>%
  mutate(SnowDepth_m = SnowDepth_cm/100) %>%
  mutate(rad_cylinder_cm2 = 150/2,
         vol_sensor_cm3 = pi * rad_cylinder_cm2^2 * SnowDepth_cm, 
         #converting volumne to m^3
         vol_sensor_m3 = vol_sensor_cm3/1e6) %>%
  filter(date <= "2024-05-12") 



%>%
  #getting rid of some weird data
  filter(!date %in% as.Date(c("2024-03-12", "2024-03-13", "2024-03-14", "2024-03-15", "2024-03-16", "2024-03-17")))
```

```{r}
fullseason_vol_persb <- fullseason_vol_persb %>%
  mutate(well_diam_m = well_diam/100, maximum_depth_m = maximum_depth_cm/100)

fullseason_vol_persb_V2 <- fullseason_vol_persb_V2 %>%
  mutate(well_diam_m = well_diam/100, maximum_depth_m = maximum_depth_cm/100)

fullseason_vol_persb_V3 <- fullseason_vol_persb_V3 %>%
  mutate(well_diam_m = well_diam/100, maximum_depth_m = maximum_depth_cm/100)
```

```{r}
fullseason_vol_transb <- fullseason_vol_transb %>%
  mutate(well_diam_m = well_diam/100, maximum_depth_m = maximum_depth_cm/100)

fullseason_vol_transb_V2 <- fullseason_vol_transb_V2 %>%
  mutate(well_diam_m = well_diam/100, maximum_depth_m = maximum_depth_cm/100)

fullseason_vol_transb_V3 <- fullseason_vol_transb_V3 %>%
  mutate(well_diam_m = well_diam/100, maximum_depth_m = maximum_depth_cm/100)
```

### Plotting

####  PSZ

```{r}
#correlation... don't know if I am running this yet!
p_vol_SWE_corr_results <- fullseason_vol_persb %>%
  drop_na(well_diam_m, maximum_depth_m) %>%  # Remove rows where either column is NA
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, maximum_depth_m, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R² (square of correlation coefficient)
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    R2_label = paste0("R² = ", round(R2, 3), ", p = ", signif(p_value, 3))
  ) %>%
  select(-cor_test)  # Remove the list column
```

```{r}
persb_col_tree1 <- fullseason_vol_persb%>%
  filter(tree_id == "1", vol_tree_m3 >= 0)
  
persb_col_tree2 <- fullseason_vol_persb%>%
  filter(tree_id == "2", vol_tree_m3 >= 0)

persb_col_tree3 <- fullseason_vol_persb%>%
  filter(tree_id == "3", vol_tree_m3 >= 0)

persb_col_tree4 <- fullseason_vol_persb%>%
  filter(tree_id == "4", vol_tree_m3 >= 0)
```

```{r}
persb_vol_SWE_fullseason_lineplot_V3 <- ggplot() + 
  # Line denoting ablation season
  geom_vline(xintercept = as.Date('2024-04-28'), color = "grey23", linetype = "dashed", linewidth = 0.6, alpha = 0.7) +
  geom_line(data = vol_persb_daily_wx_fullseason, aes(x = date, y = vol_sensor_m3, color = "open area", linetype = "open area"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = persb_col_tree1, aes(x = date, y = vol_tree_m3, color = "tree 1", linetype = "tree 1"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = persb_col_tree2, aes(x = date, y = vol_tree_m3, color = "tree 2", linetype = "tree 2"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = persb_col_tree3, aes(x = date, y = vol_tree_m3, color = "tree 3", linetype = "tree 3"), linewidth = 0.8, alpha = 0.8) +
  geom_line(data = persb_col_tree4, aes(x = date, y = vol_tree_m3, color = "tree 4", linetype = "tree 4"), linewidth = 0.8, alpha = 0.8) +  
  facet_wrap(~ tree_id, nrow = 1, ncol = 4) +  
  labs(
    title = "a) PSZ",
    x = NULL,
    y = "Snow Volume (m³)",
    color = NULL,
    linetype = NULL  # This ensures linetype and color share the same legend
  ) +
  theme_bw() +
  scale_y_continuous(limits = c(0, 3)) + 
  scale_x_date(
  limits = c(as.Date("2024-02-02"), as.Date("2024-06-01")),
  breaks = as.Date(c("2024-02-01", "2024-03-01", "2024-04-01", "2024-05-01", "2024-06-01")),  
  minor_breaks = "1 month",  # Adds light grid lines for all months
  date_labels = "%b") +
  # Custom colors
  scale_color_manual(values = c("open area" = "grey30", 
                                "tree 1" = "#1B7837", 
                                "tree 2" = "#D95F02", 
                                "tree 3" = "#2166AC", 
                                "tree 4" = "grey10")) +

  # Only tree 4 gets a dashed line, all others solid
  scale_linetype_manual(values = c("open area" = "solid",
                                   "tree 1" = "solid",
                                   "tree 2" = "solid",
                                   "tree 3" = "solid",
                                   "tree 4" = "dashed")) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 10),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  ) + 
  theme(
    legend.key.width = unit(1, "cm"),  # Increase the width of the legend keys
    legend.key.height = unit(0.85, "cm"))

persb_vol_SWE_fullseason_lineplot_V3
```

#### TSZ

```{r}
transb_col_tree1 <- fullseason_vol_transb %>%
  filter(tree_id == "1", vol_tree_m3 >= 0)

#%>%
  #getting rid of some weird data
  #filter(!date %in% as.Date(c("2024-03-12", "2024-03-13", "2024-03-14", "2024-03-15", "2024-03-16", "2024-03-17")))
  
transb_col_tree2 <- fullseason_vol_transb %>%
  filter(tree_id == "2", vol_tree_m3 >= 0) %>%
  #getting rid of some weird data
  filter(!date %in% as.Date(c("2024-03-12", "2024-03-13", "2024-03-14", "2024-03-15", "2024-03-16", "2024-03-17")))

transb_col_tree3 <- fullseason_vol_transb %>%
  filter(tree_id == "3", vol_tree_m3 >= 0) %>%
  #getting rid of some weird data
  filter(!date %in% as.Date(c("2024-03-12", "2024-03-13", "2024-03-14", "2024-03-15", "2024-03-16", "2024-03-17")))

transb_col_tree4 <- fullseason_vol_transb %>%
  filter(tree_id == "4", vol_tree_m3 >= 0) %>%
  #getting rid of some weird data
  filter(!date %in% as.Date(c("2024-03-12", "2024-03-13", "2024-03-14", "2024-03-15", "2024-03-16", "2024-03-17")))
```

```{r}
transb_vol_SWE_fullseason_lineplot_V3 <- ggplot() + 
  # Line denoting ablation season
  geom_vline(xintercept = as.Date('2024-04-07'), color = "grey23", linetype = "dashed", linewidth = 0.6, alpha = 0.7) +
  geom_line(data = vol_transb_daily_wx_fullseason, aes(x = date, y = vol_sensor_m3, color = "open area", linetype = "open area"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = transb_col_tree1, aes(x = date, y = vol_tree_m3, color = "tree 1", linetype = "tree 1"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = transb_col_tree2, aes(x = date, y = vol_tree_m3, color = "tree 2", linetype = "tree 2"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = transb_col_tree3, aes(x = date, y = vol_tree_m3, color = "tree 3", linetype = "tree 3"), linewidth = 0.8, alpha = 0.8) +
  geom_line(data = transb_col_tree4, aes(x = date, y = vol_tree_m3, color = "tree 4", linetype = "tree 4"), linewidth = 0.8, alpha = 0.8) +  
  facet_wrap(~ tree_id, nrow = 1, ncol = 4) +  
  labs(
    title = "b) TSZ",
    x = "Date",
    y = "Snow Volume (m³)",
    color = NULL,
    linetype = NULL  # This ensures linetype and color share the same legend
  ) +
  theme_bw() +
  scale_y_continuous(limits = c(0, 3)) + 
  scale_x_date(
  limits = c(as.Date("2024-02-02"), as.Date("2024-06-01")),
  breaks = as.Date(c("2024-02-01", "2024-03-01", "2024-04-01", "2024-05-01", "2024-06-01")), 
  minor_breaks = "1 month",  # Adds light grid lines for all months
  date_labels = "%b"
) + 
  # Custom colors
  scale_color_manual(values = c("open area" = "grey30", 
                                "tree 1" = "#1B7837", 
                                "tree 2" = "#D95F02", 
                                "tree 3" = "#2166AC", 
                                "tree 4" = "grey10")) +

  # Only tree 4 gets a dashed line, all others solid
  scale_linetype_manual(values = c("open area" = "solid",
                                   "tree 1" = "solid",
                                   "tree 2" = "solid",
                                   "tree 3" = "solid",
                                   "tree 4" = "dashed")) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 10),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  ) + 
  theme(
    legend.key.width = unit(1, "cm"),  # Increase the width of the legend keys
    legend.key.height = unit(0.85, "cm"))

transb_vol_SWE_fullseason_lineplot_V3
```

#### Combining plots

```{r}
comb_fullseason_snowvol_V3 <- ggarrange(persb_vol_SWE_fullseason_lineplot_V3, transb_vol_SWE_fullseason_lineplot_V3, nrow = 2, ncol = 1, common.legend = TRUE, legend = "bottom")

comb_fullseason_snowvol_V3
```

```{r}
ggsave("comb_fullseason_snowvol_V3.png", 
       height = 5.5, 
       width = 8, 
       plot = comb_fullseason_snowvol_V3, dpi = 600)
```

```{r}
#ablation ONLY combined plot

comb_abla_SWEvol <- ggarrange(persb_vol_SWE_abla_lineplot, transb_vol_SWE_abla_lineplot, nrow = 2, ncol = 1, common.legend = TRUE, legend = "bottom")

comb_abla_SWEvol
```

```{r}
ggsave("comb_abla_SWEvol.png", height = 5, width = 8, plot = comb_abla_SWEvol, dpi = 600)
```

### Large Area Volume Calculations 

#### Data Wrangling

V1 - rough calculations for a single day

```{r}
#rough well volume calculations for 35 square meter area
# Parameters
area_m2 <- 35 * 35           # Total area in m²
rough_snow_depth_m <- 0.5         # Uniform snow depth in meters
n_trees <- 233                # Number of trees
treewell_diam_m <- 1.5         # Average tree well diameter in meters
treewell_rad_m <- treewell_diam_m / 2  # Radius in meters

# Total snow volume in area
total_snow_volume_m3 <- area_m2 * rough_snow_depth_m

# Volume of a single hemispherical tree well
treewell_volume_m3 <- (2/3) * pi * (treewell_rad_m^3)

# Total volume missing due to all tree wells
total_well_volume_m3 <- n_trees * treewell_volume_m3

# Remaining snow volume in the open region
remaining_snow_volume_m3 <- total_snow_volume_m3 - total_well_volume_m3

# Print results
cat("Total snow volume in area:", round(total_snow_volume_m3, 2), "m³\n")
cat("Volume missing due to tree wells:", round(total_well_volume_m3, 2), "m³\n")
cat("Remaining snow volume:", round(remaining_snow_volume_m3, 2), "m³\n")
```

V2 - calculations based on known tree well diameters from one tree per site, for entire season

```{r}
#making dataset for TSZ with weather station snow depth and volume data for open area and tree data for tree volume 

TSZ_tree1_welldata <- transb_col_tree1 %>%
  select(date, season, maximum_depth_cm, well_diam_m, vol_treewell_cm3, vol_tree_m3) %>%
  mutate(tree_snowdepth_cm = maximum_depth_cm, 
         tree_snowdepth_m = tree_snowdepth_cm/100)

TSZ_openarea_vol_data <- vol_transb_daily_wx_fullseason %>%
  select(date, SnowDepth_m) %>%
  rename(open_snowdepth_m = SnowDepth_m)
  

TSZ_largearea_vol_data <- full_join(TSZ_tree1_welldata, TSZ_openarea_vol_data)
```

```{r}
#ADDING IN CALCULATIONS FOR full area
TSZ_largearea_vol_data <- TSZ_largearea_vol_data %>%
  mutate(
    total_vol_tree_m3 = vol_tree_m3*n_trees, 
    total_vol_tree_m3 = replace_na(total_vol_tree_m3, 0),
    total_openarea_vol_m3 = area_m2 * (open_snowdepth_m), 
    remaining_snowvol_m3 = total_openarea_vol_m3 - total_vol_tree_m3) %>%
  arrange(date) %>%
  #filtering out two outlier snowdepth dates
  filter(!date %in% as_date(c("2024-03-14", "2024-03-15"))) %>%
    #adding a row for the first "snow-free" date then making all values zero
  bind_rows(tibble(
    date = as_date("2024-05-13"),
    total_vol_tree_m3 = 0,
    total_openarea_vol_m3 = 0,
    remaining_snowvol_m3 = 0,
    # add other columns with default or NA values if needed
  ))

TSZ_largearea_treeonly_data <- TSZ_largearea_vol_data %>%
  filter(date <= "2024-04-23")
  
TSZ_largearea_vol_data <- TSZ_largearea_vol_data %>%
  filter(!date %in% as_date(c("2024-03-12", "2024-03-13"))) %>%
  mutate(
    snow_loss_due_to_trees_m3 = total_openarea_vol_m3 - remaining_snowvol_m3)
```

```{r}
#summary of loss of snow 
TSZ_largearea_vol_summary <- TSZ_largearea_vol_data %>%
  summarise(
    total_snow_loss_m3 = sum(snow_loss_due_to_trees_m3, na.rm = TRUE),
    total_open_snow_m3 = sum(total_openarea_vol_m3, na.rm = TRUE),
    max_daily_loss_m3 = max(snow_loss_due_to_trees_m3, na.rm = TRUE),
    avg_daily_loss_m3 = mean(snow_loss_due_to_trees_m3, na.rm = TRUE),
    percent_snow_loss = (total_snow_loss_m3 / total_open_snow_m3) * 100
  )
```

#### Plotting

```{r}

TSZ_largearea_wellvol_plot <- ggplot() + 
  # Line denoting ablation season
  geom_vline(xintercept = as.Date('2024-04-01'), color = "grey23", linetype = "dashed", linewidth = 0.6, alpha = 0.7) +
  geom_line(data = TSZ_largearea_vol_data, aes(x = date, y = remaining_snowvol_m3, color = "open area", linetype = "open area"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = TSZ_largearea_treeonly_data, aes(x = date, y = total_vol_tree_m3, color = "tree area", linetype = "tree area"), linewidth = 0.8, alpha = 0.8) + 
  labs(
    title = NULL,
    x = "Date",
    y = "Snow Volume (m³)",
    color = NULL,
    linetype = NULL  # This ensures linetype and color share the same legend
  ) +
  theme_bw() +
  #scale_y_continuous(limits = c(0, 3)) + 
  scale_x_date(
  limits = c(as.Date("2024-02-02"), as.Date("2024-05-15")),
  breaks = as.Date(c("2024-02-01", "2024-03-01", "2024-04-01", "2024-05-01", "2024-06-01")), 
  minor_breaks = "1 month",  # Adds light grid lines for all months
  date_labels = "%b"
) + 
  # Custom colors
  scale_color_manual(values = c("open area" = "grey30", 
                                "tree area" = "#1B7837")) +

  # Only tree 4 gets a dashed line, all others solid
  scale_linetype_manual(values = c("open area" = "solid",
                                   "tree area" = "solid")) + 
  theme(
  strip.text = element_text(size = 11),  # Facet title size
  axis.title = element_text(size = 11),  # Axis title size
  axis.text = element_text(size = 10),   # Axis tick labels
  legend.title = element_text(size = 11),  # Legend title size
  legend.text = element_text(size = 10),   # Legend labels size
  legend.position = "right",
  legend.key.width = unit(1, "cm"),      # Increase the width of the legend keys
  legend.key.height = unit(0.85, "cm")   # Height of the legend keys
)

TSZ_largearea_wellvol_plot
```

```{r}
ggsave("TSZ_largearea_wellvol_plot.png", 
       height = 3.5, 
       width = 6, 
       plot = TSZ_largearea_wellvol_plot, dpi = 600)
```

## Volume Stats

### Differenced Data V1

Percent differenced data by day, then grouped

```{r}
diff_stats_PSZ_vol<- fullseason_vol_persb %>%
  filter(!is.na(vol_sensor_m3), !is.na(vol_tree_m3)) %>%
  mutate(vol_perc_diff_m3 = ((vol_sensor_m3-vol_tree_m3)/vol_sensor_m3)*100) %>%
  group_by(tree_id, season) %>%
  summarize(min_perc_diff = min(vol_perc_diff_m3, na.rm = TRUE),
            max_perc_diff = max(vol_perc_diff_m3, na.rm = TRUE), 
            median_perc_diff = median(vol_perc_diff_m3, na.rm = TRUE), 
            mean_perc_diff = mean(vol_perc_diff_m3, na.rm = TRUE))
```

```{r}
diff_stats_TSZ_vol<- fullseason_vol_transb %>%
  filter(!is.na(vol_sensor_m3), !is.na(vol_tree_m3)) %>%
  mutate(vol_perc_diff_m3 = ((vol_sensor_m3-vol_tree_m3)/vol_sensor_m3)*100) %>%
  group_by(tree_id, season) %>%
  summarize(min_perc_diff = min(vol_perc_diff_m3, na.rm = TRUE),
            max_perc_diff = max(vol_perc_diff_m3, na.rm = TRUE), 
            median_perc_diff = median(vol_perc_diff_m3, na.rm = TRUE), 
            mean_perc_diff = mean(vol_perc_diff_m3, na.rm = TRUE))
```

```{r}
write_csv(diff_stats_PSZ_vol, "diff_stats_PSZ_vol.csv")

write_csv(diff_stats_TSZ_vol, "diff_stats_TSZ_vol.csv")
```

### Differenced Data V2

#### MAD/MRD

```{r}
PSZ_MRD_MAD_stats <- fullseason_vol_persb %>%
  group_by(season) %>%
  summarise(
    mean_avg_diff = mean(abs(vol_sensor_m3 - vol_tree_m3), na.rm = TRUE),
    mean_rel_diff =mean(abs(vol_sensor_m3 - vol_tree_m3) / ((vol_sensor_m3 + vol_tree_m3) / 2), na.rm = TRUE) * 100, 
    min_avg_diff = min(abs(vol_sensor_m3 - vol_tree_m3), na.rm = TRUE),
    min_rel_diff =min(abs(vol_sensor_m3 - vol_tree_m3) / ((vol_sensor_m3 + vol_tree_m3) / 2), na.rm = TRUE) * 100,
    max_avg_diff = max(abs(vol_sensor_m3 - vol_tree_m3), na.rm = TRUE),
    max_rel_diff =max(abs(vol_sensor_m3 - vol_tree_m3) / ((vol_sensor_m3 + vol_tree_m3) / 2), na.rm = TRUE) * 100, 
    mean_sensor_vol = mean(vol_sensor_m3, na.rm = TRUE), 
    mean_tree_vol = mean(vol_tree_m3, na.rm = TRUE))
```

```{r}
TSZ_MRD_MAD_stats <- fullseason_vol_transb %>%
  group_by(season) %>%
  summarise(
    mean_avg_diff = mean(abs(vol_sensor_m3 - vol_tree_m3), na.rm = TRUE),
    mean_rel_diff = mean(abs(vol_sensor_m3 - vol_tree_m3) / ((vol_sensor_m3 + vol_tree_m3) / 2), na.rm = TRUE) * 100, 
    min_avg_diff = min(abs(vol_sensor_m3 - vol_tree_m3), na.rm = TRUE),
    min_rel_diff =min(abs(vol_sensor_m3 - vol_tree_m3) / ((vol_sensor_m3 + vol_tree_m3) / 2), na.rm = TRUE) * 100, 
    max_avg_diff = max(abs(vol_sensor_m3 - vol_tree_m3), na.rm = TRUE),
    max_rel_diff =max(abs(vol_sensor_m3 - vol_tree_m3) / ((vol_sensor_m3 + vol_tree_m3) / 2), na.rm = TRUE) *100, 
    mean_sensor_vol = mean(vol_sensor_m3, na.rm = TRUE), 
    mean_tree_vol = mean(vol_tree_m3, na.rm = TRUE))
```

#### Melt Rates Stats

PSZ

```{r}
PSZ_tree1_meltrate <- persb_col_tree1_abla %>%
  arrange(date) %>%  # Ensure data is sorted by date
  mutate(daily_vol_change_tree = vol_tree_m3 - lag(vol_tree_m3), 
         daily_vol_change_sensor = vol_sensor_m3 - lag(vol_sensor_m3)) %>%
  filter(!is.na(daily_vol_change_tree) & !is.na(daily_vol_change_sensor)) %>%
  summarize(avg_melt_rate_tree = mean(daily_vol_change_tree, na.rm = TRUE), 
            avg_melt_rate_sensor = mean(daily_vol_change_sensor, na.rm = TRUE), percent_diff = ((avg_melt_rate_tree - avg_melt_rate_sensor) / avg_melt_rate_sensor) * 100
  ) %>%
  mutate(tree_id = "1")

PSZ_tree2_meltrate <- persb_col_tree2_abla %>%
  arrange(date) %>%  # Ensure data is sorted by date
  mutate(daily_vol_change_tree = vol_tree_m3 - lag(vol_tree_m3), 
         daily_vol_change_sensor = vol_sensor_m3 - lag(vol_sensor_m3)) %>%
  filter(!is.na(daily_vol_change_tree) & !is.na(daily_vol_change_sensor)) %>%
  summarize(avg_melt_rate_tree = mean(daily_vol_change_tree, na.rm = TRUE), 
            avg_melt_rate_sensor = mean(daily_vol_change_sensor, na.rm = TRUE), percent_diff = ((avg_melt_rate_tree - avg_melt_rate_sensor) / avg_melt_rate_sensor) * 100
  ) %>%
  mutate(tree_id = "2")

PSZ_tree3_meltrate <- persb_col_tree3_abla %>%
  arrange(date) %>%  # Ensure data is sorted by date
  mutate(daily_vol_change_tree = vol_tree_m3 - lag(vol_tree_m3), 
         daily_vol_change_sensor = vol_sensor_m3 - lag(vol_sensor_m3)) %>%
  filter(!is.na(daily_vol_change_tree) & !is.na(daily_vol_change_sensor)) %>%
  summarize(avg_melt_rate_tree = mean(daily_vol_change_tree, na.rm = TRUE), 
            avg_melt_rate_sensor = mean(daily_vol_change_sensor, na.rm = TRUE), percent_diff = ((avg_melt_rate_tree - avg_melt_rate_sensor) / avg_melt_rate_sensor) * 100
  ) %>%
  mutate(tree_id = "3")

PSZ_tree4_meltrate <- persb_col_tree4_abla %>%
  arrange(date) %>%  # Ensure data is sorted by date
  mutate(daily_vol_change_tree = vol_tree_m3 - lag(vol_tree_m3), 
         daily_vol_change_sensor = vol_sensor_m3 - lag(vol_sensor_m3)) %>%
  filter(!is.na(daily_vol_change_tree) & !is.na(daily_vol_change_sensor)) %>%
  summarize(avg_melt_rate_tree = mean(daily_vol_change_tree, na.rm = TRUE), 
            avg_melt_rate_sensor = mean(daily_vol_change_sensor, na.rm = TRUE), percent_diff = ((avg_melt_rate_tree - avg_melt_rate_sensor) / avg_melt_rate_sensor) * 100
  ) %>%
  mutate(tree_id = "4")
```

```{r}
#creating a dataframe with these average melt rate changes by tree per zone
PSZ_snowvol_meltrate <- rbind(PSZ_tree1_meltrate, PSZ_tree2_meltrate, PSZ_tree3_meltrate, PSZ_tree4_meltrate) %>%
  mutate(zone = "PSZ") %>%
  select(tree_id, zone, everything())
```

TSZ

```{r}
TSZ_tree1_meltrate <- transb_col_tree1_abla %>%
  arrange(date) %>%  # Ensure data is sorted by date
  mutate(daily_vol_change_tree = vol_tree_m3 - lag(vol_tree_m3), 
         daily_vol_change_sensor = vol_sensor_m3 - lag(vol_sensor_m3)) %>%
  filter(!is.na(daily_vol_change_tree) & !is.na(daily_vol_change_sensor)) %>%
  summarize(avg_melt_rate_tree = mean(daily_vol_change_tree, na.rm = TRUE), 
            avg_melt_rate_sensor = mean(daily_vol_change_sensor, na.rm = TRUE), percent_diff = ((avg_melt_rate_tree - avg_melt_rate_sensor) / avg_melt_rate_sensor) * 100
  ) %>%
  mutate(tree_id = "1")

TSZ_tree2_meltrate <- transb_col_tree2_abla %>%
  arrange(date) %>%  # Ensure data is sorted by date
  mutate(daily_vol_change_tree = vol_tree_m3 - lag(vol_tree_m3), 
         daily_vol_change_sensor = vol_sensor_m3 - lag(vol_sensor_m3)) %>%
  filter(!is.na(daily_vol_change_tree) & !is.na(daily_vol_change_sensor)) %>%
  summarize(avg_melt_rate_tree = mean(daily_vol_change_tree, na.rm = TRUE), 
            avg_melt_rate_sensor = mean(daily_vol_change_sensor, na.rm = TRUE), percent_diff = ((avg_melt_rate_tree - avg_melt_rate_sensor) / avg_melt_rate_sensor) * 100
  ) %>%
  mutate(tree_id = "2")

TSZ_tree3_meltrate <- transb_col_tree3_abla %>%
  arrange(date) %>%  # Ensure data is sorted by date
  mutate(daily_vol_change_tree = vol_tree_m3 - lag(vol_tree_m3), 
         daily_vol_change_sensor = vol_sensor_m3 - lag(vol_sensor_m3)) %>%
  filter(!is.na(daily_vol_change_tree) & !is.na(daily_vol_change_sensor)) %>%
  summarize(avg_melt_rate_tree = mean(daily_vol_change_tree, na.rm = TRUE), 
            avg_melt_rate_sensor = mean(daily_vol_change_sensor, na.rm = TRUE), percent_diff = ((avg_melt_rate_tree - avg_melt_rate_sensor) / avg_melt_rate_sensor) * 100
  ) %>%
  mutate(tree_id = "3")

TSZ_tree4_meltrate <- transb_col_tree4_abla %>%
  arrange(date) %>%  # Ensure data is sorted by date
  mutate(daily_vol_change_tree = vol_tree_m3 - lag(vol_tree_m3), 
         daily_vol_change_sensor = vol_sensor_m3 - lag(vol_sensor_m3)) %>%
  filter(!is.na(daily_vol_change_tree) & !is.na(daily_vol_change_sensor)) %>%
  summarize(avg_melt_rate_tree = mean(daily_vol_change_tree, na.rm = TRUE), 
            avg_melt_rate_sensor = mean(daily_vol_change_sensor, na.rm = TRUE), percent_diff = ((avg_melt_rate_tree - avg_melt_rate_sensor) / avg_melt_rate_sensor) * 100
  ) %>%
  mutate(tree_id = "4")
```

```{r}
TSZ_snowvol_meltrate <- rbind(TSZ_tree1_meltrate, TSZ_tree2_meltrate, TSZ_tree3_meltrate, TSZ_tree4_meltrate) %>%
  mutate(zone = "TSZ") %>%
  select(tree_id, zone, everything())
```

```{r}
mean_snowvol_meltrate <- rbind(PSZ_snowvol_meltrate, TSZ_snowvol_meltrate) %>%
  group_by(zone) %>%
  summarize(mean_melt_rate_tree = mean(avg_melt_rate_tree), 
            mean_melt_rate_sensor = mean(avg_melt_rate_sensor), 
            mean_percent_diff = mean(percent_diff))
```

#### Accum Vol Difference

```{r}
PSZ_tree1_accu_vol <- persb_col_tree1_accu %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "PSZ", tree_id = "1")

PSZ_tree2_accu_vol <- persb_col_tree2_accu %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "PSZ", tree_id = "2")

PSZ_tree3_accu_vol <- persb_col_tree3_accu %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "PSZ", tree_id = "3")

PSZ_tree4_accu_vol <- persb_col_tree4_accu %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "PSZ", tree_id = "4")
```

```{r}
PSZ_snowvol_accu <- rbind(PSZ_tree1_accu_vol, PSZ_tree2_accu_vol, PSZ_tree3_accu_vol, PSZ_tree4_accu_vol) %>%
  select(tree_id, zone, everything())
```

```{r}
TSZ_tree1_accu_vol <- transb_col_tree1_accu %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "TSZ", tree_id = "1")

TSZ_tree2_accu_vol <- transb_col_tree2_accu %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "TSZ", tree_id = "2")

TSZ_tree3_accu_vol <- transb_col_tree3_accu %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "TSZ", tree_id = "3")

TSZ_tree4_accu_vol <- transb_col_tree4_accu %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "TSZ", tree_id = "4")
```

```{r}
TSZ_snowvol_accu <- rbind(TSZ_tree1_accu_vol, TSZ_tree2_accu_vol, TSZ_tree3_accu_vol, TSZ_tree4_accu_vol) %>%
  select(tree_id, zone, everything())
```

```{r}
mean_snowvol_accu <- rbind(PSZ_snowvol_accu, TSZ_snowvol_accu) %>%
  group_by(zone) %>%
  summarize(mean_vol_tree = mean(mean_vol_tree), 
            mean_vol_sensor = mean(mean_vol_sensor), 
            mean_percent_diff = mean(percent_diff))
```

#### Snow Volume Ablation

```{r}
PSZ_tree1_abla_vol <- persb_col_tree1_abla %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "PSZ", tree_id = "1")

PSZ_tree2_abla_vol <- persb_col_tree2_abla %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "PSZ", tree_id = "2")

PSZ_tree3_abla_vol <- persb_col_tree3_abla %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "PSZ", tree_id = "3")

PSZ_tree4_abla_vol <- persb_col_tree4_abla %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "PSZ", tree_id = "4")

PSZ_snowvol_abla <- rbind(PSZ_tree1_abla_vol, PSZ_tree2_abla_vol, PSZ_tree3_abla_vol, PSZ_tree4_abla_vol) %>%
  select(tree_id, zone, everything())
```

```{r}
TSZ_tree1_abla_vol <- transb_col_tree1_abla %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "TSZ", tree_id = "1")

TSZ_tree2_abla_vol <- transb_col_tree2_abla %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "TSZ", tree_id = "2")

TSZ_tree3_abla_vol <- transb_col_tree3_abla %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "TSZ", tree_id = "3")

TSZ_tree4_abla_vol <- transb_col_tree4_abla %>%
  summarize(
    mean_vol_tree = mean(vol_tree_m3, na.rm = TRUE), 
    mean_vol_sensor = mean(vol_sensor_m3, na.rm = TRUE),
    percent_diff = ((mean_vol_tree - mean_vol_sensor) / mean_vol_sensor) * 100
  ) %>%
  mutate(zone = "TSZ", tree_id = "4")

TSZ_snowvol_abla <- rbind(TSZ_tree1_abla_vol, TSZ_tree2_abla_vol, TSZ_tree3_abla_vol, TSZ_tree4_abla_vol) %>%
  select(tree_id, zone, everything())
```

```{r}
mean_snowvol_abla <- rbind(PSZ_snowvol_abla, TSZ_snowvol_abla) %>%
  group_by(zone) %>%
  summarize(mean_vol_tree = mean(mean_vol_tree), 
            mean_vol_sensor = mean(mean_vol_sensor), 
            mean_percent_diff = mean(percent_diff))
```

## Tree vs Well Diam Correlation

Correlating full seasons tree vs well diameters - using snow camera data - NOT using for thesis!

###  PSZ

```{r}
comb_persb_treewell_diam_abla <- comb_persb_treewell_diam_fullseason %>%
  filter(date >= "2024-05-06" & date <= "2024-05-17") %>%
  mutate(tree_diam_m = tree_diam/100, well_diam_m = well_diam/100, welldiam_minustree_m = well_diam_m - tree_diam_m)

p_treewelldiam_camera_results <- comb_persb_treewell_diam_abla %>%
  drop_na(well_diam_m, tree_diam_m) %>%
  group_by(date) %>%
  filter(n() >= 2) %>%  # Ensure at least 2 observations per group
  summarize(
    cor_test = list(tryCatch(cor.test(well_diam_m, tree_diam_m, use = "complete.obs"), 
                             error = function(e) return(NA))), 
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
persb_tree_well_corr_plot_abla <- ggplot(comb_persb_treewell_diam_abla, aes(x = tree_diam_m, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ date) +  # Separate by tree_id
  labs(
    title = "a) PSZ",
    x = "Tree Diameter (m)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_x_continuous(
    breaks = c(0.2, 0.4),  # Set specific breaks for x-axis
    labels = c("0.2", "0.4")  # Set the labels for those breaks
  ) + 
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_treewelldiam_camera_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4) +
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10), 
    legend.position = "bottom")

persb_tree_well_corr_plot_abla
```

### TSZ

```{r}
comb_transb_treewell_diam_abla <- long_transb_treewell_diams_fullseason_V2 %>%
  filter(date >= "2024-04-01" & date <= "2024-04-12") %>%
  mutate(tree_diam_m = tree_diam/100, well_diam_m = well_diam/100, welldiam_minustree_m = well_diam_m - tree_diam_m)

t_treewelldiam_camera_results <- comb_transb_treewell_diam_abla %>%
  drop_na(well_diam_m, tree_diam_m) %>%
  group_by(date) %>%
  #filter(n() >= 2) %>%  # Ensure at least 2 observations per group
  summarize(
    cor_test = list(cor.test(well_diam_m, tree_diam_m, use = "complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
transb_tree_well_corr_plot_abla <- ggplot(comb_transb_treewell_diam_abla, aes(x = tree_diam_m, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ date) +  # Separate by tree_id
  labs(
    title = "b) TSZ",
    x = "Tree Diameter (m)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  scale_y_continuous(
    breaks = c(0.2, 0.4, 0.6, 0.8),  # Set specific breaks for x-axis
    labels = c("0.2", "0.4", "0.6", "0.8")  # Set the labels for those breaks
  ) +
  #remove color legend 
  guides(color = "none") +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_treewelldiam_camera_results, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.5, inherit.aes = FALSE, size = 4) +
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10), 
    legend.position = "bottom")

transb_tree_well_corr_plot_abla
```

### Tree Diam Subtracted

#### PSZ

```{r}
tree1_persb_treevswelldiam_V2 <- comb_persb_treewell_diam_fullseason %>%
  filter(date >= "2024-05-06", tree_id == "1") %>%
  mutate(tree_diam_m = tree_diam/100, well_diam_m = well_diam/100, welldiam_minustree_m = well_diam_m-tree_diam_m) %>%
  drop_na()

tree1_persb_treevswelldiam_corr_results_V2 <- tree1_persb_treevswelldiam_V2 %>%
  summarize(
    cor_test = list(tryCatch(cor.test(welldiam_minustree_m, tree_diam_m, use = "complete.obs"), 
                             error = function(e) return(NA))), 
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
tree2_persb_treevswelldiam_V2 <- comb_persb_treewell_diam_fullseason %>%
  filter(date >= "2024-05-06", tree_id == "2") %>%
  mutate(tree_diam_m = tree_diam/100, well_diam_m = well_diam/100, welldiam_minustree_m = well_diam_m-tree_diam_m) %>%
  drop_na()

tree2_persb_treevswelldiam_corr_results_V2 <- tree2_persb_treevswelldiam_V2 %>%
  summarize(
    cor_test = list(tryCatch(cor.test(welldiam_minustree_m, tree_diam_m, use = "complete.obs"), 
                             error = function(e) return(NA))), 
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
tree3_persb_treevswelldiam_V2 <- comb_persb_treewell_diam_fullseason %>%
  filter(date >= "2024-05-06", tree_id == "3") %>%
  mutate(tree_diam_m = tree_diam/100, well_diam_m = well_diam/100, welldiam_minustree_m = well_diam_m-tree_diam_m) %>%
  drop_na()

tree3_persb_treevswelldiam_corr_results_V2 <- tree3_persb_treevswelldiam_V2 %>%
  summarize(
    cor_test = list(tryCatch(cor.test(welldiam_minustree_m, tree_diam_m, use = "complete.obs"), 
                             error = function(e) return(NA))), 
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
tree4_persb_treevswelldiam_V2 <- comb_persb_treewell_diam_fullseason %>%
  filter(date >= "2024-05-06", tree_id == "4") %>%
  mutate(tree_diam_m = tree_diam/100, well_diam_m = well_diam/100, welldiam_minustree_m = well_diam_m-tree_diam_m) %>%
  drop_na()

tree4_persb_treevswelldiam_corr_results_V2 <- tree4_persb_treevswelldiam_V2 %>%
  summarize(
    cor_test = list(tryCatch(cor.test(welldiam_minustree_m, tree_diam_m, use = "complete.obs"), 
                             error = function(e) return(NA))), 
    .groups = "drop"
  ) %>%
  mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

#### TSZ

```{r}
tree1_treevswelldiam_V2 <- long_transb_treewell_diams_fullseason_V2 %>%
  filter(date >= "2024-04-06" & date <= "2024-04-25") %>%
  mutate(tree_diam_m = tree_diam/100, well_diam_m = well_diam/100, welldiam_minustree_m = well_diam_m-tree_diam_m) %>%
  filter(tree_id == "1") %>%
  drop_na()

tree1_treevswelldiam_corr_results_V2 <- tree1_treevswelldiam_V2 %>%
  drop_na(welldiam_minustree_m, tree_diam_m) %>%
  summarize(
    cor_test = list(tryCatch(cor.test(welldiam_minustree_m, tree_diam_m, use = "complete.obs"), 
                             error = function(e) return(NA))), 
    .groups = "drop"
  ) %>%
   mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
tree2_treevswelldiam_V2 <- long_transb_treewell_diams_fullseason_V2 %>%
  filter(date >= "2024-04-06" & date <= "2024-04-25") %>%
  mutate(tree_diam_m = tree_diam/100, well_diam_m = well_diam/100, welldiam_minustree_m = well_diam_m-tree_diam_m) %>%
  filter(tree_id == "2") %>%
  drop_na()

tree2_treevswelldiam_corr_results_V2 <- tree2_treevswelldiam_V2 %>%
  drop_na(welldiam_minustree_m, tree_diam_m) %>%
  summarize(
    cor_test = list(tryCatch(cor.test(welldiam_minustree_m, tree_diam_m, use = "complete.obs"), 
                             error = function(e) return(NA))), 
    .groups = "drop"
  ) %>%
   mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
tree3_treevswelldiam_V2 <- long_transb_treewell_diams_fullseason_V2 %>%
  filter(date >= "2024-04-06" & date <= "2024-04-25") %>%
  mutate(tree_diam_m = tree_diam/100, well_diam_m = well_diam/100, welldiam_minustree_m = well_diam_m-tree_diam_m) %>%
  filter(tree_id == "3") %>%
  drop_na()

tree3_treevswelldiam_corr_results_V2 <- tree3_treevswelldiam_V2 %>%
  drop_na(welldiam_minustree_m, tree_diam_m) %>%
  summarize(
    cor_test = list(tryCatch(cor.test(welldiam_minustree_m, tree_diam_m, use = "complete.obs"), 
                             error = function(e) return(NA))), 
    .groups = "drop"
  ) %>%
   mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

```{r}
tree4_treevswelldiam_V2 <- long_transb_treewell_diams_fullseason_V2 %>%
  filter(date >= "2024-04-06" & date <= "2024-04-25") %>%
  mutate(tree_diam_m = tree_diam/100, well_diam_m = well_diam/100, welldiam_minustree_m = well_diam_m-tree_diam_m) %>%
  filter(tree_id == "4") %>%
  drop_na()

tree4_treevswelldiam_corr_results_V2 <- tree4_treevswelldiam_V2 %>%
  drop_na(welldiam_minustree_m, tree_diam_m) %>%
  summarize(
    cor_test = list(tryCatch(cor.test(welldiam_minustree_m, tree_diam_m, use = "complete.obs"), 
                             error = function(e) return(NA))), 
    .groups = "drop"
  ) %>%
   mutate(
    cor_coeff = map_dbl(cor_test, ~ .x$estimate),  # Extract correlation coefficient (r)
    R2 = cor_coeff^2,  # Compute R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("r = ", formatC(cor_coeff, format = "f", digits = 2), 
                      "\nR² = ", formatC(R2, format = "f", digits = 2), 
                      "\n", p_label)  # Ensure two decimal places
  )
```

## SWE Calculations

### Data Wrangling

SWE data from Joe Wright snotel for PSZ and Hourglass Lake snotel for TSZ

```{r}
persb_mean_daily_SWE_V2 <- read_csv("nsf/snow_density/persb_mean_daily_SWE_V2.csv") %>%
  crossing(tree_id = 1:4) %>%
  rename(date = Date)

persub_mean_daily_SWE_V2 <- read_csv("nsf/snow_density/persub_mean_daily_SWE_V2.csv") %>%
  crossing(tree_id = 1:4) %>%
  rename(date = Date)

transb_mean_daily_SWE_V2 <- read_csv("nsf/snow_density/transb_mean_daily_SWE_V2.csv") %>%
  crossing(tree_id = 1:4) %>%
  rename(date = Date)

transub_mean_daily_SWE_V2 <- read_csv("nsf/snow_density/transub_mean_daily_SWE_V2.csv") %>%
  crossing(tree_id = 1:4) %>%
  rename(date = Date)
```

```{r}
#Daily mean SWE 
persb_meanSWE <- persb_mean_daily_SWE_V2 %>%
  group_by(date) %>%
  summarize(mean_snowdensity = mean(predicted_snowdensity_kg_m3)) %>%
  #adding  tree ID to use for later binding to volume rows
  crossing(tree_id = 1:4) %>%
  filter(date <= "2024-06-03")

transb_meanSWE <- transb_mean_daily_SWE_V2 %>%
  group_by(date) %>%
  summarize(mean_snowdensity = mean(predicted_snowdensity_kg_m3)) %>%
  #adding  tree ID to use for later binding to volume rows
  crossing(tree_id = 1:4) %>%
  filter(date <= "2024-06-03")
```

Adding snow density to volume dataframe and calculating SW

```{r}
SWE_fullseason_vol_persb <- fullseason_vol_persb %>%
  inner_join(persb_meanSWE, by = c("date", "tree_id")) %>%
  mutate(SWE_sensor_kgm3 = vol_sensor_m3*mean_snowdensity, 
         SWE_tree_kgm3 = vol_tree_m3*mean_snowdensity) %>%
  mutate(SWE_sensor_cm = SWE_sensor_kgm3 / 1000 * 100, 
         SWE_tree_cm = SWE_tree_kgm3 / 1000 * 100)

SWE_fullseason_vol_transb <- fullseason_vol_transb %>%
  inner_join(transb_meanSWE, by = c("date", "tree_id")) %>%
  mutate(SWE_sensor_kgm3 = vol_sensor_m3*mean_snowdensity, 
         SWE_tree_kgm3 = vol_tree_m3*mean_snowdensity) %>%
  mutate(SWE_sensor_cm = SWE_sensor_kgm3 / 1000 * 100, 
         SWE_tree_cm = SWE_tree_kgm3 / 1000 * 100)

```

```{r}
#calculating open area SWE, for entire period!
SWEonly_fullseason_vol_persb <- vol_persb_daily_wx_fullseason %>%
  inner_join(persb_meanSWE, by = c("date")) %>%
  #getting SWE in mm
  mutate(SWE_sensor_mm = vol_sensor_m3*mean_snowdensity) %>%
  mutate(SWE_sensor_cm = SWE_sensor_mm / 10) %>%
  mutate(SWE_sensor_cm_smooth = 
           rollmean(SWE_sensor_cm, k = 10, fill = NA, align = "right")) %>%
  mutate(
    SWE_sensor_cm = if_else(date == as.Date("2024-05-31"), 0, SWE_sensor_cm),
    SWE_sensor_cm_smooth = if_else(date == as.Date("2024-05-31"), 0, SWE_sensor_cm_smooth)
  )

SWEonly_fullseason_vol_transb <- vol_transb_daily_wx_fullseason  %>%
  inner_join(transb_meanSWE, by = c("date")) %>%
  #getting SWE in mm
  mutate(SWE_sensor_mm = vol_sensor_m3*mean_snowdensity) %>%
  #converting SWE from mm to cm
  mutate(SWE_sensor_cm = SWE_sensor_mm / 10) %>%
  mutate(SWE_sensor_cm_smooth = 
           rollmean(SWE_sensor_cm, k = 10, fill = NA, align = "right")) %>%
  mutate(
    SWE_sensor_cm = if_else(date == as.Date("2024-05-12"), 0, SWE_sensor_cm),
    SWE_sensor_cm_smooth = if_else(date == as.Date("2024-05-12"), 0, SWE_sensor_cm_smooth)
  )
```

### Plotting

```{r}
persb_SWE_tree1 <- SWE_fullseason_vol_persb %>%
  filter(tree_id == "1", vol_tree_m3 >= 0) %>%
  select(date, season, tree_id, vol_tree_cm3:last_col()) %>%
  mutate(SWE_tree_cm_smooth = rollmean(SWE_tree_cm, k = 10, fill = NA, align = "right"))
  
persb_SWE_tree2 <- SWE_fullseason_vol_persb %>%
  filter(tree_id == "2", vol_tree_m3 >= 0) %>%
  select(date, season, tree_id, vol_tree_cm3:last_col()) %>%
  mutate(SWE_tree_cm_smooth = rollmean(SWE_tree_cm, k = 10, fill = NA, align = "right")) %>%
  mutate(
    SWE_tree_cm = if_else(date == as.Date("2024-05-23"), 0, SWE_tree_cm),
    SWE_tree_cm_smooth = if_else(date == as.Date("2024-05-23"), 0, SWE_tree_cm_smooth)
  )

persb_SWE_tree3 <- SWE_fullseason_vol_persb %>%
  filter(tree_id == "3", vol_tree_m3 >= 0) %>%
  select(date, season, tree_id, vol_tree_cm3:last_col()) %>%
  mutate(SWE_tree_cm_smooth = rollmean(SWE_tree_cm, k = 10, fill = NA, align = "right")) %>%
  mutate(
    SWE_tree_cm = if_else(date == as.Date("2024-05-23"), 0, SWE_tree_cm),
    SWE_tree_cm_smooth = if_else(date == as.Date("2024-05-23"), 0, SWE_tree_cm_smooth)
  )

persb_SWE_tree4 <- SWE_fullseason_vol_persb %>%
  filter(tree_id == "4", vol_tree_m3 >= 0) %>%
  select(date, season, tree_id, vol_tree_cm3:last_col()) %>%
  mutate(SWE_tree_cm_smooth = rollmean(SWE_tree_cm, k = 10, fill = NA, align = "right"))
```

```{r}
persb_SWE_fullseason_lineplot <- ggplot() + 
  # Line denoting ablation season
  geom_vline(xintercept = as.Date('2024-05-06'), color = "grey23", linetype = "dashed", linewidth = 0.6, alpha = 0.7) +
  geom_line(data = SWEonly_fullseason_vol_persb, aes(x = date, y = SWE_sensor_cm_smooth, color = "open area", linetype = "open area"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = persb_SWE_tree1, aes(x = date, y = SWE_tree_cm_smooth, color = "tree 1", linetype = "tree 1"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = persb_SWE_tree2, aes(x = date, y = SWE_tree_cm_smooth, color = "tree 2", linetype = "tree 2"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = persb_SWE_tree3, aes(x = date, y = SWE_tree_cm_smooth, color = "tree 3", linetype = "tree 3"), linewidth = 0.8, alpha = 0.8) +
  geom_line(data = persb_SWE_tree4, aes(x = date, y = SWE_tree_cm_smooth, color = "tree 4", linetype = "tree 4"), linewidth = 0.8, alpha = 0.8) +  
  facet_wrap(~ tree_id, nrow = 1, ncol = 4) +  
  labs(
    title = "a) PSZ",
    x = NULL,
    y = "Snow Water Equivalent (cm)",
    color = NULL,
    linetype = NULL  # This ensures linetype and color share the same legend
  ) +
  theme_bw() +
  scale_y_continuous(limits = c(0, 90)) + 
   scale_x_date(
  limits = c(as.Date("2024-02-02"), as.Date("2024-06-01")),
  breaks = as.Date(c("2024-02-01", "2024-03-01", "2024-04-01", "2024-05-01", "2024-06-01")), 
  minor_breaks = "1 month",  # Adds light grid lines for all months
  date_labels = "%b"
) + 
  # Custom colors
  scale_color_manual(values = c("open area" = "grey30", 
                                "tree 1" = "#1B7837", 
                                "tree 2" = "#D95F02", 
                                "tree 3" = "#2166AC", 
                                "tree 4" = "grey10")) +

  # Only tree 4 gets a dashed line, all others solid
  scale_linetype_manual(values = c("open area" = "solid",
                                   "tree 1" = "solid",
                                   "tree 2" = "solid",
                                   "tree 3" = "solid",
                                   "tree 4" = "dashed")) + 
  #manually setting the length of legend lines
  theme(
    legend.key.width = unit(1, "cm"),  # Increase the width of the legend keys
    legend.key.height = unit(0.85, "cm")  # Adjust the height of the legend key if needed
  )

persb_SWE_fullseason_lineplot
```

```{r}
transb_SWE_tree1 <- SWE_fullseason_vol_transb %>%
  filter(tree_id == "1", vol_tree_m3 >= 0) %>%
  select(date, season, tree_id, vol_tree_cm3:last_col()) %>%
  mutate(SWE_tree_cm_smooth = rollmean(SWE_tree_cm, k = 10, fill = NA, align = "right")) %>%
  #forcing final row to zero... because SWE is calculated from volume of area and we stopped the volume calcs once they got almost to zero, I have to do this to get the lines to zero
  mutate(
    SWE_tree_cm = if_else(row_number() == n(), 0, SWE_tree_cm),
    SWE_tree_cm_smooth = if_else(row_number() == n(), 0, SWE_tree_cm_smooth)
  )
  
transb_SWE_tree2 <- SWE_fullseason_vol_transb %>%
  filter(tree_id == "2", vol_tree_m3 >= 0) %>%
  select(date, season, tree_id, vol_tree_cm3:last_col()) %>%
  mutate(SWE_tree_cm_smooth = rollmean(SWE_tree_cm, k = 10, fill = NA, align = "right")) %>%
  mutate(
    SWE_tree_cm = if_else(row_number() == n(), 0, SWE_tree_cm),
    SWE_tree_cm_smooth = if_else(row_number() == n(), 0, SWE_tree_cm_smooth)
  )
  

transb_SWE_tree3 <- SWE_fullseason_vol_transb %>%
  filter(tree_id == "3", vol_tree_m3 >= 0) %>%
  select(date, season, tree_id, vol_tree_cm3:last_col()) %>%
  mutate(SWE_tree_cm_smooth = rollmean(SWE_tree_cm, k = 10, fill = NA, align = "right")) %>%
  mutate(
    SWE_tree_cm = if_else(row_number() == n(), 0, SWE_tree_cm),
    SWE_tree_cm_smooth = if_else(row_number() == n(), 0, SWE_tree_cm_smooth)
  )
  

transb_SWE_tree4 <- SWE_fullseason_vol_transb %>%
  filter(tree_id == "4", vol_tree_m3 >= 0) %>%
  select(date, season, tree_id, vol_tree_cm3:last_col()) %>%
   mutate(SWE_tree_cm_smooth = rollmean(SWE_tree_cm, k = 10, fill = NA, align = "right")) %>%
  mutate(
    SWE_tree_cm = if_else(row_number() == n(), 0, SWE_tree_cm),
    SWE_tree_cm_smooth = if_else(row_number() == n(), 0, SWE_tree_cm_smooth)
  )
  
```

```{r}
transb_SWE_fullseason_lineplot <- ggplot() + 
  # Line denoting ablation season
  geom_vline(xintercept = as.Date('2024-04-01'), color = "grey23", linetype = "dashed", linewidth = 0.6, alpha = 0.7) +
  geom_line(data = SWEonly_fullseason_vol_transb, aes(x = date, y = SWE_sensor_cm_smooth, color = "open area", linetype = "open area"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = transb_SWE_tree1, aes(x = date, y = SWE_tree_cm_smooth, color = "tree 1", linetype = "tree 1"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = transb_SWE_tree2, aes(x = date, y = SWE_tree_cm_smooth, color = "tree 2", linetype = "tree 2"), linewidth = 0.8, alpha = 0.8) + 
  geom_line(data = transb_SWE_tree3, aes(x = date, y = SWE_tree_cm_smooth, color = "tree 3", linetype = "tree 3"), linewidth = 0.8, alpha = 0.8) +
  geom_line(data = transb_SWE_tree4, aes(x = date, y = SWE_tree_cm_smooth, color = "tree 4", linetype = "tree 4"), linewidth = 0.8, alpha = 0.8) +  

  facet_wrap(~ tree_id, nrow = 1, ncol = 4) +  
  labs(
    title = "b) TSZ",
    x = "Date",
    y = "Snow Water Equivalent (cm)",
    color = NULL,
    linetype = NULL  # This ensures linetype and color share the same legend
  ) +
  theme_bw() +
  scale_y_continuous(limits = c(0, 90)) + 
  scale_x_date(
  limits = c(as.Date("2024-02-02"), as.Date("2024-06-01")),
  breaks = as.Date(c("2024-02-01", "2024-03-01", "2024-04-01", "2024-05-01", "2024-06-01")), 
  minor_breaks = "1 month",  # Adds light grid lines for all months
  date_labels = "%b"
) + 
  # Custom colors
  scale_color_manual(values = c("open area" = "grey30", 
                                "tree 1" = "#1B7837", 
                                "tree 2" = "#D95F02", 
                                "tree 3" = "#2166AC", 
                                "tree 4" = "grey10")) +

  # Only tree 4 gets a dashed line, all others solid
  scale_linetype_manual(values = c("open area" = "solid",
                                   "tree 1" = "solid",
                                   "tree 2" = "solid",
                                   "tree 3" = "solid",
                                   "tree 4" = "dashed")) + 
  #manually setting the length of legend lines
  theme(
    legend.key.width = unit(1, "cm"),  # Increase the width of the legend keys
    legend.key.height = unit(0.85, "cm")  # Adjust the height of the legend key if needed
  )

transb_SWE_fullseason_lineplot
```

Combining Plots

```{r}
comb_fullseason_SWE <- ggarrange(persb_SWE_fullseason_lineplot, transb_SWE_fullseason_lineplot, nrow = 2, ncol = 1, common.legend = TRUE, legend = "bottom")

comb_fullseason_SWE
```

```{r}
ggsave("comb_fullseason_SWE.png", height = 5, width = 8, plot = comb_fullseason_SWE, dpi = 600)
```

### Stats

Daily Change in Volume between tree and open region

Differenced stats

```{r}
diff_stats_PSZ_SWE <- SWE_fullseason_vol_persb %>%
  filter(!is.na(SWE_sensor_kgm3), !is.na(SWE_tree_kgm3)) %>%
  mutate(SWE_perc_diff_m3 = ((SWE_sensor_kgm3-SWE_tree_kgm3)/SWE_sensor_kgm3)*100) %>%
  group_by(tree_id, season) %>%
  summarize(min_perc_diff = min(SWE_perc_diff_m3, na.rm = TRUE),
            max_perc_diff = max(SWE_perc_diff_m3, na.rm = TRUE), 
            median_perc_diff = median(SWE_perc_diff_m3, na.rm = TRUE), 
            mean_perc_diff = mean(SWE_perc_diff_m3, na.rm = TRUE))
```

```{r}
diff_stats_TSZ_SWE <- SWE_fullseason_vol_transb %>%
  filter(!is.na(SWE_sensor_kgm3), !is.na(SWE_tree_kgm3)) %>%
  mutate(SWE_perc_diff_m3 = ((SWE_sensor_kgm3-SWE_tree_kgm3)/SWE_sensor_kgm3)*100) %>%
  group_by(tree_id, season) %>%
  summarize(min_perc_diff = min(SWE_perc_diff_m3, na.rm = TRUE),
            max_perc_diff = max(SWE_perc_diff_m3, na.rm = TRUE), 
            median_perc_diff = median(SWE_perc_diff_m3, na.rm = TRUE), 
            mean_perc_diff = mean(SWE_perc_diff_m3, na.rm = TRUE))
```

#### MAD/MRD stats

```{r}
PSZ_SWE_MRD_MAD_stats <- SWE_fullseason_vol_persb %>%
  group_by(tree_id, season) %>%
  summarise(
    mean_avg_diff = mean(abs(SWE_sensor_kgm3 - SWE_tree_kgm3), na.rm = TRUE),
    mean_rel_diff = mean(abs(SWE_sensor_kgm3 - SWE_tree_kgm3) / ((SWE_sensor_kgm3 + SWE_tree_kgm3) / 2) * 100, na.rm = TRUE), 
    min_avg_diff = min(abs(SWE_sensor_kgm3 - SWE_tree_kgm3), na.rm = TRUE),
    min_rel_diff = min(abs(SWE_sensor_kgm3 - SWE_tree_kgm3) / ((SWE_sensor_kgm3 + SWE_tree_kgm3) / 2) * 100, na.rm = TRUE),
    max_avg_diff = max(abs(SWE_sensor_kgm3 - SWE_tree_kgm3), na.rm = TRUE),
    max_rel_diff = max(abs(SWE_sensor_kgm3 - SWE_tree_kgm3) / ((SWE_sensor_kgm3 + SWE_tree_kgm3) / 2) * 100, na.rm = TRUE)
  )
```

```{r}
TSZ_SWE_MRD_MAD_stats <- SWE_fullseason_vol_transb %>%
  group_by(tree_id, season) %>%
  summarise(
    mean_avg_diff = mean(abs(SWE_sensor_kgm3 - SWE_tree_kgm3), na.rm = TRUE),
    mean_rel_diff = mean(abs(SWE_sensor_kgm3 - SWE_tree_kgm3) / ((SWE_sensor_kgm3 + SWE_tree_kgm3) / 2) * 100, na.rm = TRUE), 
    min_avg_diff = min(abs(SWE_sensor_kgm3 - SWE_tree_kgm3), na.rm = TRUE),
    min_rel_diff = min(abs(SWE_sensor_kgm3 - SWE_tree_kgm3) / ((SWE_sensor_kgm3 + SWE_tree_kgm3) / 2) * 100, na.rm = TRUE),
    max_avg_diff = max(abs(SWE_sensor_kgm3 - SWE_tree_kgm3), na.rm = TRUE),
    max_rel_diff = max(abs(SWE_sensor_kgm3 - SWE_tree_kgm3) / ((SWE_sensor_kgm3 + SWE_tree_kgm3) / 2) * 100, na.rm = TRUE)
  )
```

#### Accu/Abla SWE Differences

\*\*Using these for thesis!

PSZ

```{r}
PSZ_tree1_MAD_SWE <- persb_SWE_tree1 %>%
  rename(snow_phase = "season") %>%
  group_by(snow_phase) %>%
  summarize(
    mean_SWE_tree = mean(SWE_tree_cm, na.rm = TRUE), 
    mean_SWE_sensor = mean(SWE_sensor_cm, na.rm = TRUE),
    percent_diff = ((mean_SWE_tree - mean_SWE_sensor) / mean_SWE_sensor) * 100
  )

PSZ_tree2_MAD_SWE <- persb_SWE_tree2 %>%
  rename(snow_phase = "season") %>%
  group_by(snow_phase) %>%
  summarize(
    mean_SWE_tree = mean(SWE_tree_cm, na.rm = TRUE), 
    mean_SWE_sensor = mean(SWE_sensor_cm, na.rm = TRUE),
    percent_diff = ((mean_SWE_tree - mean_SWE_sensor) / mean_SWE_sensor) * 100
  )

PSZ_tree3_MAD_SWE <- persb_SWE_tree3 %>%
  rename(snow_phase = "season") %>%
  group_by(snow_phase) %>%
  summarize(
    mean_SWE_tree = mean(SWE_tree_kgm3, na.rm = TRUE), 
    mean_SWE_sensor = mean(SWE_sensor_kgm3, na.rm = TRUE),
    percent_diff = ((mean_SWE_tree - mean_SWE_sensor) / mean_SWE_sensor) * 100
  )

PSZ_tree4_MAD_SWE <- persb_SWE_tree4 %>%
  rename(snow_phase = "season") %>%
  group_by(snow_phase) %>%
  summarize(
    mean_SWE_tree = mean(SWE_tree_kgm3, na.rm = TRUE), 
    mean_SWE_sensor = mean(SWE_sensor_kgm3, na.rm = TRUE),
    percent_diff = ((mean_SWE_tree - mean_SWE_sensor) / mean_SWE_sensor) * 100
  )
```

TSZ

```{r}

TSZ_tree1_MAD_SWE <- transb_SWE_tree1 %>%
  rename(snow_phase = "season") %>%
  group_by(snow_phase) %>%
  summarize(
    mean_SWE_tree = mean(SWE_tree_kgm3, na.rm = TRUE), 
    mean_SWE_sensor = mean(SWE_sensor_kgm3, na.rm = TRUE),
    percent_diff = ((mean_SWE_tree - mean_SWE_sensor) / mean_SWE_sensor) * 100
  )

TSZ_tree2_MAD_SWE <- transb_SWE_tree2 %>%
  rename(snow_phase = "season") %>%
  group_by(snow_phase) %>%
  summarize(
    mean_SWE_tree = mean(SWE_tree_kgm3, na.rm = TRUE), 
    mean_SWE_sensor = mean(SWE_sensor_kgm3, na.rm = TRUE),
    percent_diff = ((mean_SWE_tree - mean_SWE_sensor) / mean_SWE_sensor) * 100
  )

TSZ_tree3_MAD_SWE <- transb_SWE_tree3 %>%
  rename(snow_phase = "season") %>%
  group_by(snow_phase) %>%
  summarize(
    mean_SWE_tree = mean(SWE_tree_kgm3, na.rm = TRUE), 
    mean_SWE_sensor = mean(SWE_sensor_kgm3, na.rm = TRUE),
    percent_diff = ((mean_SWE_tree - mean_SWE_sensor) / mean_SWE_sensor) * 100
  )

TSZ_tree4_MAD_SWE <- transb_SWE_tree4 %>%
  rename(snow_phase = "season") %>%
  group_by(snow_phase) %>%
  summarize(
    mean_SWE_tree = mean(SWE_tree_kgm3, na.rm = TRUE), 
    mean_SWE_sensor = mean(SWE_sensor_kgm3, na.rm = TRUE),
    percent_diff = ((mean_SWE_tree - mean_SWE_sensor) / mean_SWE_sensor) * 100
  )
```

#### Melt Rate Comparison (SWE)

\*\* not using this because it does not make sensor to calculate melt rate from SWE.

PSZ

```{r}
PSZ_tree1_SWEmeltrate <- persb_SWE_tree1 %>%
  arrange(date) %>%  # Ensure data is sorted by date
  mutate(daily_SWE_change_tree = SWE_tree_kgm3 - lag(SWE_tree_kgm3), 
         daily_SWE_change_sensor = SWE_sensor_kgm3 - lag(SWE_sensor_kgm3)) %>%
  filter(!is.na(daily_SWE_change_tree) & !is.na(daily_SWE_change_sensor)) %>%
  group_by(season) %>%
  summarize(avg_SWEmelt_rate_tree = mean(daily_SWE_change_tree, na.rm = TRUE), 
            avg_SWEmelt_rate_sensor = mean(daily_SWE_change_sensor, na.rm = TRUE), percent_diff = ((avg_SWEmelt_rate_tree - avg_SWEmelt_rate_sensor) / avg_SWEmelt_rate_sensor) * 100
  )
```

## LW Radiation Cumulative Calculations

Not using in thesis, but what Dave asked to see

```{r}
#setting constants for conversion
sigma <- 5.670374419e-8  # Stefan-Boltzmann constant
emissivity <- 0.95 #estimated emissivity of burned tree
```

```{r}
persb_corr_data_accu <- persb_corr_data_accu %>%
  mutate(tree_diam_m = tree_diam/100) %>%
  mutate(
    mean_treetemp_K = mean_tree_temp + 273.15,
    mean_LW_Wm2 = emissivity * sigma *  mean_treetemp_K^4,
    mean_LW_MJm2_day = mean_LW_Wm2 * 0.0864
  ) %>%
  arrange(date) %>%  # ensure it's in chronological order
  mutate(
    cum_LW_MJm2 = cumsum(mean_LW_MJm2_day), 
    #normalizing LW value by tree size, by dividing by individual tree diam per day
    cum_LW_MJperm = cum_LW_MJm2 / tree_diam_m)

persb_corr_data_abla <- persb_corr_data_abla %>%
  mutate(tree_diam_m = tree_diam/100) %>%
  mutate(
    mean_treetemp_K = mean_tree_temp + 273.15,
    mean_LW_Wm2 = emissivity * sigma *  mean_treetemp_K^4,
    mean_LW_MJm2_day = mean_LW_Wm2 * 0.0864
  ) %>%
  arrange(date) %>%  # ensure it's in chronological order
  mutate(
    cum_LW_MJm2 = cumsum(mean_LW_MJm2_day), 
    #normalizing LW value by tree size, by dividing by individual tree diam per day
    cum_LW_MJperm = cum_LW_MJm2 / tree_diam_m)
```

```{r}
transb_corr_data_accu_V2 <- transb_corr_data_accu %>%
  mutate(tree_diam_m = tree_diam/100) %>%
  mutate(
    mean_treetemp_K = mean_tree_temp + 273.15,
    mean_LW_Wm2 = emissivity * sigma *  mean_treetemp_K^4,
    mean_LW_MJm2_day = mean_LW_Wm2 * 0.0864
  ) %>%
  arrange(date) %>%  # ensure it's in chronological order
  mutate(
    cum_LW_MJm2 = cumsum(mean_LW_MJm2_day), 
    #normalizing LW value by tree size, by dividing by individual tree diam per day
    cum_LW_MJperm = cum_LW_MJm2 / tree_diam_m)

transb_corr_data_abla <- transb_corr_data_abla %>%
  mutate(tree_diam_m = tree_diam/100) %>%
  mutate(
    mean_treetemp_K = mean_tree_temp + 273.15,
    mean_LW_Wm2 = emissivity * sigma *  mean_treetemp_K^4,
    mean_LW_MJm2_day = mean_LW_Wm2 * 0.0864
  ) %>%
  arrange(date) %>%  # ensure it's in chronological order
  mutate(
    cum_LW_MJm2 = cumsum(mean_LW_MJm2_day), 
    #normalizing LW value by tree size, by dividing by individual tree diam per day
    cum_LW_MJperm = cum_LW_MJm2 / tree_diam_m)
```

### Correlation Tests

#### PSZ

```{r}
# Compute R^2 for each tree_id
p_totalcumLWfromtree_r2_values_accu <- persb_corr_data_accu %>%
  drop_na(well_diam_m, cum_LW_MJperm) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, cum_LW_MJperm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
persb_totalcumLWfromtree_corr_plot_accu <- ggplot(persb_corr_data_accu, aes(x = cum_LW_MJperm, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "a) PSZ Accumulation",
    x = NULL,
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #scale_x_continuous(breaks = c(-100, 0, 100, 200), 
                    # labels = c("-100", "0", "100", "200")) +
 # scale_y_continuous(breaks = c(0.4, 0.8, 1.2, 1.6),
                    # labels = c("0.4", "0.8", "1.2", "1.6"))+
  #expand_limits(x = c(-100, 200), y = c(0.5, 2.0)) + 
  guides(color = "none") +
  scale_x_continuous(
    trans = "log10",
    labels = scales::math_format(10^.x)
  ) +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_totalcumLWfromtree_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

persb_totalcumLWfromtree_corr_plot_accu
```

```{r}
# Compute R^2 for each tree_id
p_totalcumLWfromtree_r2_values_abla<- persb_corr_data_abla %>%
  drop_na(well_diam_m, cum_LW_MJperm) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, cum_LW_MJperm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
persb_totalcumLWfromtree_corr_plot_abla <- ggplot(persb_corr_data_abla, aes(x = cum_LW_MJperm, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "a) PSZ Ablation",
    x = NULL,
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #scale_x_continuous(breaks = c(-100, 0, 100, 200), 
                    # labels = c("-100", "0", "100", "200")) +
 # scale_y_continuous(breaks = c(0.4, 0.8, 1.2, 1.6),
                    # labels = c("0.4", "0.8", "1.2", "1.6"))+
  #expand_limits(x = c(-100, 200), y = c(0.5, 2.0)) + 
  guides(color = "none") +
  scale_x_continuous(
    trans = "log10",
    labels = scales::math_format(10^.x)
  ) +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_totalcumLWfromtree_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

persb_totalcumLWfromtree_corr_plot_abla
```

#### TSZ

```{r}
t_totalcumLWfromtree_r2_values_accu <- transb_corr_data_accu %>%
  drop_na(well_diam_m, cum_LW_MJperm) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, cum_LW_MJperm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
transb_totalcumLWfromtree_corr_plot_accu <- ggplot(transb_corr_data_accu, aes(x = cum_LW_MJperm, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "b) TSZ Accumulation",
    x = "Cumulative Longwave Radiation (MJ/m)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #scale_x_continuous(breaks = c(-100, 0, 100, 200), 
                    # labels = c("-100", "0", "100", "200")) +
 # scale_y_continuous(breaks = c(0.4, 0.8, 1.2, 1.6),
                    # labels = c("0.4", "0.8", "1.2", "1.6"))+
  #expand_limits(x = c(-100, 200), y = c(0.5, 2.0)) + 
  guides(color = "none") +
  scale_x_continuous(
    trans = "log10",
    labels = scales::math_format(10^.x)
  ) +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_totalcumLWfromtree_r2_values_accu, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

transb_totalcumLWfromtree_corr_plot_accu
```

```{r}
t_totalcumLWfromtree_r2_values_abla <- transb_corr_data_abla %>%
  drop_na(well_diam_m, cum_LW_MJperm) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, cum_LW_MJperm, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
transb_totalcumLWfromtree_corr_plot_abla <- ggplot(transb_corr_data_abla, aes(x = cum_LW_MJperm, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "b) TSZ Ablation",
    x = "Cumulative Longwave Radiation (MJ/m)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #scale_x_continuous(breaks = c(-100, 0, 100, 200), 
                    # labels = c("-100", "0", "100", "200")) +
 # scale_y_continuous(breaks = c(0.4, 0.8, 1.2, 1.6),
                    # labels = c("0.4", "0.8", "1.2", "1.6"))+
  #expand_limits(x = c(-100, 200), y = c(0.5, 2.0)) + 
  guides(color = "none") +
  scale_x_continuous(
    trans = "log10",
    labels = scales::math_format(10^.x)
  ) +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_totalcumLWfromtree_r2_values_abla, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

transb_totalcumLWfromtree_corr_plot_abla
```

Saving Plots

```{r}
comb_cumtreeLWout_accu <- ggarrange(persb_totalcumLWfromtree_corr_plot_accu, transb_totalcumLWfromtree_corr_plot_accu, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "bottom")

comb_cumtreeLWout_accu
```

```{r}
ggsave("comb_cumtreeLWout_accu.png",
       #width = 7.5, 
       #height = 7, 
       plot = comb_cumtreeLWout_accu, dpi = 600)
```

```{r}
comb_cumtreeLWout_abla <- ggarrange(persb_totalcumLWfromtree_corr_plot_abla, transb_totalcumLWfromtree_corr_plot_abla, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "bottom")

comb_cumtreeLWout_abla
```

```{r}
ggsave("comb_cumtreeLWout_abla.png",
       #width = 7.5, 
       #height = 7, 
       plot = comb_cumtreeLWout_abla, dpi = 600)
```

Trying a version where I do NOT normalize by area - have higher correlations

```{r}
p_totalcumLWfromtree_r2_values_accu_V2 <- persb_corr_data_accu %>%
  drop_na(well_diam_m, cum_LW_MJm2) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, cum_LW_MJm2, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
persb_totalcumLWfromtree_corr_plot_accu_V2 <- ggplot(persb_corr_data_accu, aes(x = cum_LW_MJm2, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "a) PSZ Accumulation",
    x = NULL,
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #scale_x_continuous(breaks = c(-100, 0, 100, 200), 
                    # labels = c("-100", "0", "100", "200")) +
 # scale_y_continuous(breaks = c(0.4, 0.8, 1.2, 1.6),
                    # labels = c("0.4", "0.8", "1.2", "1.6"))+
  #expand_limits(x = c(-100, 200), y = c(0.5, 2.0)) + 
  guides(color = "none") +
  scale_x_continuous(
    trans = "log10",
    labels = scales::math_format(10^.x)
  ) +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_totalcumLWfromtree_r2_values_accu_V2, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

persb_totalcumLWfromtree_corr_plot_accu_V2
```

```{r}
p_totalcumLWfromtree_r2_values_abla_V2 <- persb_corr_data_abla %>%
  drop_na(well_diam_m, cum_LW_MJm2) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, cum_LW_MJm2, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
persb_totalcumLWfromtree_corr_plot_abla_V2 <- ggplot(persb_corr_data_abla, aes(x = cum_LW_MJm2, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "a) PSZ Ablation",
    x = NULL,
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #scale_x_continuous(breaks = c(-100, 0, 100, 200), 
                    # labels = c("-100", "0", "100", "200")) +
 # scale_y_continuous(breaks = c(0.4, 0.8, 1.2, 1.6),
                    # labels = c("0.4", "0.8", "1.2", "1.6"))+
  #expand_limits(x = c(-100, 200), y = c(0.5, 2.0)) + 
  guides(color = "none") +
  scale_x_continuous(
    trans = "log10",
    labels = scales::math_format(10^.x)
  ) +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = p_totalcumLWfromtree_r2_values_abla_V2, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

persb_totalcumLWfromtree_corr_plot_abla_V2
```

```{r}
t_totalcumLWfromtree_r2_values_accu_V2 <- transb_corr_data_accu %>%
  drop_na(well_diam_m, cum_LW_MJm2) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, cum_LW_MJm2, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
transb_totalcumLWfromtree_corr_plot_accu_V2 <- ggplot(transb_corr_data_accu, aes(x = cum_LW_MJm2, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "b) TSZ Accumulation",
    x = "Cumulative Longwave Radiation (MJ/m²)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #scale_x_continuous(breaks = c(-100, 0, 100, 200), 
                    # labels = c("-100", "0", "100", "200")) +
 # scale_y_continuous(breaks = c(0.4, 0.8, 1.2, 1.6),
                    # labels = c("0.4", "0.8", "1.2", "1.6"))+
  #expand_limits(x = c(-100, 200), y = c(0.5, 2.0)) + 
  guides(color = "none") +
  scale_x_continuous(
    trans = "log10",
    labels = scales::math_format(10^.x)
  ) +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_totalcumLWfromtree_r2_values_accu_V2, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

transb_totalcumLWfromtree_corr_plot_accu_V2
```

```{r}
t_totalcumLWfromtree_r2_values_abla_V2 <- transb_corr_data_abla %>%
  drop_na(well_diam_m, cum_LW_MJm2) %>%
  group_by(tree_id) %>%
  summarize(
    cor_test = list(cor.test(well_diam_m, cum_LW_MJm2, use = "complete.obs")),
    .groups = "drop"
  ) %>%
   mutate(
    R2 = map_dbl(cor_test, ~ .x$estimate^2),  # Extract R²
    p_value = map_dbl(cor_test, ~ .x$p.value),  # Extract p-value
    conf_low = map_dbl(cor_test, ~ .x$conf.int[1]),  # Lower bound of CI
    conf_high = map_dbl(cor_test, ~ .x$conf.int[2]),  # Upper bound of CI
    p_label = ifelse(p_value < 0.05, "p-value < 0.05", "p-value ≥ 0.05"),  # Conditional p-value label
    R2_label = paste0("R² = ", formatC(R2, format = "f", digits = 2), "\n", p_label)  # Ensure two decimal places
  )

# Scatterplot
transb_totalcumLWfromtree_corr_plot_abla_V2 <- ggplot(transb_corr_data_abla, aes(x = cum_LW_MJm2, y = well_diam_m, color = factor(tree_id))) +
  geom_point(aes(shape = burn_status), size = 2, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "grey", se = TRUE) +
  facet_wrap(~ tree_id, nrow = 1) +  # Separate by tree_id
  labs(
    title = "b) TSZ Ablation",
    x = "Cumulative Longwave Radiation (MJ/m²)",
    y = "Well Diameter (m)",
    color = "Tree ID"
  ) +
  theme_bw() +
  scale_color_manual(values = treeid_colors) + 
  #scale_x_continuous(breaks = c(-100, 0, 100, 200), 
                    # labels = c("-100", "0", "100", "200")) +
 # scale_y_continuous(breaks = c(0.4, 0.8, 1.2, 1.6),
                    # labels = c("0.4", "0.8", "1.2", "1.6"))+
  #expand_limits(x = c(-100, 200), y = c(0.5, 2.0)) + 
  guides(color = "none") +
  scale_x_continuous(
    trans = "log10",
    labels = scales::math_format(10^.x)
  ) +
  scale_shape_manual(name = NULL, values = c("GB" = 16, "DB" = 15)) +
  geom_text(data = t_totalcumLWfromtree_r2_values_abla_V2, aes(x = Inf, y = Inf, label = R2_label), 
            hjust = 1.1, vjust = 1.3, inherit.aes = FALSE, size = 4) + 
  theme(
    strip.text = element_text(size = 11),  # Facet title size
    axis.title = element_text(size = 11),  # Axis title size
    axis.text = element_text(size = 11),  # Axis tick labels
    legend.title = element_text(size = 11),  # Legend title size
    legend.text = element_text(size = 10)  # Legend labels size
  )

transb_totalcumLWfromtree_corr_plot_abla_V2
```

```{r}
comb_cumtreeLWout_accu_V2 <- ggarrange(persb_totalcumLWfromtree_corr_plot_accu_V2, transb_totalcumLWfromtree_corr_plot_accu_V2, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "bottom")

comb_cumtreeLWout_accu_V2
```

```{r}
ggsave("comb_cumtreeLWout_accu_V2.png",
       #width = 7.5, 
       #height = 7, 
       plot = comb_cumtreeLWout_accu_V2, dpi = 600)
```

```{r}
comb_cumtreeLWout_abla_V2 <- ggarrange(persb_totalcumLWfromtree_corr_plot_abla_V2, transb_totalcumLWfromtree_corr_plot_abla_V2, nrow = 2, ncol = 1, align = "hv", common.legend = TRUE, legend = "bottom")

comb_cumtreeLWout_abla_V2
```

```{r}
ggsave("comb_cumtreeLWout_abla_V2.png",
       #width = 7.5, 
       #height = 7, 
       plot = comb_cumtreeLWout_abla_V2, dpi = 600)
```
